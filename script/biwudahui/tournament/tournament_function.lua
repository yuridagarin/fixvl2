Include("\\settings\\static_script\\exchg_server\\exchange_server_func.lua")
Include("\\script\\lib\\sdb.lua")
Include("\\script\\biwudahui\\tournament\\tournament_head.lua");
--Include("\\script\\online\\spring_festival09\\spring_festival_head.lua"); --09¥∫Ω⁄ªÓ∂Ø
Include("\\script\\equip_shop\\equip_shop_head.lua");
Include("\\script\\misc\\observer\\observer_head.lua");
--Include("\\script\\misc\\soul\\soul.lua")
Include("\\script\\task_access_code_def.lua")
Include("\\settings\\static_script\\global\\merit.lua")
Include("\\script\\lib\\define.lua")

g_ThisFile = "\\script\\biwudahui\\tournament\\tournament_function.lua";

--–Ë“™–¥»Î ˝æ›ø‚µƒ±‰¡ø
tRelayTask = {
	TSK_CURREALRESULT,
	TSK_TOTAL_POINT,
	TSK_CURSIGNEDRESULT,
	TSK_CURWEEKMATCH,
	TSK_TOTALMATCH,
	TASK_BIWU_WIN_10,
	TSK_TOTALWIN,
	TSK_CURWEEKWIN,
	TASK_BIWU_DUIZHAN_JINGYAN,
	TASK_BIWU_LOSE_10,
	TSK_TOTALLOSE,
	TSK_CURWEEKLOSE,
	TSK_BODY_WEEK,
	TASKID_WLZB_POINT,
--	TASKID_ACH_BIWU_WIN_TOTAL,
--	TASKID_ACH_USE_NEW_ROUTE,
--	TASKID_ACH_WIN_NEW_ROUTE,
};

--π∆ ¶µƒ±‰¡ø
tGushiTask = {
	2204,2216,2207,2222,2219,2210,2228,2213,2225,2231
};

function BWDH_SetTask(nTaskId, nTaskVal)
	return SetTask(nTaskId, nTaskVal,TASK_ACCESS_CODE_BIWUDAHUI)
end

--…Ë÷√±»Œ‰µƒ¡ΩŒªÕÊº“µƒ’Ω∂∑◊¥Ã¨
function BWT_SetFightState(nState)
	local tbPlayer = {GetMissionV(MV_PLAYERINDEX1),GetMissionV(MV_PLAYERINDEX2)};
	local nOldPlayerIdx = PlayerIndex;
	for i=1,getn(tbPlayer) do
		PlayerIndex = tbPlayer[i];
		if PlayerIndex ~= 0 then
			SetFightState(nState);
		end;
	end;
	PlayerIndex = nOldPlayerIdx;
end;
--œÚ¡ΩŒªÕÊº“TalkªÚ’ﬂSay
function BWT_Talk(szTalk,bTalkSay)
	bTalkSay = bTalkSay or 0;
	local tbPlayer = {GetMissionV(MV_PLAYERINDEX1),GetMissionV(MV_PLAYERINDEX2)};
	local nOldPlayerIdx = PlayerIndex;
	for i=1,getn(tbPlayer) do
		PlayerIndex = tbPlayer[i];
		if PlayerIndex ~= 0 then
			if bTalkSay == 0 then
				Talk(1,"",szTalk);
			else
				Say(szTalk,0);
			end;
		end;
	end;
	PlayerIndex = nOldPlayerIdx;
end;
--◊™ªªMissionµ±«∞◊¥Ã¨
function BWT_ChangeMSState(nState)
	if nState == MS_STATE_IDEL then
		BWT_SetFightState(0);
		StopMissionTimer(MISSION_ID,TIMER_ID);	--Ω· ¯«∞“ª∏ˆº∆ ±∆˜
		SetMissionV(MV_MISSION_STATE,MS_STATE_IDEL);
	elseif nState == MS_STATE_CHECK_EQUIPMENT then
		BWT_SetFightState(0);
		SetMissionV(MV_MISSION_STATE,MS_STATE_CHECK_EQUIPMENT);	--…Ë÷√Missionµƒ◊¥Ã¨Œ™◊º±∏◊¥Ã¨
		SetMissionV(MV_TIMER_LOOP,CHECK_EQUIPMENT_TIMER_COUNT);	--…Ë÷√º∆ ±∆˜◊‹º∆ ±¥Œ ˝
		StopMissionTimer(MISSION_ID,TIMER_ID);	--Ω· ¯«∞“ª∏ˆº∆ ±∆˜
		StartMissionTimer(MISSION_ID,TIMER_ID,CHECK_EQUIPMENT_TIMER_INTERVAL*FRAME_PER_MIN);	--ø™ º“ª∏ˆº∆ ±∆˜
	elseif nState == MS_STATE_READY then
		BWT_SetFightState(1);
		SetMissionV(MV_MISSION_STATE,MS_STATE_READY);	--…Ë÷√Missionµƒ◊¥Ã¨Œ™◊º±∏◊¥Ã¨
		SetMissionV(MV_TIMER_LOOP,READY_TIMER_COUNT);	--…Ë÷√º∆ ±∆˜◊‹º∆ ±¥Œ ˝
		StopMissionTimer(MISSION_ID,TIMER_ID);	--Ω· ¯«∞“ª∏ˆº∆ ±∆˜
		StartMissionTimer(MISSION_ID,TIMER_ID,READY_TIMER_INTERVAL*FRAME_PER_MIN);	--ø™ º“ª∏ˆº∆ ±∆˜
	elseif nState == MS_STATE_STARTED then
		BWT_SetFightState(1);
		SetMissionV(MV_MISSION_STATE,MS_STATE_STARTED);	--…Ë÷√Missionµƒ◊¥Ã¨Œ™ø™ º◊¥Ã¨
		SetMissionV(MV_TIMER_LOOP,STARTED_TIMER_COUNT);	--…Ë÷√ø™ º◊¥Ã¨µƒ≥÷–¯ ±º‰
		StopMissionTimer(MISSION_ID,TIMER_ID);	--Ω· ¯«∞“ª∏ˆº∆ ±∆˜
		StartMissionTimer(MISSION_ID,TIMER_ID,STARTED_TIMER_INTERVAL*FRAME_PER_MIN);	--ø™ º“ª∏ˆ–¬µƒº∆ ±∆˜
	elseif nState == MS_STATE_ENDING then
		BWT_SetFightState(0);
		SetMissionV(MV_MISSION_STATE,MS_STATE_ENDING);
		SetMissionV(MV_TIMER_LOOP,ENDING_TIMER_COUNT);
		StopMissionTimer(MISSION_ID,TIMER_ID);
		StartMissionTimer(MISSION_ID,TIMER_ID,ENDING_TIMER_INTERVAL*FRAME_PER_MIN);
	end;
end;
--ªÒ»°∂‘ ÷µƒÀ˜“˝°£÷ªƒ‹‘⁄¿ﬁÃ®≥°µÿ¿Ô√Ê”…ÕÊº“¥•∑¢ π”√
function BWT_GetOpponentIndex()
	local nMapID = SubWorldIdx2ID(SubWorld);
	local nIdx1,nIdx2 = GetMissionV(MV_PLAYERINDEX1),GetMissionV(MV_PLAYERINDEX2);
	if PlayerIndex == nIdx1 then
		return nIdx2;
	elseif PlayerIndex == nIdx2 then
		return nIdx1;
	else
		gf_ShowDebugInfor("PlayerIndex trong hµm sË BWT_GetOpponentIndex bﬁ lÁi");
	end;
end;
--«Â≥˝¡Ÿ ±»ŒŒÒ±‰¡ø
function BWT_ClearTempTask()
	for i=TSK_TEMP_BEGIN,TSK_TEMP_END do
		SetTaskTemp(i,0);
	end;
end;
--º∆À„±æ¥ŒΩœ“’ªÒ §ªÒµ√µƒª˝∑÷£¨”…ªÒ §∑Ωµ˜”√
function BWT_CalculateWinPoint()
	local nOldPlayerIdx = PlayerIndex;
	local nRetPoint = 0;
	local nLevel = GetLevel();
	local nPoint = GetTask(TSK_CURREALRESULT);
	local nOppIdx = BWT_GetOpponentIndex();
	PlayerIndex = nOppIdx;
	local nOppLevel = GetLevel();
	local nOppPoint = GetTask(TSK_CURREALRESULT);
	PlayerIndex = nOldPlayerIdx;
	local nLevelDiff = nLevel - nOppLevel;	--µ»º∂≤Ó£∫ §∑Ωºı∏∫∑Ω
	local nPointDiff = nPoint - nOppPoint;
	nRetPoint = 15;
	if nPointDiff >= -100 then
		for i=1,getn(TB_POINTDIFF_RELATION) do
			if nPointDiff >= TB_POINTDIFF_RELATION[i][1] then
				nRetPoint = TB_POINTDIFF_RELATION[i][2];
				break;
			end;
		end;
	end;
	if nLevelDiff > 0 then
		for i=1,getn(TB_LEVELDIFF_RELATION) do
			if nLevelDiff >= TB_LEVELDIFF_RELATION[i][1] then
				nRetPoint = floor(nRetPoint*TB_LEVELDIFF_RELATION[i][2]/100);
				break;
			end;
		end;
	end;
	if nRetPoint >= 15 then
		WriteLog("["..LOG_ERROR_HEAD.."]:"..tostring(GetName())..", "..tostring(GetName(nOppIdx)).."nPointDiff:"..nPointDiff..",nLevelDiff:"..nLevelDiff..",error point:"..nRetPoint);
		nRetPoint = 15;
	end;
	if nRetPoint <= 0 then
		nRetPoint = 1;
	end;
	return nRetPoint;
end;
-- ±º‰µΩ ±∑÷Œˆ¡ΩŒªÕÊº“µƒ◊¥Ã¨£¨æˆ∂®◊Ó÷’ §∏∫πÿœµ
function BWT_GetDrawState(nPIdx1,nPIdx2)
	local tbDamageInfo1,tbDamageInfo2 = BWT_GetDamageValue(nPIdx1,nPIdx2);
	local nResult1,nResult2 = 0,0;
	nResult1 = tbDamageInfo1[1];	--∂‘ÕÊº“1µƒ…À∫¶∞Ÿ∑÷±»
	nResult2 = tbDamageInfo2[1];	--∂‘ÕÊº“2µƒ…À∫¶∞Ÿ∑÷±»
	if nResult1 > nResult2 then	--÷µ¥ÛµƒŒ™∏∫∑Ω
		nState = 2;	--±Ì æ2∫≈ÕÊº“”Æ
	elseif nResult1 < nResult2 then
		nState = 1;	--±Ì æ1∫≈ÕÊº“”Æ
	else
		nState = 0;	--¥Ú∆Ω¡À
	end;
	return nState;
end;
-- ‰»ÎÕÊº“1∫ÕÕÊº“2£¨ªÒ»°À˚√«∏˜◊‘ ‹µΩµƒ…À∫¶–≈œ¢
function BWT_GetDamageValue(nPIdx1,nPIdx2)
	local nOldPIdx = PlayerIndex;
	local nDamageToP1,nDamageToP2 = 0,0;
	local nMaxLife1,nMaxLife2 = 0,0;
	local nState = 0;
	PlayerIndex = nPIdx1;
	nDamageToP2 = GetToPlayerDamage();
	nMaxLife1 = GetMaxLife();
	PlayerIndex = nPIdx2;
	nDamageToP1 = GetToPlayerDamage();
	nMaxLife2 = GetMaxLife();
	local nResult1,nResult2 = 0,0;
	nResult1 = tonumber(format("%.3f",nDamageToP1/nMaxLife1*100));	--∂‘ÕÊº“1µƒ…À∫¶÷µ
	nResult2 = tonumber(format("%.3f",nDamageToP2/nMaxLife2*100));	--∂‘ÕÊº“2µƒ…À∫¶÷µ
	PlayerIndex = nOldPIdx;
	return {nResult1,nDamageToP1,nMaxLife1},{nResult2,nDamageToP2,nMaxLife2};
end;

--¥¶¿ÌΩœ“’Ω·π˚°£nResultType1 ±±Ì æ¥Ú∆Ω ÷,∑«1Œ™æˆ≥ˆ §∏∫°£ƒ¨»œ÷µŒ™0
function BWT_ReportResult(nWinnerIdx,nLoserIdx,nResultType)
	local nVersion,nCurGs = GetRealmType();
	if nCurGs == 0 and GLB_BW_BiWuCheck() == 1 then --ø™∆Ù¡À»´«¯»´∑˛±»Œ‰∫Û‘⁄‘≠∑˛≤ª‘ŸªÒµ√Ω±¿¯
		local oldPlayerIndex = PlayerIndex
		PlayerIndex = nWinnerIdx;
		Say("K˙ thi vﬂng loπi ßπi HÈi T˚ V‚ thi™n hπ Æ÷ nh t toµn quËc Æ∑ ch›nh th¯c bæt Æ«u vµo tu«n nµy, c∏c vﬁ Æπi hi÷p b©y giÍ Æ∑ c„ th” cÔng so tµi vÌi c∏c cao thÒ khæp n¨i rÂi! Chi ti’t c„ th” Æ’n Æπi s¯ ßπi HÈi T˚ V‚ h·i xem, t˚ v‚ server sœ kh´ng nhÀn Æ≠Óc th™m ph«n th≠Îng vµ t›ch Æi”m.",0);
		PlayerIndex = nLoserIdx;
		Say("K˙ thi vﬂng loπi ßπi HÈi T˚ V‚ thi™n hπ Æ÷ nh t toµn quËc Æ∑ ch›nh th¯c bæt Æ«u vµo tu«n nµy, c∏c vﬁ Æπi hi÷p b©y giÍ Æ∑ c„ th” cÔng so tµi vÌi c∏c cao thÒ khæp n¨i rÂi! Chi ti’t c„ th” Æ’n Æπi s¯ ßπi HÈi T˚ V‚ h·i xem, t˚ v‚ server sœ kh´ng nhÀn Æ≠Óc th™m ph«n th≠Îng vµ t›ch Æi”m.",0);
		PlayerIndex = oldPlayerIndex;
		return 0;
	end
	nResultType = nResultType or 0;
	local tbDamageInfo1,tbDamageInfo2 = BWT_GetDamageValue(nWinnerIdx,nLoserIdx);
	Msg2MSAll(MISSION_ID,"Th´ng tin s∏t th≠¨ng: ");
	Msg2MSAll(MISSION_ID,"Ng≠Íi ch¨i "..BWT_GetName(nWinnerIdx).."  g©y ra:"..tbDamageInfo2[2]..",% s∏t th≠¨ng:"..tbDamageInfo2[1].."%");
	Msg2MSAll(MISSION_ID,"Ng≠Íi ch¨i "..BWT_GetName(nLoserIdx).."  g©y ra:"..tbDamageInfo1[2]..",% s∏t th≠¨ng:"..tbDamageInfo1[1].."%");
	local nOldPIdx = PlayerIndex
	if nResultType == 1 then	--¥Ú∆Ω¡À
		PlayerIndex = nWinnerIdx;
		Say("Hai b™n hﬂa, trı <color=yellow>1<color> Æi”m so tµi.",0);
		Msg2Player("Bπn bﬁ trı 1 Æi”m so tµi");
		BWT_AddPoint(-1);
		merit_1V1(-1);
		PlayerIndex = nLoserIdx;
		Say("Hai b™n hﬂa, trı <color=yellow>1<color> Æi”m so tµi.",0);
		Msg2Player("Bπn bﬁ trı 1 Æi”m so tµi");
		BWT_AddPoint(-1);
		merit_1V1(-1);
		_Write1V1PointLog(nWinnerIdx,nLoserIdx,-1,-1)
		PlayerIndex = nOldPIdx;
		Msg2MSAll(MISSION_ID,BWT_GetName(nWinnerIdx).."cÔng vÌi "..BWT_GetName(nLoserIdx).." k’t qu∂ hﬂa nhau");
	else
		--º∆À„π¶—´∫Õµ»º∂
		PlayerIndex = nWinnerIdx;
		local nWinMerit = _merit_GetMerit();
		local nWinLevel = GetLevel() + gf_GetPlayerRebornCount() * 10;
		PlayerIndex = nLoserIdx;
		local nLostMerit = _merit_GetMerit();
		local nLostLevel = GetLevel() + gf_GetPlayerRebornCount() * 10;
		
		--∏¯Ω±¿¯
		PlayerIndex = nWinnerIdx;
		local nWinRoute = GetPlayerRoute() -- §∑Ω¡˜≈…
		local nPoint = BWT_CalculateWinPoint();	--”…ªÒ §∑Ωµ˜”√
		BWT_AddPoint(nPoint);
		merit_1V1(1, nWinMerit - nLostMerit, nWinLevel - nLostLevel, 0); --π¶—´∫ÕΩ£œ¿
		SetMissionV(MV_BIWU_RESULT,nWinnerIdx);
		Say("Bπn Æ∑ chi’n thæng <color=yellow>"..BWT_GetName(nLoserIdx).."<color>, nhÀn Æ≠Óc <color=yellow>"..nPoint.."<color> Æi”m so tµi, Æi”m so tµi tu«n nµy lµ "..GetTask(TSK_CURREALRESULT)..".",0);
		Msg2Player("Bπn nhÀn Æ≠Óc "..nPoint.." Æi”m so tµi");
		PlayerIndex = nLoserIdx;
		local nLoseRoute = GetPlayerRoute()--∏∫∑Ω¡˜≈…
		BWT_AddPoint(-nPoint);
		merit_1V1(0, nLostMerit - nWinMerit, nLostLevel - nWinLevel, 0); --π¶—´∫ÕΩ£œ¿
		Say("Bπn Æ∑ thua <color=yellow>"..BWT_GetName(nWinnerIdx).."<color>, bﬁ gi∂m <color=yellow>"..nPoint.."<color> Æi”m so tµi, Æi”m so tµi tu«n nµy lµ "..GetTask(TSK_CURREALRESULT)..".",0);
		Msg2Player("Bπn Æ∑ bﬁ gi∂m "..nPoint.." Æi”m so tµi");
		PlayerIndex = nOldPIdx;
		Msg2MSAll(MISSION_ID,BWT_GetName(nWinnerIdx).."Chi’n thæng rÂi "..BWT_GetName(nLoserIdx)..", giµnh Æ≠Óc thæng lÓi.");
		
		--PK §¿˚Õ≥º∆
		local nPKStatWinKey = nWinRoute*100+nLoseRoute
		local nPKStatLoseKey = nLoseRoute * 100 + nWinRoute
		AddRuntimeStat(15,1,nPKStatWinKey,1)
		AddRuntimeStat(15,2,nPKStatWinKey,1)
		AddRuntimeStat(15,2,nPKStatLoseKey,1)
		
		_Write1V1PointLog(nWinnerIdx,nLoserIdx,nPoint,-1*nPoint)
	end;
	BWT_AddBiWuRecord(nWinnerIdx,nLoserIdx,nResultType);	--–Ë‘⁄∏¯”Ëª˝∑÷∫Ûµ˜”√

--	if get_spring_festival_state09() == 1 then
--		PlayerIndex = nWinnerIdx;
--		local nDate = tonumber(date("%Y%m%d"));
--		if GetTask(TASK_BIWU_JINNIU_DATE) < nDate then
--			BWDH_SetTask(TASK_BIWU_JINNIU_DATE,nDate);
--			BWDH_SetTask(TASK_BIWU_JINNIU_NUM,0);
--			BWDH_SetTask(TASK_BIWU_JINNIU_CHANG,0);
--		end
--		BWDH_SetTask(TASK_BIWU_JINNIU_CHANG,GetTask(TASK_BIWU_JINNIU_CHANG)+1);
--		if GetTask(TASK_BIWU_JINNIU_CHANG) >= 10 and GetTask(TASK_BIWU_JINNIU_NUM) == 0 then
--			AddItem(tSFItem[1][2],tSFItem[1][3],tSFItem[1][4],GET_BIWU_JINNIU_NUM);
--			Msg2Player("ƒ„ΩÒÃÏΩ¯––¡À10≥°±»Œ‰£¨ªÒµ√"..GET_BIWU_JINNIU_NUM.."∏ˆ"..tSFItem[1][1].."°£");
--			BWDH_SetTask(TASK_BIWU_JINNIU_NUM,1);
--		end
--		PlayerIndex = nLoserIdx;
--		local nDate = tonumber(date("%Y%m%d"));
--		if GetTask(TASK_BIWU_JINNIU_DATE) < nDate then
--			BWDH_SetTask(TASK_BIWU_JINNIU_DATE,nDate);
--			BWDH_SetTask(TASK_BIWU_JINNIU_NUM,0);
--			BWDH_SetTask(TASK_BIWU_JINNIU_CHANG,0);
--		end
--		BWDH_SetTask(TASK_BIWU_JINNIU_CHANG,GetTask(TASK_BIWU_JINNIU_CHANG)+1);
--		if GetTask(TASK_BIWU_JINNIU_CHANG) >= 10 and GetTask(TASK_BIWU_JINNIU_NUM) == 0 then
--			AddItem(tSFItem[1][2],tSFItem[1][3],tSFItem[1][4],GET_BIWU_JINNIU_NUM);
--			Msg2Player("ƒ„ΩÒÃÏΩ¯––¡À10≥°±»Œ‰£¨ªÒµ√"..GET_BIWU_JINNIU_NUM.."∏ˆ"..tSFItem[1][1].."°£");
--			BWDH_SetTask(TASK_BIWU_JINNIU_NUM,1);
--		end
--		PlayerIndex = nOldPIdx;
--	end
end;

function _Write1V1PointLog(nWinnerIdx,nLoserIdx, nWinnerPnt,nLoserPnt)
	local strAction = "1v1_match"
	local strDate = date("%Y_%m_%d")

	local hFile = openfile(format("logs/gest_convention/%s/%s.log", strDate, strAction), "a+");
	if (hFile == nil) then
		execute(format("mkdir \"%s\"", "logs/gest_convention/"));
		execute(format("mkdir \"%s\"", format("logs/gest_convention/%s/", strDate)));
		hFile = openfile(format("logs/gest_convention/%s/%s.log", strDate, strAction), "a+");
		write (hFile, "Account\tRole\tPoint\tTotalPoint\tCurZiGePoint\tDate\n")
	end
	if (hFile ~= nil) then
		local OldPlayerIndex = PlayerIndex
		PlayerIndex = nWinnerIdx
		local szMsg = format("%s\t%s\t%d\t%d\t%d\t%s\n"
			, GetAccount(), GetName(), nWinnerPnt, GetTask(TSK_CURREALRESULT), GetTask(TSK_CURLADDERVALUE), strDate)
		write (hFile, szMsg)
		PlayerIndex = nLoserIdx
		szMsg = format("%s\t%s\t%d\t%d\t%d\t%s\n"
			, GetAccount(), GetName(), nLoserPnt, GetTask(TSK_CURREALRESULT), GetTask(TSK_CURLADDERVALUE), strDate)
		write (hFile, szMsg)
		PlayerIndex = OldPlayerIndex
		closefile (hFile)
	end
end

--ªÒµ√±»Œ‰À´∑Ωµƒ√˚◊÷
function BWT_GetFighterName(nMapID)
	nMapID = nMapID or SubWorldIdx2ID(SubWorld);
	return mf_GetMissionS(MISSION_ID,MS_PLAYERNAME1,nMapID),
		   mf_GetMissionS(MISSION_ID,MS_PLAYERNAME2,nMapID);
end;
--ªÒ»°µ±«∞∑˛ŒÒ∆˜…œø…”√µƒ≥°µÿ ˝¡ø
function BWT_GetServerIdleRoomNum()
	local nCount = 0;
	local nTotalCount = 0;
	for i,v in TB_MAPID do
		if SubWorldID2Idx(i) >= 0 then
			nCount = nCount + GetMapLoadCount(v[2]);
			nTotalCount = nTotalCount + MAX_ROOM_NUM;
		end;
	end;
	return nTotalCount - nCount;
end;
--≥ı ºªØ“ª¬÷±»Œ‰,GMScript÷–÷¥––
--ªÒ»°ƒ≥∑˛ŒÒ∆˜ø…”√≥°µÿ ˝¡ø£¨»ª∫Û—°≥ˆ∫œ   ˝¡øµƒ≈‰∂‘ÕÊº“£¨ø™∆Ù≥°µÿ£¨∞—ÕÊº“¥´Ω¯»•
function BWT_InitOneRound()
	do
		return BWT_InitOneRoundEx();	--”√◊Ó–¬µƒ≈‰∂‘πÊ‘Ú
	end;
	local nCount = BWT_GetServerIdleRoomNum();
	local tbPlayer = {};
	local nRetCode,nPIdx1,nPIdx2 = 0,0,0;
	local nPairCount = 0;
	for i=1,nCount do
		nRetCode,nPIdx1,nPIdx2 = BWT_SentInviteToPlayer();
		if nRetCode == -1 then	--»Áπ˚√ªÕ®π˝ºÏ≤È
			tinsert(tbPlayer,nPIdx1);	--º”µΩtable¿Ô√Ê
			tinsert(tbPlayer,nPIdx2);
		elseif nRetCode == 1 then
			nPairCount = nPairCount + 1;
		end;
	end;
	local nOldPIdx = PlayerIndex;
	--BWT_SentInviteToPlayerª·∞—ÕÊº“¥”¡–±Ì÷–“∆≥˝£¨À˘“‘œ¬√Êµƒ¥˙¬Î «“™∞—ÕÊº“º”ªÿ»•µƒ
	for i=1,getn(tbPlayer) do	--∞—ÕÊº“º”ªÿ¡–±Ì
		PlayerIndex = tbPlayer[i];
		if GetTask(TSK_CHECK_FAIL) == 0 then	--»Áπ˚ºÏ≤ÈÕ®π˝¡ÀæÕº”ªÿ¡–±Ì
			BWT_JoinGestConvention();
		end;
	end;
	PlayerIndex = nOldPIdx;
	return nPairCount;
end;
--¡Ì“ª∏ˆ≥ı ºªØ±»Œ‰µƒ∫Ø ˝
--∏˘æ›“ª∂®µƒπÊ‘Ú—°≥ˆn£®floor(¡–±Ì÷–µƒÕÊº“ ˝¡ø/2)£©∂‘ÕÊº“
function BWT_InitOneRoundEx()
	-- œ»ºÏ≤È∂”¡– »°≥ˆ≤ª∑˚∫œµƒ»À
	BWT_CheckAllPlayerState();
	--
	local tbPlayer = {};
	local nRetCode,nPIdx1,nPIdx2 = 0,0,0;
	local nPairCount = 0;
	local nPair = floor(GetGestQueueSize()/2);	--»°µ√≈‰∂‘µƒ∂‘ ˝
	local nPIdx1,nPIdx2 = 0,0;
	for i=1,nPair do
		nRetCode,nPIdx1,nPIdx2 = BWT_GetPairGestPlayer(i);	--¥À∫Ø ˝ª·»√ÕÊº“ÕÀ≥ˆ¡–±Ì
		if nRetCode == 0 then
			tinsert(tbPlayer,nPIdx1);
		else
			nRetCode = BWT_SentInviteToPlayer(nPIdx1, nPIdx2);	--∏√∫Ø ˝“≤ª·»√—°÷–µƒÕÊº“‘› ±ÕÀ≥ˆ¡–±Ì
			if nRetCode == 0 then
				break
			elseif nRetCode == -1 then	--»Áπ˚√ªÕ®π˝ºÏ≤È
				tinsert(tbPlayer,nPIdx1);
				tinsert(tbPlayer,nPIdx2);
			elseif nRetCode == 1 then
				nPairCount = nPairCount + 1;
				BWT_CostOneRount(nPIdx1, nPIdx2);
			end
		end
	end

	local nOldPIdx = PlayerIndex;
	--BWT_SentInviteToPlayerª·∞—ÕÊº“¥”¡–±Ì÷–“∆≥˝£¨À˘“‘œ¬√Êµƒ¥˙¬Î «“™∞—ÕÊº“º”ªÿ»•µƒ
	for i = 1, getn(tbPlayer) do	--∞—ÕÊº“º”ªÿ¡–±Ì
		PlayerIndex = tbPlayer[i];
		if GetTask(TSK_CHECK_FAIL) == 0 then	--»Áπ˚ºÏ≤ÈÕ®π˝¡ÀæÕº”ªÿ¡–±Ì
			BWT_JoinGestConvention();
		end
	end
	PlayerIndex = nOldPIdx;
	--AddRuntimeStat(26,1,0,2*nPairCount)--≤Œ”Î1V1»À¥Œ
	return nPairCount;
end
--ªÒµ√“ª∂‘ÕÊº“°£
--≤Œ ˝2Œ™∆Ê ˝ ±Œ™◊Ó∏ﬂª˝∑÷µƒÕÊº“≈‰∂‘£¨»ª∫Û∞—ÕÊº““∆≥˝≥ˆ¡–±Ì£¨
--≤Œ ˝2Œ™≈º ˝ ±Œ™◊ÓµÕª˝∑÷µƒÕÊº“≈‰∂‘£¨»ª∫Û∞—ÕÊº““∆≥˝≥ˆ¡–±Ì£¨
--÷ÿ∏¥“‘…œ≈‰∂‘π˝≥Ã÷±µΩ¡–±Ì¿Ô√Ê√ª”–ÕÊº“
function BWT_GetPairGestPlayer(nOrder)
	local nQueueSize = GetGestQueueSize();
	if nQueueSize <= 1 then
		return 0,0,0;	--Œ®“ª∑µªÿ≈‰∂‘ ß∞‹µƒ«Èøˆ
	end

	local nDirection			= 0;	--1Œ™œÚ…œ∆•≈‰ÕÊº“£¨-1Œ™œÚœ¬∆•≈‰ÕÊº“
	local nPIdx1				= 0;	--ÕÊº“1µƒÀ˜“˝
	local nPIdx2				= 0;	--ÕÊº“2µƒÀ˜“˝
	local nLevel				= 0;	--ÕÊº“1µƒµ»º∂
	local nPoint				= 0;	--ÕÊº“1µƒµ±«∞ª˝∑÷
	local nResult				= 0;	--ÕÊº“1 §∏∫ ˝

	if mod(nOrder,2) == 1 then	--∆Ê ˝
		nPIdx1 = GetPlayerByGestQueueIndex(nQueueSize - 1);
		nDirection = -1;	--œÚœ¬∆•≈‰
	else	--≈º ˝
		nPIdx1 = GetPlayerByGestQueueIndex(0);
		nDirection = 1;		--œÚ…œ∆•≈‰
	end

	nLevel	= GetLevel(nPIdx1);
	nPoint	= GetTask(TSK_CURREALRESULT, nPIdx1);
	nResult	= GetTask(TASKID_BIWU_MATCH_RESULT, nPIdx1);

	local nPointRangeLv		= 0;	--ª˝∑÷≤Óµ»º∂
	local nPointRangeStep		= 30;	--ª˝∑÷≤Ó≤Ω≥§
	local nPointRangeLvMax		= 3;	--ª˝∑÷≤Ó◊Ó¥Ûµ»º∂
	local nLevelRangeLv		= 0;	--µ»º∂≤Óµ»º∂
	local nLevelRangeStep		= 1;	--µ»º∂≤Ó≤Ω≥§
	local nLevelRangeLvMax		= 99;	--µ»º∂≤Ó◊Ó¥Ûµ»º∂
	nPointRangeLv = nPointRangeLvMax;
	nLevelRangeLv = nLevelRangeLvMax;

	local nTempPIdx			= 0;				--¡Ÿ ±ÕÊº“
	local nTempPointRangeLv	= 0;				--¡Ÿ ±ª˝∑÷≤Óµ»º∂
	local nTempLevelRangeLv	= 0;				--¡Ÿ ±µ»º∂≤Óµ»º∂
	local nQueueIdx			= 0;				--≈‰∂‘¡–±Ì¿Ô√Êµƒ∂”¡–À˜“˝
	local nMaxQueueIdx			= nQueueSize - 1;	--≈‰∂‘¡–±Ì÷–µƒ◊Ó¥ÛÀ˜“˝£¨”…”⁄À˜“˝ «¥”0ø™ ºµƒ£¨À˘“‘◊Ó¥ÛÀ˜“˝æÕ «nQueueSize-1

	for i = 1, nMaxQueueIdx do
		local bPass = 1;
		nQueueIdx = floor((nMaxQueueIdx * (1 - nDirection) / 2) + nDirection * i);	--¥”Õ∑∏„ªπ «¥”Œ≤∏„
		nTempPIdx = GetPlayerByGestQueueIndex(nQueueIdx);

		if 1 == bPass then
			bPass = ((nTempPIdx > 0) and 1) or 0;
		end

		if 1 == bPass then
			bPass = ((nResult == GetTask(TASKID_BIWU_MATCH_RESULT, nTempPIdx)) and 1) or 0;
		end

		if 1 == bPass then
			bPass = GLB_BW_Block_Route_Check_Ex(nPIdx1, nTempPIdx);
		end

		if 1 == bPass then
			nTempPointRangeLv = floor(abs(nPoint - GetTask(TSK_CURREALRESULT, nTempPIdx)) / nPointRangeStep) + 1;
			nTempLevelRangeLv = floor(abs(nLevel - GetLevel(nTempPIdx))                   / nLevelRangeStep) + 1;

			if nTempPointRangeLv < nPointRangeLv then
				bPass = 1;
			elseif nTempPointRangeLv == nPointRangeLv then
				if nTempLevelRangeLv < nLevelRangeLv then
					bPass = 1;
				elseif nTempLevelRangeLv == nLevelRangeLv then
					bPass = random(0, 1);
				else
					bPass = 0;
				end
			else
				bPass = 0;
			end
		end

		if 1 == bPass then
			nPIdx2			= nTempPIdx;
			nPointRangeLv	= nTempPointRangeLv;
			nLevelRangeLv	= nTempLevelRangeLv;
		end
	end

	if 0 == nPIdx2 then
		return 0, nPIdx1, nPIdx2;
	end

	BWT_QuitGestConvention(nPIdx1);
	BWT_QuitGestConvention(nPIdx2);
	return 1, nPIdx1, nPIdx2;
end
--ºÏ≤ÈÀ˘”–ÕÊº“µƒ◊¥Ã¨ «∑Òø…“‘≤Œº”±»Œ‰
function BWT_CheckAllPlayerState()
	local nQueueSize	= GetGestQueueSize();
	local tFailPlayer	= {};
	for i = 0, nQueueSize - 1 do
		local nPIdx = GetPlayerByGestQueueIndex(i);
--		if 0 == CheckXYY(nPIdx) then
--			tinsert(tFailPlayer, nPIdx);
--		end
	end

	tFailPlayer.n = nil;
	for _, nPIdx in tFailPlayer do
		BWT_QuitGestConvention(nPIdx);
		GLB_BW_LEAVE(200, nPIdx);
	end
end
--±»»¸“ª≥°“™ø€≥˝µƒXX --±ÿ–Î∂º «ƒ‹πª≥…π¶ø€≥˝µƒ
function BWT_CostOneRount(nPIdx1, nPIdx2)
	GLB_BW_Block_Route_Cost(nPIdx1);
	GLB_BW_Block_Route_Cost(nPIdx2);
end
--ºÏ≤ÈÕÊº“µ±«∞◊¥Ã¨ «∑Òø…“‘Ω” ‹—˚«Î
function BWT_CheckPlayerState(nPIdx)
	local nOldPIdx = PlayerIndex;
	PlayerIndex = nPIdx;
	local nTimeElapse = GetTime() - GetTask(TSK_LAST_INVITE_TIME);
	if nTimeElapse >= 0 and nTimeElapse <= INVITE_INTERVAL_TIME then	--»Áπ˚nTimeElapse–°”⁄0,ƒ«√¥±Ì æ≥ˆœ÷π˝øÁ∑˛––Œ™£¨’‚÷÷«Èøˆ≤ª±ÿœﬁ÷∆À˚
		BWDH_SetTask(TSK_CHECK_FAIL,0);	--“≤À„ºÏ≤ÈÕ®π˝
		PlayerIndex = nOldPIdx;
		return 0;	--»Áπ˚æ‡¿Î…œ¥Œæ‹æ¯ªÚ±»Œ‰Ω· ¯ ±º‰–°”⁄INVITE_INTERVAL_TIME√Î
	end;
	--PK÷µ¥Û”⁄4,À¿Õˆ£¨∞⁄ÃØ£¨≤ª‘⁄∫œ∑®µÿÕº
	if GetPKValue() >= 4 or IsPlayerDeath() == 1 or IsStalling() == 1 or BWT_CheckValidMap() == 0 then	--»Áπ˚µ±«∞ «À¿Õˆ◊¥Ã¨ªÚ‘⁄∞⁄ÃØªÚ≤ª‘⁄∫œ∑®µÿÕº
		BWDH_SetTask(TSK_CHECK_FAIL,1);	--’‚¿Ô◊˜“ª∏ˆºÏ≤È≤ªÕ®π˝µƒ±Íº«
		TaskTip("Trπng th∏i cÒa bπn hi÷n kh´ng Æ≠Óc t˚ v‚, bπn Æ∑ rÍi kh·i cuÈc thi.");
		Msg2Player("Trπng th∏i cÒa bπn hi÷n kh´ng Æ≠Óc t˚ v‚, bπn Æ∑ rÍi kh·i cuÈc thi. H∑y ki”m tra Æi”m PK cÒa bπn c„ ph∂i >=4, hi÷n c„ ph∂i Î trπng th∏i tˆ vong ho∆c Æang Î g«n Tuy“n Ch©u");
		PlayerIndex = nOldPIdx;
		return 0;
	end;
	BWDH_SetTask(TSK_CHECK_FAIL,0);	--ºÏ≤ÈÕ®π˝±Íº«
	PlayerIndex = nOldPIdx;
	return 1;
end;
--ºÏ≤Èµ±«∞À˘¥¶µÿÕº «≤ª «ø…“‘Ω” ’±»Œ‰—˚«Î
function BWT_CheckValidMap(nPIdx)
	local nOldPIdx = PlayerIndex;
	PlayerIndex = nPIdx or PlayerIndex;
	local tbValidMap = {
				100,105,108,103,104,106,107,109,110,111,112,
				113,114,115,116,151,306,307,319,320,974,7100,
				};
	local nCurMapID = GetWorldPos();
	for i=1,getn(tbValidMap) do
		if nCurMapID == tbValidMap[i] then
			PlayerIndex = nOldPIdx;
			return 1;
		end;
	end;
	PlayerIndex = nOldPIdx;
	return 0;
end;
--œÚ“ª∂‘—° ÷∑¢ÀÕ±»Œ‰—˚«Î
function BWT_SentInviteToPlayer(nPIdx1,nPIdx2)
	local nHour = tonumber(date("%H"));
	if BWT_CheckBiWuTime() == 0 then
		return 0;	--≤ª‘⁄±»Œ‰ ±º‰ƒ⁄
	end;
	local nOldPIdx = PlayerIndex;
	if not nPIdx1 then	--»Áπ˚√ª”– ‰»Î≤Œ ˝
		nPIdx1,nPIdx2 = GetPairGestPlayer();
	end;
	if nPIdx1 == 0 and nPIdx2 == 0 then	--»Áπ˚√ª≈‰∂‘≥…π¶
		return 0;
	end;
	BWT_QuitGestConvention(nPIdx1);	--—°≥ˆ¿¥∫Ûœ»ÕÀ≥ˆ¡–±Ì
	BWT_QuitGestConvention(nPIdx2);
	if BWT_CheckPlayerState(nPIdx1) == 0 or BWT_CheckPlayerState(nPIdx2) == 0 then
		return -1,nPIdx1,nPIdx2;
	end;
	local nCurTime = GetTime();
	PlayerIndex = nPIdx1;
	BWT_SetTaskTemp(TSK_TEMP_CHOICE,0);	--«Â—°‘Ò«Èøˆ
	BWDH_SetTask(TSK_LAST_INVITE_TIME,nCurTime);
	BWDH_SetTask(TSK_OPPNAME_HASH,Hash(GetName(nPIdx2)));	--º«¬º∂‘ ÷√˚◊÷HASH¬Î”√”⁄ªÿµ˜ ±µƒ◊Ó÷’»∑»œ
	PlayerIndex = nPIdx2;
	BWT_SetTaskTemp(TSK_TEMP_CHOICE,0);
	BWDH_SetTask(TSK_OPPNAME_HASH,Hash(GetName(nPIdx1)));
	BWDH_SetTask(TSK_LAST_INVITE_TIME,nCurTime);
	OnWant(nPIdx1,nPIdx2);
	PlayerIndex = nOldPIdx;
	return 1;
end;
--ªÒ»°¡Ÿ ±±‰¡øµƒ÷µ
function BWT_GetTaskTemp(nID,nPIdx)
	local nOldPIdx = PlayerIndex;
	PlayerIndex = nPIdx or PlayerIndex;
	local nValue = GetTaskTemp(TSK_TEMP_CHOICE);
	PlayerIndex = nOldPIdx;
	return nValue;
end;
--…Ë÷√¡Ÿ ±±‰¡ø
function BWT_SetTaskTemp(nID,nValue,nPIdx)
	local nOldPIdx = PlayerIndex;
	PlayerIndex = nPIdx or PlayerIndex;
	SetTaskTemp(nID,nValue);
	PlayerIndex = nOldPIdx;
end;
--ªÒ»°∂ØÃ¨±»Œ‰≥°µÿID
function BWT_GetIdleRoom()
	local nCount = 0;
	local nMapID,nMapIdx = 0,0;
	for i,v in TB_MAPID do
		if SubWorldID2Idx(i) >= 0 then
			nCount = GetMapLoadCount(v[2]);
			if nCount < MAX_ROOM_NUM then
				nMapID,nMapIdx = DynamicLoadMap(v[2]);
				return nMapID,nMapIdx,i;
			end;
		end;
	end;
	return 0,0,0;
end;
--ø™∆Ù“ª≥°±»Œ‰
function BWT_OpenMatch(nPIdx1,nPIdx2)
	local nMapID,nMapIdx,nCityID = BWT_GetIdleRoom();
	if nMapID == 0 and nMapIdx == 0 then
		return 0;
	end;
	local nOldPIdx = PlayerIndex;
--	local nDirection,nNum = BWT_GetFieldDirection(nCityID);
--	if nDirection == 0 then
--		gf_ShowDebugInfor("BWT_GetFieldDirection∑µªÿ÷µŒ™0,0");
--		WriteLog("["..LOG_ERROR_HEAD.."]:BWT_GetFieldDirection∑µªÿ÷µŒ™0,0");
--		print("Fail2");
--		return 0;
--	end;
	if mf_OpenMission(MISSION_ID,nMapID) == 1 then
		mf_SetMissionV(MISSION_ID,MV_CITY_ID,nCityID,nMapID);
		mf_SetMissionV(MISSION_ID,MV_MAPID,nMapID,nMapID);
		mf_SetMissionV(MISSION_ID,MV_MAPIDX,nMapIdx,nMapID);
--		mf_SetMissionV(MISSION_ID,MV_FIELD_DIRECTION,nDirection,nMapID);
		mf_SetMissionV(MISSION_ID,MV_FIELD_NUM,nNum,nMapID);
		PlayerIndex = nPIdx1;
		mf_JoinMission(MISSION_ID,A_CAMP,nMapID);
		PlayerIndex = nPIdx2;
		mf_JoinMission(MISSION_ID,B_CAMP,nMapID);
--		BWT_InitOneRound();	--‘Ÿ≥ı ºªØ“ª¬÷
		WriteLog(format("[ßπi HÈi T˚ V‚ bæt Æ«u] [Hai b™n ÆËi trÀn: %s vs %s] [Th´ng tin trÀn Æ u: %d,%d,%d]",GetName(nPIdx1),GetName(nPIdx2),nMapID,nMapIdx,nCityID))
	end;
	PlayerIndex = nOldPIdx;
end;
--πÿ±’±»Œ‰≥°µÿ
function BWT_CloseField()
	local nMapID = GetMissionV(MV_MAPID);
	local nMapIdx = GetMissionV(MV_MAPIDX);
	CloseMission(MISSION_ID);
	local nRetCode = FreeDynamicMap(nMapID,nMapIdx);	--FreeDynamicMap“≤ª·µ˜”√CloseMisssion
	if nRetCode == 0 then
		WriteLog("["..LOG_ERROR_HEAD.."]:FreeDynamicMap bﬁ lÁi, nRetCode:"..nRetCode);
	end;
	WriteLog(format("[ßπi HÈi T˚ V‚ k’t thÛc] [Th´ng tin trÀn Æ u: %d,%d]",nMapID,nMapIdx))
end;
--ºÏ≤ÈÕÊº“◊∞±∏ «∑Ò∑˚∫œ±»Œ‰πÊ∂®£¨»Áπ˚∑˚∫œπÊ∂®∑µªÿ1,≤ª∑˚∫œ∑µªÿ0∫Õ“ª∏ˆtable
--table¿Ô√Ê÷∏√˜¡Àªπ”–ƒƒ–©Œª÷√µƒ◊∞±∏≤ª∑˚∫œ
function BWT_CheckEquipment(nPIdx)
	do--À˘”–◊∞±∏∂º‘ –Ì
		return 1
	end
	
--	local nOldPIdx = PlayerIndex;
--	PlayerIndex = nPIdx or PlayerIndex;
--	local nEquipIdx = 0;
--	local nCheckNum = 0;
--	local tbEquipPos = {};	--◊∞±∏–≈œ¢table
--	for i=1,6 do	--ºÏ≤ÈÕ∑“¬ø„Œ‰∆˜ ◊ Œ1 ◊ Œ2
--		nEquipIdx = GetPlayerEquipIndex(i-1);
--		if nEquipIdx == 0 then	--√ª¥©◊∞±∏
--			nCheckNum = nCheckNum + 1;
--			tbEquipPos[i] = 1;
--		else
--			if BWT_CheckSuohunEquip(nEquipIdx) == 1 then
--				if BWT_CheckNormalEquip(nEquipIdx) == 1 or BWT_CheckSuitEquip(nEquipIdx) == 1 then	--Ã◊◊∞∫Õ∆’Õ®◊∞ºÏ≤È≥…π¶
--					nCheckNum = nCheckNum + 1;
--					tbEquipPos[i] = 1;
--				else
--					tbEquipPos[i] = 0;
--				end;
--			else
--				tbEquipPos[i] = 0;
--			end
--		end;
--	end;
--	for i=7,12 do	--ºÏ≤ÈÕ∑“¬ø„Œ‰∆˜ ◊ Œ1 ◊ Œ2
--		nEquipIdx = GetPlayerEquipIndex(i-1);
--		if nEquipIdx == 0 then	--√ª¥©◊∞±∏
--			nCheckNum = nCheckNum + 1;
--			tbEquipPos[i] = 1;
--		else
--			if BWT_CheckSuohunEquip(nEquipIdx) == 1 then
--				nCheckNum = nCheckNum + 1;
--				tbEquipPos[i] = 1;
--			else
--				tbEquipPos[i] = 0;
--			end
--		end;
--	end;
--	PlayerIndex = nOldPIdx;
--	if nCheckNum == 12 then	--À˘”–◊∞±∏∂ºÕ®π˝ºÏ≤È
--		return 1,tbEquipPos;
--	else
--		return 0,tbEquipPos;
--	end;
end;

--ºÏ≤ÈÀ˘¥©◊∞±∏ «∑Ò «◊‘º∫√˚◊÷µƒÀ¯ªÍ◊∞±∏
function BWT_CheckSuohunEquip(nEquipIdx)
	local nOwnName = GetItemOwner(nEquipIdx);
	local nPlayerName = GetName();
	local nVersion,nCurGs = GetRealmType();
	if nCurGs == 1 then
		local strGbGroup,strName = GLB_BW_GetRealmName(GetName());
		nPlayerName = strName;
	end
	if nOwnName == "" or nOwnName == nPlayerName then
		return 1;
	else
		return 0;
	end
end

--ºÏ≤ÈÃ◊◊∞
function BWT_CheckSuitEquip(nEquipIdx)
	if BWT_CheckBaGuaSuit(nEquipIdx) == 1
		or BWT_CheckRouteSuitID(nEquipIdx) == 1
		or BWT_CheckCangJianSuitID(nEquipIdx) == 1
		or BWT_ShiTuSuitID(nEquipIdx) == 1 then
		return 1;
	else
		return 0;
	end;
end;
--ºÏ≤È∞Àÿ‘◊∞ID
function BWT_CheckBaGuaSuit(nEquipIdx)
	if GetItemMaxLingQi(nEquipIdx) > 0 then
		return 1;
	end;
	return 0;
end;
--ºÏ≤È ¶√≈◊∞ID
function BWT_CheckRouteSuitID(nEquipIdx)
	local nRoute = GetPlayerRoute();
	local nSuitID = GetEquipSuitID(nEquipIdx);
	for i=1,getn(TB_ROUTE_SUIT_ID[nRoute]) do
		if nSuitID == TB_ROUTE_SUIT_ID[nRoute][i] then
			return 1;
		end;
	end;
	return 0;
end;
--ºÏ≤È≤ÿΩ£Ã◊◊∞ID
function BWT_CheckCangJianSuitID(nEquipIdx)
	local nRoute = GetPlayerRoute();
	local nSuitID = GetEquipSuitID(nEquipIdx);
	for i=1,getn(TB_CANGJIAN_SUIT_ID) do
		if nSuitID == TB_CANGJIAN_SUIT_ID[i] then
			return 1;
		end;
	end;
	return 0;
end;
--ºÏ≤È ¶ÕΩ◊∞Ã◊◊∞ID
function BWT_ShiTuSuitID(nEquipIdx)
	local nRoute = GetPlayerRoute();
	local nSuitID = GetEquipSuitID(nEquipIdx);
	for i=1,getn(TB_SHITU_SUIT_ID) do
		if nSuitID == TB_SHITU_SUIT_ID[i] then
			return 1;
		end;
	end;
	return 0;
end;
--ºÏ≤È∆’Õ®◊∞±∏
function BWT_CheckNormalEquip(nEquipIdx)
	if BWT_CheckHatID(nEquipIdx) == 1
		or BWT_CheckClothID(nEquipIdx) == 1
		or BWT_CheckTrousersID(nEquipIdx) == 1
		or BWT_CheckRingID(nEquipIdx) == 1
		or BWT_CheckWeaponID(nEquipIdx) == 1 then
		return 1;
	else
		return 0;
	end;
end;
--ºÏ≤È ◊ ŒID
function BWT_CheckRingID(nEquipIdx)
	local nID1,nID2,nID3 = GetItemInfoByIndex(nEquipIdx);
	if nID1 == 0 and nID2 == 102 then
		for i=1,getn(TB_RING_ID) do
			if type(TB_RING_ID[i]) == "table" then
				if nID3 >= TB_RING_ID[i][1] and nID3 <= TB_RING_ID[i][2] then
					return 1;
				end
			else
				if nID3 == TB_RING_ID[i] then
					return 1;
				end
			end
		end;
	end;
	return 0;
end;
--ºÏ≤È√±◊”ID
function BWT_CheckHatID(nEquipIdx)
	local nID1,nID2,nID3 = GetItemInfoByIndex(nEquipIdx);
	if nID1 == 0 and nID2 == 103 then
		for i=1,getn(TB_HAT_ID) do
			if type(TB_HAT_ID[i]) == "table" then
				if nID3 >= TB_HAT_ID[i][1] and nID3 <= TB_HAT_ID[i][2] then
					return 1;
				end
			else
				if nID3 == TB_HAT_ID[i] then
					return 1;
				end
			end
		end;
	end;
	return 0;
end;
--ºÏ≤È“¬∑˛ID
function BWT_CheckClothID(nEquipIdx)
	local nID1,nID2,nID3 = GetItemInfoByIndex(nEquipIdx);
	if nID1 == 0 and nID2 == 100 then
		for i=1,getn(TB_CLOTH_ID) do
			if type(TB_CLOTH_ID[i]) == "table" then
				if nID3 >= TB_CLOTH_ID[i][1] and nID3 <= TB_CLOTH_ID[i][2] then
					return 1;
				end
			else
				if nID3 == TB_CLOTH_ID[i] then
					return 1;
				end
			end
		end;
	end;
	return 0;
end;
--ºÏ≤Èø„◊”ID
function BWT_CheckTrousersID(nEquipIdx)
	local nID1,nID2,nID3 = GetItemInfoByIndex(nEquipIdx);
	if nID1 == 0 and nID2 == 101 then
		for i=1,getn(TB_TROUSERS_ID) do
			if type(TB_TROUSERS_ID[i]) == "table" then
				if nID3 >= TB_TROUSERS_ID[i][1] and nID3 <= TB_TROUSERS_ID[i][2] then
					return 1;
				end
			else
				if nID3 == TB_TROUSERS_ID[i] then
					return 1;
				end
			end
		end;
	end;
	return 0;
end;
--ºÏ≤ÈŒ‰∆˜ID
function BWT_CheckWeaponID(nEquipIdx)
	local nID1,nID2,nID3 = GetItemInfoByIndex(nEquipIdx);
	for i=1,getn(TB_WEAPON_ID) do
		if nID1 == TB_WEAPON_ID[i][1] and nID2 == TB_WEAPON_ID[i][2] and nID3 == TB_WEAPON_ID[i][3] then
			return 1;
		end;
	end;
	return 0;
end;
--≥ı ºªØ≥°µÿNPC
function BWT_InitFieldNpc()
	local nMapID = gf_GetCurMapID();
	local nNpcIdx = CreateNpc("R≠¨ng ÆÂ Trung Nguy™n","ThÒ khË",nMapID,1533,3170);
	SetNpcScript(nNpcIdx,"\\script\\biwudahui\\npc\\npc_itemkeeper.lua");
	nNpcIdx = CreateNpc("R≠¨ng ÆÂ Trung Nguy™n","ThÒ khË",nMapID,1655,3317);
	SetNpcScript(nNpcIdx,"\\script\\biwudahui\\npc\\npc_itemkeeper.lua");
end;
--ªÒµ√ø…”√µƒ±»Œ‰≥°µÿµƒ∑ΩœÚ”Î±‡∫≈
function BWT_GetFieldDirection(nCityID)
	local tbMapID = gf_GetDataTable(GetSameMaps(TB_MAPID[nCityID][2]));
	local tbFieldInfo = {};
	local nMapID = 0;
	local nDirection,nNum = 0,0;
	for i=1,getn(tbMapID) do
		nMapID = tbMapID[i];
		if nMapID ~= TB_MAPID[nCityID][2] then
			if mf_GetMissionV(MISSION_ID,MV_MISSION_STATE,nMapID) ~= MS_STATE_IDEL then
				nDirection = mf_GetMissionV(MISSION_ID,MV_FIELD_DIRECTION,nMapID);
				nNum = mf_GetMissionV(MISSION_ID,MV_FIELD_NUM,nMapID);
				tinsert(tbFieldInfo,{nDirection,nNum});
			end;
		end;
	end;
	local bFound = 0;
	for i=1,4 do  --Àƒ∏ˆ∑ΩœÚ
		for j=1,8 do  --√ø∏ˆ∑ΩœÚ”–º∏∏ˆ≥°µÿ
			bFound = 0;
			for k=1,getn(tbFieldInfo) do
				if tbFieldInfo[k][1] == i and tbFieldInfo[k][2] == j then
					bFound = 1;
				end;
			end;
			if bFound == 0 then
				return i,j;
			end;
		end;
	end;
	return 0,0;
end;
--ªÒµ√ƒ≥≥°±»Œ‰µƒ–≈œ¢£¨∞¸¿®±»Œ‰À´∑ΩÀ˜“˝£¨≥°µÿµ±«∞◊¥Ã¨£¨ «∑Ò‘ –Ìπ€ø¥
function BWT_GetMatchInfo(nCityID,nDirection,nNum)
	local nMapID = BWT_GetDesMapID(nCityID,nDirection,nNum);
	if nMapID == 0 then
		return 0,0,0,0;
	end;
	local szName1,szName2 = BWT_GetFighterName(nMapID);
	local nState = mf_GetMissionV(MISSION_ID,MV_MISSION_STATE,nMapID);
	local nPIdx1 = mf_GetMissionV(MISSION_ID,MV_PLAYERINDEX1,nMapID);
	local nPIdx2 = mf_GetMissionV(MISSION_ID,MV_PLAYERINDEX2,nMapID);
	if GetTask(TSK_ALLOW_AUDIENCE,nPIdx1) == 1 and GetTask(TSK_ALLOW_AUDIENCE,nPIdx2) == 1 then
		return nPIdx1,nPIdx2,nState,1;
	else
		return nPIdx1,nPIdx2,nState,0;
	end;
end;
--ªÒµ√ƒø±Í±»Œ‰µÿÕºµƒµÿÕºID£¨»Áπ˚∑µªÿµÿÕºIDŒ™0‘Ú±Ì æ∏√≥°µÿŒ¥ø™∆Ù
function BWT_GetDesMapID(nCityID,nDirection,nNum)
	local nFieldID = TB_MAPID[nCityID][2];
	local tbMapID = gf_GetDataTable(GetSameMaps(nFieldID));
	local nMapID = 0;
	local nFieldDirection,nFieldNum = 0,0;
	for i=1,getn(tbMapID) do
		nMapID = tbMapID[i];
		nFieldDirection = mf_GetMissionV(MISSION_ID,MV_FIELD_DIRECTION,nMapID);
		nFieldNum = mf_GetMissionV(MISSION_ID,MV_FIELD_NUM,nMapID);
		if nFieldDirection == nDirection and nFieldNum == nNum then
			return nMapID;
		end;
	end;
	return 0;
end;
--π€÷⁄º”»Îπ€ø¥
function BWT_AudienceJoin(nCityID,nDirection,nNum,bAllow)
	if bAllow == 0 then
		Talk(1,"","Xin lÁi! Ng≠Íi ch¨i Î T˚ v‚ tr≠Íng nµy kh´ng cho ng≠Íi kh∏c xem thi Æ u.");
		return 0;
	end;
	local nMapID = BWT_GetDesMapID(nCityID,nDirection,nNum);
	local nState = mf_GetMissionV(MISSION_ID,MV_MISSION_STATE,nMapID);
	local nAudienceNum = mf_GetPlayerCount(MISSION_ID,AUDIENCE_CAMP,nMapID);
	if nState == MS_STATE_IDEL then
		Talk(1,"","Khu v˘c nµy Æ∑ bﬁ Æ„ng.");
		return 0;
	end;
	if nAudienceNum >= MAX_AUDIENCE_NUM then
		Talk(1,"","SË l≠Óng ng≠Íi khu v˘c nµy Æ∑ Æπt giÌi hπn tËi Æa: <color=yellow>"..MAX_AUDIENCE_NUM.."<color> ng≠Íi");
		return 0;
	end;
	mf_JoinMission(MISSION_ID,AUDIENCE_CAMP,nMapID);
end;
--¥¶¿ÌTrapµ„°£
-- ‰»Î≤Œ ˝Œ™∑ΩœÚ°£∫Ø ˝¿Ô√ÊΩ¯––≥°µÿƒ⁄¥¶µƒ≈–∂œ
function BWT_ProcessTrap(nDirection)
	do
		return 0
	end
	if GetTaskTemp(TSK_TEMP_CAMP) == 0 then	--≥°Õ‚Trapµ„¥¶¿Ì
		local selTab = {};
		local nCityID = 0;
		local nCurMapID = GetWorldPos();
		local nPIdx1,nPIdx2 = 0,0;
		local nState = 0;
		for i,v in TB_MAPID do
			if v[1] == nCurMapID then
				nCityID = i;
				break;
			end;
		end;
		for i=1,8 do
			nPIdx1,nPIdx2,nState,bAllow = BWT_GetMatchInfo(nCityID,nDirection,i);
			if nState > MS_STATE_IDEL then
				tinsert(selTab,format("Ta muËn vµo"..i.." - (khu thi Æ u)/#BWT_AudienceJoin(%d,%d,%d,%d)",nCityID,nDirection,i,bAllow));
			end;
		end;
		if getn(selTab) == 0 then
			Talk(1,"","L´i Æµi nµy kh´ng c„ ng≠Íi thi Æ u");
			return 0;
		end;
		tinsert(selTab,"Kh´ng vµo xem/nothing");
		local tbDirection = {"H≠Ìng Æ´ng","H≠Ìng nam","H≠Ìng T©y","H≠Ìng Bæc"};
		Say("Bπn muËn vµo khu v˘c nµo trong <color=yellow>"..tbDirection[nDirection].."<color>?",getn(selTab),selTab);
	else	--≥°ƒ⁄Trapµ„¥¶¿Ì
		DelMSPlayer(MISSION_ID,AUDIENCE_CAMP);
	end;
end;

--º«¬º §∏∫£¨nResultTypeŒ™1 ±±Ì æ∆Ωæ÷
function BWT_AddBiWuRecord(nWinnerIdx,nLoserIdx,nResultType)
	nResultType = nResultType or 0;
	local nOldPIdx = PlayerIndex;
	local nCurWeekWin = 0;
	local nCurXinDeNum = 0;
	local nCount = 0;
	PlayerIndex = nWinnerIdx;
	BWDH_SetTask(TASKID_BIWU_MATCH_RESULT, 1);
	BWDH_SetTask(TSK_CURWEEKMATCH,GetTask(TSK_CURWEEKMATCH)+1);
	BWDH_SetTask(TSK_TOTALMATCH,GetTask(TSK_TOTALMATCH)+1);
	if GetTask(TSK_CURWEEKMATCH) <= REQUIRE_MATCH_TIME then --º«¬º«∞10≥°µƒ §≥° ˝
		BWDH_SetTask(TASK_BIWU_WIN_10,GetTask(TASK_BIWU_WIN_10)+1);
	end
	if GetTask(TSK_CURWEEKMATCH) >= REQUIRE_MATCH_TIME then --10≥°∫Û«ø÷∆µ«º«
		BWDH_SetTask(TSK_CURSIGNEDRESULT,GetTask(TSK_CURREALRESULT));
		SignUpGestResult();
	end
	if nResultType ~= 1 then
		nCurWeekWin = GetTask(TSK_CURWEEKWIN);
		BWDH_SetTask(TSK_TOTALWIN,GetTask(TSK_TOTALWIN)+1);
		BWDH_SetTask(TSK_CURWEEKWIN,nCurWeekWin+1);
		--≥…æÕ---------------------------------------
--		BWDH_SetTask(TASKID_ACH_BIWU_WIN_TOTAL,GetTask(TASKID_ACH_BIWU_WIN_TOTAL)+1);
--		local nRoute = GetPlayerRoute();
--		local nLoseRoute = GetPlayerRoute(nLoserIdx);
--		if nRoute == 31 or nRoute == 32 then
--			BWDH_SetTask(TASKID_ACH_USE_NEW_ROUTE,GetTask(TASKID_ACH_USE_NEW_ROUTE)+1);
--		end
--		if nLoseRoute == 31 or nLoseRoute == 32 then
--			BWDH_SetTask(TASKID_ACH_WIN_NEW_ROUTE,GetTask(TASKID_ACH_WIN_NEW_ROUTE)+1);
--		end
		----------------------------------------------
--		if GLB_BW_BiWuCheck() == 1 then	
--			if GetTask(TSK_CURWEEKWIN) <= REQUIRE_MATCH_TIME then --«∞10≥°”–
--				BWDH_SetTask(TASK_BIWU_DUIZHAN_JINGYAN,GetTask(TASK_BIWU_DUIZHAN_JINGYAN)+12);
--				Msg2Player("ƒ„ªÒµ√12µ„∂‘’Ωæ≠—È£¨√ø»À√ø÷‹ø…“‘ªÒµ√120µ„∂‘’Ωæ≠—È£¨ƒ„“—æ≠ªÒµ√¡À"..(GetTask(TSK_CURWEEKWIN)*12).."µ„∂‘’Ωæ≠—È");
--			end
--		end
		WLZB_AddPoint();	-- baqizhi
	end;
	local nVersion,nCurGs = GetRealmType();
	if nCurGs == 1 and GLB_BW_BiWuCheck() == 1 then --∞—±‰¡ø–¥»Î ˝æ›ø‚
		--GLB_BW_SetTask(0,0,tRelayTask);
		
		exgsvr_func_save_player_task()--œÚ‘¥∑˛¥Ê≈Ã
--		local nRoute = GetPlayerRoute();
--		if nRoute == 21 then --∂Ò–ƒµƒπ∆ ¶
--			GLB_BW_SetTask(0,1,tGushiTask);
--		end
--		GLB_BW_SetTask(0,2);--Õ¨≤ΩÂ–“£±“
--		GLB_BW_SetTask(0,3);--Õ¨≤ΩÂ–“£”Ò
	end
	WriteLog(format("[ßπi HÈi T˚ V‚] [Role: %s Acc: %s  C p: %d  t›ch Æi”m: %d  m´n ph∏i: %d   K’t qu∂: thæng K˝ hi÷u hﬂa: %d]", GetName(), GetAccount(), GetLevel(),GetTask(TSK_CURREALRESULT),GetPlayerRoute(),nResultType));
	PlayerIndex = nLoserIdx;
	BWDH_SetTask(TASKID_BIWU_MATCH_RESULT, 0);
	BWDH_SetTask(TSK_CURWEEKMATCH,GetTask(TSK_CURWEEKMATCH)+1);
	BWDH_SetTask(TSK_TOTALMATCH,GetTask(TSK_TOTALMATCH)+1);
	if GetTask(TSK_CURWEEKMATCH) <= REQUIRE_MATCH_TIME then --º«¬º«∞10≥°µƒ∏∫≥° ˝
		BWDH_SetTask(TASK_BIWU_LOSE_10,GetTask(TASK_BIWU_LOSE_10)+1);
	end
	if GetTask(TSK_CURWEEKMATCH) >= REQUIRE_MATCH_TIME then --10≥°∫Û«ø÷∆µ«º«
		BWDH_SetTask(TSK_CURSIGNEDRESULT,GetTask(TSK_CURREALRESULT));
		SignUpGestResult();
	end
	if nResultType ~= 1 then
		BWDH_SetTask(TSK_TOTALLOSE,GetTask(TSK_TOTALLOSE)+1);
		BWDH_SetTask(TSK_CURWEEKLOSE,GetTask(TSK_CURWEEKLOSE)+1);
		if GLB_BW_BiWuCheck() == 1 then
--			if GetTask(TSK_CURWEEKMATCH) <= REQUIRE_MATCH_TIME then --«∞10≥°”–£¨“—æ≠–ﬁ∏ƒŒ™ ß∞‹√ª”–¡À
--				BWDH_SetTask(TASK_BIWU_DUIZHAN_JINGYAN,GetTask(TASK_BIWU_DUIZHAN_JINGYAN)+8);
--				Msg2Player("ƒ„ªÒµ√8µ„∂‘’Ωæ≠—È£¨√ø÷‹µƒ«∞10≥°Ωœ“’ø…“‘ªÒµ√∂‘’Ωæ≠—È°£");
--			end
		end
		WLZB_DecPoint();	-- baqizhi
	end;
	if nCurGs == 1 and GLB_BW_BiWuCheck() == 1 then --∞—±‰¡ø–¥»Î ˝æ›ø‚
		exgsvr_func_save_player_task()--œÚ‘¥∑˛¥Ê≈Ã
--		GLB_BW_SetTask(0,0,tRelayTask);
--		local nRoute = GetPlayerRoute();
--		if nRoute == 21 then --∂Ò–ƒµƒπ∆ ¶
--			GLB_BW_SetTask(0,1,tGushiTask);
--		end
--		GLB_BW_SetTask(0,2);
--		GLB_BW_SetTask(0,3);
	end
	WriteLog(format("[ßπi HÈi T˚ V‚] [Role: %s Acc: %s  C p: %d  t›ch Æi”m: %d  m´n ph∏i: %d   K’t qu∂: bπi K˝ hi÷u hﬂa: %d]", GetName(), GetAccount(), GetLevel(),GetTask(TSK_CURREALRESULT),GetPlayerRoute(),nResultType));
	PlayerIndex = nOldPIdx;
end;
--ªÒµ√÷‹ ˝
function BWT_GetWeekNum()
--	local nCurTime = GetTime();
--	local nOffset = 8*3600*24+13*3600; 	--‘› ±Œ“ªπ√ªÀ„√˜∞◊
--	nCurTime = nCurTime - nOffset;
--	return floor(nCurTime/(7*3600*24));
	local nWeekNum = GetPlayerBwRank();
	return nWeekNum;
end;
--√ø÷‹“ª«Â°£º«◊°£∫playerloginin¿Ôªπ”–“ª∑›“ªƒ£“ª—˘µƒ¥˙¬Î
function BWT_WeeklyClear()
	local nVersion,nCurGs = GetRealmType();
	if nCurGs == 1 then --øÁ∑˛≤ªƒÒ
		return 0;
	end
	local nWeekNum = BWT_GetWeekNum();
	local nBodyWeek = GetTask(TSK_BODY_WEEK);
	if nWeekNum == -1 then	--Relayπ“¡À
		return 0;
	end;
	if nBodyWeek - nWeekNum >= 1 then	--∫œ∑˛∫ÛnWeekNumª·¥”0ø™ º
		WriteLog(format("[biwudahui] BWT_WeeklyClear [Role:%s Acc:%s Level:%d BodyWeek=%d WeekNum=%d repair BodyWeek ]", GetName(), GetAccount(), GetLevel(),nBodyWeek, nWeekNum))
		BWDH_SetTask(TSK_BODY_WEEK,nWeekNum-1);	--Õ¨≤ΩÕÊº“…Ì…œµƒ÷‹ ˝
		BWDH_SetTask(TSK_GET_AWARD_WEEK,nWeekNum-1);	--Õ¨≤ΩÕÊº“¡Ï»°Ω±¿¯µƒ÷‹ ˝
		nBodyWeek = nWeekNum-1;
	end;
	if nBodyWeek >= nWeekNum then
		return 0;
	end;
	BWT_PointAttenuation();
	BWDH_SetTask(TSK_CURWEEKMATCH,0);	--±æ÷‹◊‹≤Œ”Î≥°¥Œ
	BWDH_SetTask(TSK_CURWEEKWIN,0);		--±æ÷‹ §¿˚≥°¥Œ
	BWDH_SetTask(TSK_CURWEEKLOSE,0);		--±æ÷‹ ß∞‹≥°¥Œ
	BWDH_SetTask(TSK_CURWEEKGETXINDE,0);	--±æ÷‹Õ®π˝Ωœ“’ªÒµ√µƒ–ƒµ√ ˝¡ø
	BWDH_SetTask(TSK_CURSIGNEDRESULT,0);	--µ«º«ª˝∑÷«Â0
	BWDH_SetTask(TSK_GET_XINDE_STATE,0);	--±æ÷‹ªÒµ√ µ’Ω–ƒµ√«Èøˆ«Â0
	BWDH_SetTask(TSK_USE_XINDE,0);		--±æ÷‹ π”√ µ’Ω–ƒµ√«Â£∞
	BWDH_SetTask(TSK_BUY_HORSE,0);		--±æ÷‹¬Ú¬Ì«Â£∞
	BWDH_SetTask(TSK_USE_CHUANGONG_XINDE,0);	-- π”√¥´π¶–ƒµ√
	BWDH_SetTask(TSK_XZ_AWARD_JUNGONG,0);	--±æ÷‹∂“ªªµƒ’Ω≥°Ω±¿¯¥Œ ˝
	BWDH_SetTask(TSK_XZ_AWARD_SHIMEN,0);		--±æ÷‹∂“ªªµƒ ¶√≈Ω±¿¯¥Œ ˝
	BWDH_SetTask(TSK_XZ_AWARD_LINGSHI,0);	--±æ÷‹∂“ªªµƒ¡È ØΩ±¿¯¥Œ ˝
	BWDH_SetTask(TSK_XZ_AWARD_JINGYAN,0);	--±æ÷‹∂“ªªµƒæ≠—ÈΩ±¿¯¥Œ ˝
	BWDH_SetTask(TASK_BIWU_WIN_10,0);	--«∞10≥°µƒ §¿˚≥°¥Œ
	BWDH_SetTask(TASK_BIWU_LOSE_10,0);	--«∞10≥°µƒ ß∞‹≥°¥Œ
	BWDH_SetTask(TASK_BIWU_GET_AWARD_10,0);	-- «∑Ò¡Ï»°¡À«∞10≥°µƒΩ±¿¯
--	BWDH_SetTask(TASKID_3F_BW_AWARD,0); --»˝Ω⁄ªÓ∂Ø
	if GetTask(TSK_CURREALRESULT) < 200 then
		BWDH_SetTask(TSK_CURREALRESULT,200);	--µÕ”⁄100∑÷µƒªÿπÈµΩ100∑÷
	end;
end;
--À¯∂®”ÎΩ‚À¯◊∞±∏
function BWT_LockEquipment(bLock)
	local tbEquipPos = {0,1,2,3,4,5,6,7,8,10,17,18,19};
	for i=1,getn(tbEquipPos) do
		ForbidEquipSolt(tbEquipPos[i],bLock);
	end
end;
--ºÏ≤È «∑Ò“™∞—π€÷⁄Ãﬂ≥ˆ≥°µÿ
function BWT_CheckKickAudience()
	local nPIdx1 = mf_GetMissionV(MISSION_ID,MV_PLAYERINDEX1);
	local nPIdx2 = mf_GetMissionV(MISSION_ID,MV_PLAYERINDEX2);
	if nPIdx1 == 0 or nPIdx2 == 0 then
		return 0;
	end;
	if GetTask(TSK_ALLOW_AUDIENCE,nPIdx1) == 0 or GetTask(TSK_ALLOW_AUDIENCE,nPIdx2) == 0 then
		mf_Say2Camp(MISSION_ID,AUDIENCE_CAMP,"Tuy”n thÒ thi Æ u kh´ng muËn c„ ng≠Íi xem, bπn Æ∑ tho∏t kh·i khu v˘c thi Æ u.",0,"");
		mf_DelAllMSPlayer(MISSION_ID,AUDIENCE_CAMP);
		return 1;
	end;
	return 0;
end;

--–ﬁ∏ƒΩœ“’ª˝∑÷
function BWT_AddPoint(nPoint,nPIdx)
	local nOldPIdx = PlayerIndex;
	nPIdx = nPIdx or PlayerIndex;
	BWT_WeeklyClear();
	local nCurPoint = GetTask(TSK_CURREALRESULT);
	local nRegPoint = GetTask(TSK_CURSIGNEDRESULT);
	nCurPoint = nCurPoint + nPoint;
	BWDH_SetTask(TSK_CURREALRESULT,nCurPoint);
	if nPoint > 0 then
		BWDH_SetTask(TSK_TOTAL_POINT,GetTask(TSK_TOTAL_POINT)+nPoint);
	end;
	if GetTask(TSK_CURWEEKMATCH) >= REQUIRE_MATCH_TIME then --»Áπ˚µ±«∞∑÷ ˝±»÷Æ«∞µ«º«µƒ∑÷ ˝“™µÕ30∑÷
		BWDH_SetTask(TSK_CURSIGNEDRESULT,nCurPoint);
--		SignUpGestResult();	--«ø÷∆∞—∑÷ ˝µ«º«…œ»•
--		gf_ShowMsg("ƒ˙µ±«∞µƒ’Ê µª˝∑÷±»µ«º«ª˝∑÷µÕ¡À30∑÷ªÚ∏¸∂‡£¨À˘“‘œµÕ≥Ω¯––«ø––µ«º«£¨ƒ˙œ÷‘⁄µƒµ«º«ª˝∑÷ «<color=yellow>"..nCurPoint.."<color>°£",2);
	end;
	if GetTask(TSK_JOIN_LIST) == 1 then
		QuitGestConvention();
		JoinGestConvention();
	end;
	PlayerIndex = nOldPIdx;
end;
--ª˝∑÷Ω¯––À•ºı
function BWT_PointAttenuation()
	local nWeekNum,nBWLevel,nBWRank = GetPlayerBwRank();
	if nWeekNum == -1 then	--Relayπ“¡À
		return 0;
	end;
	local nBodyWeek = GetTask(TSK_BODY_WEEK);
	if nBodyWeek >= nWeekNum then
		return 0;
	end;
	local nCurPoint = GetTask(TSK_CURREALRESULT);
	local nWeekElapse = nWeekNum - nBodyWeek;
	local nAttenPoint = BWT_GetPointAttenuation(nCurPoint,nWeekElapse);
	if nCurPoint-nAttenPoint > 0 then
		Msg2Player("ßi”m t›ch lÚy t˚ v‚ gi∂m"..(nCurPoint-nAttenPoint).." Æi”m");
	end;
	BWDH_SetTask(TSK_CURREALRESULT,nAttenPoint);
	BWDH_SetTask(TSK_BODY_WEEK,nWeekNum);	--º«¬ºÀ•ºıµƒ÷‹ ˝
	BWDH_SetTask(TSK_LASTWEEKLADDER,0);	--À•ºı ±«ÂµÙ…œ÷‹≈≈√˚
	if nBWRank ~= -1 and nBWRank <= 10 then	--»Áπ˚Ω¯»Î¡À≈≈––∞Ò
		BWDH_SetTask(TSK_LASTWEEKLADDER,nBWRank);
		local nBestWeekRank = GetTask(TSK_HIGHESTWEEKLADDER);
		if nBestWeekRank == 0 or nBWRank < nBestWeekRank then
			BWDH_SetTask(TSK_HIGHESTWEEKLADDER,nBWRank);	--◊Ó∏ﬂ÷‹≈≈√˚
		end;
	end;
	WriteLog("["..LOG_HEAD.."]:"..GetName().."ßi”m t›ch lÚy t˚ v‚ gi∂m. Tr≠Ìc lÛc gi∂m: "..nCurPoint..", sau khi gi∂m: "..nAttenPoint);
end;
--∑‚◊∞µƒQuitGestConvention
function BWT_QuitGestConvention(nPIdx)
	local nOldPIdx = PlayerIndex;
	PlayerIndex = nPIdx or PlayerIndex;
	QuitGestConvention();
	BWDH_SetTask(TSK_JOIN_LIST,0);
--	if BWDH_DEBUG_VERSION == 1 then
--		Msg2Player("QuitGestConvention")
--	end
	PlayerIndex = nOldPIdx;
end;
--∑‚◊∞µƒJoinGestConvention
function BWT_JoinGestConvention(nPIdx)
	local nOldPIdx = PlayerIndex;
	PlayerIndex = nPIdx or PlayerIndex;
	local nLevel = GetLevel();
	if nLevel >= MIN_LEVEL then
		JoinGestConvention();
		BWDH_SetTask(TSK_JOIN_LIST,1);
	end;
--	if BWDH_DEBUG_VERSION == 1 then
--		Msg2Player("JoinGestConvention")
--	end
	PlayerIndex = nOldPIdx;
end;
--±»Œ‰ø™ º ±∂‘ÕÊº“Ω¯––µƒ…Ë÷√
function BWT_SetPlayerFightState(nCamp,nPIdx)
	local nOldPIdx = PlayerIndex;
	nPIdx = nPIdx or PlayerIndex;
	PlayerIndex = nPIdx;
	BWT_LockEquipment(1);
	UseSkillEnable(1);
	DesaltPlayer(0,0);
	Restore();
	RestoreNeili();
	ClearColdDown();	--«Â≥˝À˘”–“©CD
	CastState("imme_clear_skill_interval",-1,0);	--œ˚≥˝À˘”–ººƒ‹µƒ¿‰»¥ ±º‰
	PlayerIndex = nOldPIdx;
end;
--…Ë÷√ÕÊº“ÀÊª˙Œª÷√
function BWT_SetRandomPos(nPIdx, nExcept)
	local nOldPIdx = PlayerIndex;
	nPIdx = nPIdx or PlayerIndex;
	PlayerIndex = nPIdx;
	local nRand = random(1,getn(TB_ENTRY[4]));
	if nExcept and nExcept == nRand then
		nRand = nRand + 1
		if nRand > getn(TB_ENTRY[4]) then
			nRand = 1
		end
	end
	SetPos(TB_ENTRY[4][nRand][1],TB_ENTRY[4][nRand][2]);
	Restore();
	RestoreNeili();
	PlayerIndex = nOldPIdx;
	return nRand
end;
--º∆À„ª˝∑÷À•ºı£¨∑µªÿ÷µ «æ≠π˝À•ºı∫Ûµƒª˝∑÷£®’‚∏ˆ∫Ø ˝√˚∆µ√∫‹”–Œ Ã‚∞°-_-b£©
function BWT_GetPointAttenuation(nPoint,nWeek)
	if nPoint <= 300 then
		return nPoint;
	end;
	for i=1,nWeek do
		if nPoint <= 300 then
			break;
		else
			nPoint = nPoint - floor((nPoint-300)/2);
		end;
	end;
	return nPoint;
end;
--ªÒµ√°∞“ª÷‹°± £”‡ ±º‰£®µ•Œª√Î£©
function BWT_GetWeekTimeLeft()
	local nWeekDay = tonumber(date("%w"));
	local nHour = tonumber(date("%H"));
	local nMin = tonumber(date("%M"));
	local nSec = tonumber(date("%S"));
	local nSecLeft = 60*60*24-(nHour*3600+nMin*60+nSec);
	local nTime = 0;
	if nWeekDay < 5 then
		nTime = (5-nWeekDay-1)*3600*24+nSecLeft+21*3600;
	elseif nWeekDay == 5 then
		nTime = 6*3600*24+nSecLeft+21*3600;
	else
		nTime = (11-nWeekDay)*3600*24+nSecLeft+21*3600;
	end;
	return nTime;
end;
--ºÏ≤È «≤ª «‘⁄±»Œ‰ ±º‰∂Œ
function BWT_CheckBiWuTime()
--	local nWeekDay = tonumber(date("%w"));
--	if nWeekDay ~= 0 and nWeekDay ~= 1 and nWeekDay ~= 6 then
--		return 0;
--	end
	if BWDH_DEBUG_VERSION and BWDH_DEBUG_VERSION == 1 then
		return 1
	end
	
	local nHour = tonumber(date("%H"));
	--19µ„÷¡21µ„
	if nHour >= 20 and nHour < 22 then
		return 1
	else
		return 0;
	end;
end;
--==========================================================================================
--Àµ√˜œ‡πÿµƒƒ⁄»›£¨ªπ «–¥‘⁄“ª∆∞…£¨≤ª»ª∏ƒ¿¥∏ƒ»•Ã´¬È∑≥¡À
function know_detail()
	local selTab = {
				"ßπi hÈi t˚ v‚/know_detail_1",
				"So tµi/know_detail_2",
				"hπng/know_detail_3",
				"ßi”m/know_detail_4",
				--"Ω±¿¯/know_detail_5",
				"Kh´ng c«n/nothing",
				}
	Say(g_szInfoHead.."Bπn muËn bi’t ph≠¨ng di÷n nµo?",getn(selTab),selTab);
end;

function know_detail_1()
	Talk(1,"know_detail",g_szInfoHead.."ßπi hÈi t˚ v‚\n    ßπi hÈi t˚ v‚ lµ g◊? ß„ ch›nh lµ cuÈc thi do tri“u Æ◊nh tÊ ch¯c nhªm tuy”n ch‰n nh©n s‹ v‚ l©m ≠u tÛ, Æ≠Óc chia lµm 2 giai Æoπn: Vﬂng loπi vµ vﬂng chung k’t. N’u bπn muËn tham gia, c«n ph∂i Æ’n Bi÷n Kinh t◊m ß∆c S¯ ßπi HÈi T˚ V‚, Æ„ lµ ng≠Íi Æ≠Óc tri“u Æ◊nh Æ“ cˆ chuy™n phÙc tr∏ch ßπi hÈi t˚ v‚.\n    Chÿ c„ ng≠Íi ch¨i chuy”n sinh 5 c p 96 trÎ l™n mÌi c„ th” tham gia ßπi hÈi t˚ v‚ thi™n hπ Æ÷ nh t.");
end;

function know_detail_2()
	Talk(1,"know_detail_2_2",g_szInfoHead.."T˚ v‚ \n    T˚ v‚ nh≠ th’ nµo? Sau khi t˚ v‚ li™n server mÎ ra, Æ«u ti™n bπn c«n t◊m Æπi s¯ ßπi HÈi T˚ V‚ Æ” Æ’n khu v˘c t˚ v‚ li™n server. Sau Æ„, sœ c„ th” Î giao di÷n ßπi HÈi T˚ V‚ ch‰n t˚ v‚.\n   MuËn t˚ v‚ r t Æ¨n gi∂n, c¯ tı 20:00-22:00, chÿ c«n bπn Î trong khu v˘c t˚ v‚ li™n server, trong giao di÷n ßπi HÈi T˚ V‚ ch‰n t˚ v‚ lµ Æ≠Óc rÂi, h÷ thËng sœ t˘ ÆÈng giÛp bπn t◊m ÆËi thÒ.\n   ChÛ ˝, chÿ c«n t◊m Æ≠Óc ÆËi thÒ, h÷ thËng sœ t˘ ÆÈng Æ≠a bπn l™n l´i Æµi t˚ v‚.");
end;

function know_detail_2_1()
	Talk(1,"know_detail_2_2",g_szInfoHead.."NhÀn th´ng tin thi Æ u Î Æ©u?\n    Khu v˘c bπn c„ th” nhÀn Æ≠Óc th´ng tin thi Æ u hi÷n c„:\n    Tuy“n Ch©u, T©y Tuy“n Ch©u, Bæc Tuy“n Ch©u, ß´ng H∂i H∂i T©n 1, ß´ng H∂i H∂i T©n 2, Long Tuy“n th´n, VÚ Di s¨n, Thanh ¢m ÆÈng_1, Thanh ¢m ÆÈng_2, Thanh Kh™ ÆÈng, L≠Ïng ThÒy ÆÈng_1, L≠Ïng ThÒy ÆÈng_2, V≠¨ng M…u ÆÈng_1, V≠¨ng M…u ÆÈng_2, V©n MÈng Trπch, Giang T©n th´n, Phong ß´, Phong Ma ÆÈng_1, Phong Ma ÆÈng_2, b™n ngoµi Æπi hÈi t˚ v‚ Tuy“n Ch©u.");
end;

function know_detail_2_2()
	Talk(2,"know_detail",g_szInfoHead.."T˚ v‚ n™n chÛ ˝ g◊? \n     ß” m‰i ng≠Íi c„ th” t˚ v‚ trong mÈt m´i tr≠Íng c´ng bªng, cho n™n Æπt ra mÈt sË quy tæc. Tr≠Ìc khi t˚ v‚ c«n chÛ ˝ nÈi dung d≠Ìi Æ©y: \n1: khi Æ≠a vµo l´i Æµi t˚ v‚ t t c∂ trπng th∏i tr™n ng≠Íi sœ bﬁ x„a, bao gÂm pet Æi theo ho∆c thi th” do NgÚ ßÈc Tµ Hi÷p chi™u g‰i cÚng bﬁ x„a. \n2: ngoµi danh hi÷u s≠ m´n ra, c∏c danh hi÷u kh∏c Æ“u v´ hi÷u trong l´i Æµi t˚ v‚. \n3: ThuÈc t›nh mÁi 10 gi©y phÙc hÂi sinh l˘c vµ nÈi l˘c tr™n trang bﬁ sœ v´ hi÷u\n","\n4: kh´ng th” ÆÊi trang bﬁ, nh≠ng c„ th” ÆÊi mÀt tﬁch");
end;

function know_detail_3()
	Talk(1,"know_detail_3_1",g_szInfoHead.."X’p hπng \n    	x’p hπng th’ nµo? n’u bπn t˚ v‚ ÆÒ 10 trÀn ho∆c 10 trÀn trÎ l™n trong tu«n, h÷ thËng sœ t˘ ÆÈng Æ®ng k˝ Æi”m t›ch lÚy cÒa bπn. Æ®ng k˝ Æi”m t›ch lÚy th◊ c„ th” tham gia x’p hπng tu«n nay. 11 giÍ 30 phÛt tËi chÒ nhÀt cÒa mÁi tu«n sœ ti’n hµnh x’p hπng. <color=yellow> chÛ ˝: ph∂i Æ∂m b∂o tr≠Ìc 11 giÍ 30 phÛt trÎ v“ server nguÂn.<color>");
end;
function know_detail_3_1()
	Talk(1,"know_detail",g_szInfoHead.."X’p hπng\n    X’p hπng c„ t∏c dÙng g◊? n’u x’p hπng c„ th” Æi vµo top 10 cÒa l≠u ph∏i, th◊ ng≠¨i c„ th” nhÀn Æ≠Óc Æi”m t≠ c∏ch vµ gi∂i th≠Îng; n’u x’p hπng Æ«u cÒa l≠u ph∏i, th◊ chÛc mıng ng≠¨i, ng≠¨i Æ∑ lµ Æ÷ nh t cao thÒ cÒa l≠u ph∏i m◊nh tu«n nay, sœ nhÀn Æ≠Óc Æi”m x’p hπng cao nh t vµ gi∂i th≠Îng nhi“u nh t.\n    Gamer x’p hπng tËt sœ Æi vµo b∂ng x’p hπng Æπi hÈi t˚ v‚ li™n server.n’u ng≠¨i ch≠a vµo top 10 cÒa l≠u ph∏i m◊nh, Æıng n∂n lﬂng, chÿ c«n t˚ v‚ ÆÒ 10 trÀn trong tu«n nay,cÚng c„ th” nhÀn th≠Îng.nhÀn th≠Îng tπi giao di÷n Æπi hÈi t˚ v‚,click nhÀn gi∂i th≠Îng ti’n hµnh thao t∏c t≠¨ng quan.");
end;

function know_detail_4()
	Talk(1,"know_detail",g_szInfoHead.."X’p hπng \n    ßi”m lµ g◊? ßi”m cÒa ßπi HÈi T˚ V‚ c„ 2 loπi, mÈt loπi lµ Æi”m t›ch lÚy t˚ v‚, mÈt loπi lµ Æi”m t≠ c∏ch. \n Æi”m t›ch lÚy t˚ v‚ lµ Æi”m t®ng vµ gi∂m khi t˚ v‚ nhÀn Æ≠Óc, h÷ thËng Æ®ng k˝ xong sœ x’p hπng theo Æi”m nµy, n’u Æi”m v≠Ót qua 300, mÁi tu«n nh˜ng Æi”m v≠Ót qua 300 Æ„ sœ bﬁ gi∂m nˆa.");
end;

--function know_detail_5()
--	Talk(1,"know_detail_5_1",g_szInfoHead.."Ω±¿¯∑÷“‘œ¬º∏÷÷£∫\n    æ≠—È£∫ø™∆ÙøÁ∑˛±»Œ‰¥Ûª·‘§—°»¸÷Æ∫Û£¨∏˘æ›√ø÷‹≤Œº”±»Œ‰µƒ«∞10≥°Ωœ“’Ω·π˚£¨‘⁄±æ	∑˛±»Œ‰¥Ûª·ΩÁ√Ê¡Ï»°°∞ µ’Ω–ƒµ√°±°£√ø÷‹¥”Ωœ“’÷–◊Ó∂‡ø…“‘ƒ√µΩ20±æ°∞ µ’Ω–ƒµ√°±°£\n    ª˝∑÷¥ÔµΩ120∑÷ø…“‘‘⁄±»Œ‰ΩÁ√Ê¡Ï»°10±æ µ’Ω–ƒµ√£¨ª˝∑÷¥ÔµΩ150∑÷ø…“‘∂‡¡Ï»°10	±æ µ’Ω–ƒµ√£¨ª˝∑÷¥ÔµΩ200∑÷ø…“‘‘Ÿ¡Ï»°10±æ µ’Ω–ƒµ√°£\n    √ø÷‹◊Ó∂‡ø…ªª»°50±æ°∞ µ’Ω–ƒµ√°±£¨√ø÷‹ø…“‘ π”√100±æ°∞ µ’Ω–ƒµ√°±°£");
--end;
--
--function know_detail_5_1()
--	Talk(1,"know_detail_5_2",g_szInfoHead.."    øÃ∞Â£∫≤Œº”øÁ∑˛±»Œ‰¥Ûª·‘§—°»¸£¨∏˘æ›±æ÷‹µƒ §≥° ˝ø…‘⁄±»Œ‰¥Ûª·ΩÁ√Ê¡Ï»° ◊ Œ¿‡ª®	Œ∆øÃ∞ÂΩ±¿¯°£√ø»À√ø÷‹◊Ó∂‡ø…ªÒµ√10≥° §≥°Ω±¿¯°£\n    ∂‘’Ωæ≠—È£∫≤Œº”øÁ∑˛±»Œ‰¥Ûª·‘§—°»¸£¨ªÒ §∫Ûø…ªÒµ√∂‘’Ωæ≠—È°£√ø»À√ø÷‹◊Ó∂‡ø…ªÒµ√	10≥° §≥°µƒ∂‘’Ωæ≠—È°£∂‘’Ωæ≠—Èø…‘⁄±»Œ‰¥Ûª·ΩÁ√Ê°∞∂“ªª◊∞±∏°±¥¶∂“ªª ◊ Œ¿‡ª®Œ∆øÃ∞Â°£");
--end;
--
--function know_detail_5_2()
--	Talk(1,"know_detail",g_szInfoHead.."    ≥∆∫≈£∫ª˝∑÷≈≈√˚µΩ«∞10æÕ”–◊®√≈µƒ≥∆∫≈£¨µ⁄1√˚“ªµµ£¨µ⁄2°¢3√˚“ªµµ£¨µ⁄4÷¡10√˚“ªµµ°£≤ªÕ¨µµ¥Œµƒ≥∆∫≈ª·∏Ω¥¯“ª∂®µƒƒ‹¡¶º”≥…°£\n    ◊¯∆Ô£∫÷ª“™ƒ√µΩ±æ¡˜≈…µƒ«∞3√˚£¨æÕ”–◊ ∏Ò¡Ï»°Ãÿ∂®◊¯∆Ô£∫◊¶ª∆∑…µÁªÚ≥‡Õ√£¨±æ¡˜≈…µƒµ⁄1√˚£¨ø…“‘√‚∑—◊‚”√◊¶ª∆∑…µÁªÚ≥‡Õ√°£\n    ◊‚µΩµƒ…Òæ‘ƒ‹πªŒ¨≥÷7ÃÏ°£");
--end
--===========================================================================================
--Ω±¿¯µƒ“≤∑≈’‚¿Ô∞…£¨≤ª»ª“™–ﬁ∏ƒ¡Ω∏ˆµÿ∑ΩÃ´¬È∑≥¡À°£
function BWT_GetAward()
	BWT_WeeklyClear();
	local strtab = {
		"NhÀn th≠Îng t˚ v‚ tu«n nµy/BWT_GetWeekAward",
		"NhÀn th≠Îng x’p hπng tu«n tr≠Ìc/BWT_GetRankAward",
--		"¡Ï»°«¯∑˛Ω±¿¯/BWT_GetGlobalAward",
		"K’t thÛc ÆËi thoπi/nothing"
	};
	Say(g_szInfoHead.."Bπn muËn nhÀn th≠Îng loπi nµo?",
		getn(strtab),
		strtab)
end;

function BWT_GetWeekAward()
	local strtab = {
		"NhÀn th≠Îng trÀn tham gia/BWT_GetWeekAward_Win",
		--"¡Ï»°±»Œ‰ª˝∑÷µƒΩ±¿¯/BWT_GetWeekAward_Point",
		--"¡Ï»°Ω£œ¿±“Ω±¿¯/BWT_GetWeekAward_Gold",
		"K’t thÛc ÆËi thoπi/nothing",
	}
	local nDate = tonumber(date("%Y%m%d"));
--	if nDate <= 20101010 then
--		tinsert(strtab,3,"¡Ï»°—Ãª≤ƒ¡œ∞¸/BWT_GetYanhuo");
--	end
	Say(g_szInfoHead.."Bπn muËn nhÀn th≠Îng loπi nµo?",
		getn(strtab),
		strtab)
end

function BWT_GetWeekAward_Gold()
	if GetTask(TSK_CURWEEKWIN) < 10 then
		Talk(1,"",g_szInfoHead.."ßπi HÈi T˚ V‚ tu«n nµy kh´ng thæng ÆÒ 10 trÀn, kh´ng th” nhÀn th≠Îng.");
		return 0;
	end
	if gf_GetTaskByte(TASK_BIWU_GET_AWARD_10,2) ~= 0 then
		Talk(1,"",g_szInfoHead.."Bπn Æ∑ nhÀn ph«n th≠Îng Vµng v‚ l©m cÒa tu«n nµy.");
		return 0;
	end
	gf_SetTaskByte(TASK_BIWU_GET_AWARD_10,2,1, TASK_ACCESS_CODE_BIWUDAHUI);
	gf_SetLogCaption("ßπi HÈi T˚ V‚-Ph«n th≠Îng Vµng v‚ l©m");
	gf_Modify("Money",300000);
	gf_SetLogCaption("");
end

function BWT_GetWeekAward_Win()
	if GetTask(TSK_CURWEEKMATCH) < REQUIRE_MATCH_TIME then
		Talk(1,"",g_szInfoHead.."SË l«n ng≠¨i tham gia so tµi tu«n nµy ›t h¨n <color=yellow>"..REQUIRE_MATCH_TIME.."<color> trÀn, kh´ng th” nhÀn th≠Îng.");
		return 0;
	end
	if gf_GetTaskByte(TASK_BIWU_GET_AWARD_10,1) ~= 0 then
		Talk(1,"",g_szInfoHead.."Bπn Æ∑ nhÀn th≠Îng trÀn tham gia tu«n tr≠Ìc.");
		return 0;
	end
	
	local nExp = 20000000 --* GetTask(TASK_BIWU_WIN_10) / REQUIRE_MATCH_TIME
--	local nCount = GetTask(TASK_BIWU_WIN_10)*2+GetTask(TASK_BIWU_LOSE_10);
--	local nRingCount = min(GetTask(TSK_CURWEEKWIN),10)*4;  --√ø÷‹◊Ó∂‡ªÒµ√10≥° §¿˚µƒøÃ∞Â
	if nExp > 0 then
		if gf_Judge_Room_Weight(3,10,"") ~= 1 then
			return 0;
		end
		gf_SetTaskByte(TASK_BIWU_GET_AWARD_10,1,1, TASK_ACCESS_CODE_BIWUDAHUI);
		--soul_GivePoint(GetTask(TSK_CURWEEKWIN) * 10);
		gf_SetLogCaption("ßπi HÈi T˚ V‚-Ph«n th≠Îng trÀn tham gia")
		--gf_AddItemEx({2,1,1101,nCount}," µ’Ω–ƒµ√");
		--gf_AddItemEx({2,95,1511,10,4},"∂∑∆«¡Ó");
--		if GLB_BW_BiWuCheck() == 1 then
--			gf_AddItemEx({2,95,595,nRingCount},"1º∂Ω‰÷∏Œ∆ ŒøÃ∞Â");
----			EarnXYY(10);
--		end
		--gf_Modify("Pvp",2400);
		--gf_Modify("Dzjy",2400);
		gf_Modify("Exp",nExp);
		gf_AddItemEx({2,1,30499,2},"Hu©n ch≠¨ng anh hÔng");
		gf_AddItemEx({2,1,30692,10},"R≠¨ng ßπi HÈi T˚ V‚");
		AddRuntimeStat(20, 1, 0, 1)
		AddRuntimeStat(20, 4, 0, 10)
		gf_SetLogCaption("");
		--Observer:onEvent(OE_BIWU_MATCH,{GetTask(TSK_CURWEEKMATCH),GetTask(TASK_BIWU_WIN_10),GetTask(TASK_BIWU_LOSE_10)});
	end;
end

function BWT_GetYanhuo()
--	local nDate = tonumber(date("%Y%m%d"));
--	if nDate <= 20101010 then
--		local nCurAward = GetTask(TASKID_3F_BW_AWARD);
--		local nCurMatch = GetTask(TSK_CURWEEKMATCH);
--		if nCurAward < 30 then
--			local nCurCount = min(nCurMatch,30) - nCurAward
--			if nCurCount > 0 then
--				BWDH_SetTask(TASKID_3F_BW_AWARD,GetTask(TASKID_3F_BW_AWARD)+nCurCount);
--				gf_SetLogCaption("3f2010.±»Œ‰¥Ûª·")
--				gf_AddItemEx({2,95,738,nCurCount},"—Ãª≤ƒ¡œ∞¸");
--				Msg2Player("√ø1≥°±»Œ‰ø…ªÒµ√1∏ˆ—Ãª≤ƒ¡œ∞¸£¨√ø÷‹◊Ó∂‡ªª»°30∏ˆ£°");
--				gf_SetLogCaption("");
--			else
--				Talk(1,"",g_szInfoHead.."¡Ï»°—Ãª≤ƒ¡œ∞¸ ˝¡øµ»”⁄µ±÷‹≤Œº”±»Œ‰¥Ûª·µƒ≥°¥Œ ˝¡ø£¨√ø÷‹◊Ó∂‡ªª»°30∏ˆ£°ƒø«∞ƒ„√ª”––¬µƒ—Ãª≤ƒ¡œ∞¸ø…“‘¡Ï»°£¨±æ÷‹ƒ„“—æ≠¡Ï»°¡À"..nCurAward.."∏ˆ—Ãª≤ƒ¡œ∞¸°£")
--			end
--		else
--			Talk(1,"",g_szInfoHead.."√ø÷‹◊Ó∂‡ªª»°30∏ˆ£°±æ÷‹ƒ„“—æ≠¡Ï»°ÕÍ¡À£¨œ¬÷‹‘Ÿ¿¥∞…°£");
--		end
--	end
end

function BWT_GetWeekAward_Point()
	if GetTask(TSK_CURWEEKMATCH) < REQUIRE_MATCH_TIME then
		Talk(1,"",g_szInfoHead.."SË l«n ng≠¨i tham gia so tµi tu«n nµy ›t h¨n <color=yellow>"..REQUIRE_MATCH_TIME.."<color> trÀn, kh´ng th” nhÀn th≠Îng.");
		return 0;
	end
	local nRegPoint = GetTask(TSK_CURREALRESULT); -- π”√ µº µƒΩœ“’∑÷ ˝
	local nGetXinDeState = GetTask(TSK_GET_XINDE_STATE);
	local nCount = 0;
	if nRegPoint >= 200 and nGetXinDeState < 30 then
		BWDH_SetTask(TSK_GET_XINDE_STATE,30);
		nCount = 30 - nGetXinDeState;
	elseif nRegPoint >= 150 and nGetXinDeState < 20 then
		nCount = 20 - nGetXinDeState;
		BWDH_SetTask(TSK_GET_XINDE_STATE,20);
	elseif nRegPoint >= 120 and nGetXinDeState < 10 then
		nCount = 10 - nGetXinDeState;
		BWDH_SetTask(TSK_GET_XINDE_STATE,10);
	end;

	local szString1,szString2,szString3 = "","","";
	local nGetXinDeState = GetTask(TSK_GET_XINDE_STATE);
	if nGetXinDeState == 30 then
		szString1 = "<color=red>ß∑ l∑nh<color>";
		szString2 = "<color=red>ß∑ l∑nh<color>";
		szString3 = "<color=red>ß∑ l∑nh<color>";
	elseif nGetXinDeState == 20 then
		szString1 = "<color=red>ß∑ l∑nh<color>";
		szString2 = "<color=red>ß∑ l∑nh<color>";
		szString3 = "<color=yellow>Ch≠a l∑nh<color>";
	elseif nGetXinDeState == 10 then
		szString1 = "<color=red>ß∑ l∑nh<color>";
		szString2 = "<color=yellow>Ch≠a l∑nh<color>";
		szString3 = "<color=yellow>Ch≠a l∑nh<color>";
	else
		szString1 = "<color=yellow>Ch≠a l∑nh<color>";
		szString2 = "<color=yellow>Ch≠a l∑nh<color>";
		szString3 = "<color=yellow>Ch≠a l∑nh<color>";
	end;

	if nCount > 0 then
		gf_AddItemEx({2,1,1101,nCount},"Th˘c chi’n t©m Ææc");
		Talk(1,"",g_szInfoHead.."T◊nh h◊nh nhÀn th≠Îng nh≠ sau:\nßi”m t›ch lÚy Æπt 120 nhÀn Æ≠Óc 10 Th˘c Chi’n T©m ßæc       "..szString1.."\nßi”m t›ch lÚy Æπt 150 nhÀn ti’p 10 Th˘c Chi’n T©m ßæc     "..szString2.."\nßi”m t›ch lÚy Æπt 200 nhÀn th™m 10 Th˘c Chi’n T©m ßæc     "..szString3);
	else
		Talk(1,"",g_szInfoHead.."T◊nh h◊nh nhÀn th≠Îng nh≠ sau:\nßi”m t›ch lÚy Æπt 120 nhÀn Æ≠Óc 10 Th˘c Chi’n T©m ßæc       "..szString1.."\nßi”m t›ch lÚy Æπt 150 nhÀn ti’p 10 Th˘c Chi’n T©m ßæc     "..szString2.."\nßi”m t›ch lÚy Æπt 200 nhÀn th™m 10 Th˘c Chi’n T©m ßæc     "..szString3);
	end;
end

function BWT_GetRankAward()
	local nWeekNum,nBWLevel,nBWRank = GetPlayerBwRank();
	if nWeekNum == -1 then	--Relayπ“¡À
		return 0;
	end;
	if nBWRank == -1 or nBWRank > 10 then
		Talk(1,"",g_szInfoHead.."X’p hπng Æi”m t›ch lÚy tu«n tr≠Ìc kh´ng nªm trong 10 hπng Æ«u n™n kh´ng Æ≠Óc nhÀn ph«n th≠Îng.");
		return 0;
	end;
	local selTab = {};
--	tinsert(selTab,"Œ““™¡Ï»°≥∆∫≈/BWT_GetTitleAward");
--	tinsert(selTab,"Œ““™¡Ï»°Œ‰∆˜Ãÿ–ß/BWT_GetWeaponEffectAward");
--	if nBWRank <= 3 then	--«∞£≥√˚ø…“‘¬Ú¬Ì
--		tinsert(selTab,"Œ““™◊‚”√◊¯∆Ô/BWT_GetHorseAward");
--	end;
	tinsert(selTab,format("Gi∂i th≠Îng x’p hπng/#BWT_GetRankAward_Exp(%d)", nBWRank));
	tinsert(selTab,"Tπm thÍi kh´ng l∑nh/nothing");
	Say(g_szInfoHead.."X’p hπng Æi”m t›ch lÚy tu«n tr≠Ìc lµ hπng <color=yellow>"..nBWRank.."<color>, bπn muËn nhÀn ph«n th≠Îng nµo?",getn(selTab),selTab);
	BWT_PointAttenuation();
end

function BWT_GetRankAward_Exp(nBWRank)
	local nWeekNum,nBWLevel,nBWRank = GetPlayerBwRank();
	if GetTask(TSK_GET_AWARD_WEEK) >= nWeekNum then
		Talk(1,"",g_szInfoHead.."Bπn Æ∑ nhÀn ph«n th≠Îng.");
		return 0;
	end;
	if nBWRank >= 1 and nBWRank <= 10 then
		local nExp = 100000000--(11 - nBWRank)*10000*10000
		gf_SetLogCaption("Gi∂i th≠Îng x’p hπng mÁi tu«n ßπi HÈi T˚ V‚")
		BWDH_SetTask(TSK_GET_AWARD_WEEK,nWeekNum);
		gf_Modify("Exp",nExp);
		gf_AddItemEx({2,1,30499,6},"Hu©n ch≠¨ng anh hÔng");
		gf_AddItemEx({2,1,30692,30},"R≠¨ng ßπi HÈi T˚ V‚");
		AddRuntimeStat(20, 2, 0, 1)
		AddRuntimeStat(20, 4, 0, 30)
		
		gf_SetLogCaption("");
	end
end

function BWT_GetWeaponEffectAward()
	local nWeekNum,nBWLevel,nBWRank = GetPlayerBwRank();
	if nWeekNum == -1 then	--Relayπ“¡À
		return 0;
	end;
	if nBWRank == -1 or nBWRank > 10 then
		Talk(1,"",g_szInfoHead.."X’p hπng Æi”m t›ch lÚy tu«n tr≠Ìc kh´ng nªm trong 10 hπng Æ«u n™n kh´ng Æ≠Óc nhÀn ph«n th≠Îng.");
		return 0;
	end;
	local nCheckRoute,nRoutePos = gf_CheckPlayerRoute();
	if nCheckRoute == 0 then
		return 0;
	end;
	if GetTask(TSK_WEAPON_EFFECT_WEEK) >= nWeekNum then
		Talk(1,"",g_szInfoHead.."Bπn Æ∑ nhÀn ph«n th≠Îng.");
		return 0;
	end;
	local nWeaponIdx = GetPlayerEquipIndex(2)
	--Œ‰∆˜◊∞±∏≈–∂œ
	if  nWeaponIdx == 0 then
		Talk(1,"",g_szInfoHead.."H∑y trang bﬁ vÚ kh› tr≠Ìc rÂi Æ’n t◊m ta!")
		return 0;
	end
	local nType = 0;
	if nBWRank == 1 then	--»Áπ˚ «µ⁄“ª√˚
		nType = 1;
	else
		nType = 2;
	end;
	local selTab = {
				"ßÂng ˝/#BWT_AddWeaponEffect("..nType..")",
				"HÒy b·/nothing",
				}
	Say(g_szInfoHead.."NhÀn danh hi÷u Æπi hÈi t˚ v‚ sœ <color=yellow>che m t danh hi÷u s≠ m´n ho∆c danh hi÷u Æπi hÈi v‚ l©m cÔng loπi cÒa bπn<color>, bπn x∏c nhÀn muËn nhÀn ph«n th≠Îng danh hi÷u cÒa Æπi hÈi t˚ v‚?",getn(selTab),selTab);
end;

function BWT_AddWeaponEffect(nType)
	local nWeekNum,nBWLevel,nBWRank = GetPlayerBwRank();
	if nWeekNum == -1 then	--Relayπ“¡À
		return 0;
	end;
	if nBWRank == -1 or nBWRank > 10 then
		Talk(1,"",g_szInfoHead.."X’p hπng Æi”m t›ch lÚy tu«n tr≠Ìc kh´ng nªm trong 10 hπng Æ«u n™n kh´ng Æ≠Óc nhÀn ph«n th≠Îng.");
		return 0;
	end;
	local nWeaponIdx = GetPlayerEquipIndex(2);
	--Œ‰∆˜◊∞±∏≈–∂œ
	if  nWeaponIdx == 0 then
		Talk(1,"",g_szInfoHead.."H∑y trang bﬁ vÚ kh› tr≠Ìc rÂi Æ’n t◊m ta!")
		return 0;
	end
	local tbWeaponEffect = {"Ph∏ Qu©n","Tinh Di"};
	local szWeaponEffectName = tbWeaponEffect[nType];
	BWDH_SetTask(TSK_WEAPON_EFFECT_WEEK,nWeekNum);
	BindWeaponEffect(szWeaponEffectName,7*24*3600);
	Msg2Player("Bπn Æ∑ nhÀn hi÷u ¯ng cÒa vÚ kh›:"..szWeaponEffectName..", thÍi gian duy tr◊ lµ 7 ngµy.");
	WriteLog("["..LOG_HEAD.."]:"..GetName().."ß∑ nhÀn th≠Îng hi÷u ¯ng cÒa vÚ kh›:"..szWeaponEffectName);
end;

function BWT_GetTitleAward()
	local nWeekNum,nBWLevel,nBWRank = GetPlayerBwRank();
	if nWeekNum == -1 then	--Relayπ“¡À
		return 0;
	end;
	if nBWRank == -1 or nBWRank > 10 then
		Talk(1,"",g_szInfoHead.."X’p hπng Æi”m t›ch lÚy tu«n tr≠Ìc kh´ng nªm trong 10 hπng Æ«u n™n kh´ng Æ≠Óc nhÀn ph«n th≠Îng.");
		return 0;
	end;
	local nCheckRoute,nRoutePos = gf_CheckPlayerRoute();
	if nCheckRoute == 0 then
		return 0;
	end;
	if GetTask(TSK_GET_AWARD_WEEK) >= nWeekNum then
		Talk(1,"",g_szInfoHead.."Bπn Æ∑ nhÀn ph«n th≠Îng.");
		return 0;
	end;
	local nTitleGenre = 0;
	if nRoutePos == 2 then	--∞¶£¨”…”⁄≈‰÷√±ÌÃÓ¥Ì¡À£¨÷ª∫√Ω´¥ÌæÕ¥Ì¡À
		nRoutePos = 3;
	elseif nRoutePos == 3 then
		nRoutePos = 2;
	end;
	if nBWRank == 1 then	--»Áπ˚ «µ⁄“ª√˚
		if nBWLevel == 0 then	--»Áπ˚ «–¬–„±»Œ‰¥Ûª·
			nTitleGenre = 27;
		else	--»Áπ˚ «ÃÏœ¬µ⁄“ª±»Œ‰¥Ûª·
			nTitleGenre = 28;
		end;
	elseif nBWRank <= 3 then
		nTitleGenre = 26;
	elseif nBWRank <= 10 then
		nTitleGenre = 25;
	end;
	local selTab = {
				"ßÂng ˝/#BWT_AddBiWuTitle("..nTitleGenre..","..nRoutePos..")",
				"HÒy b·/nothing",
				}
	Say(g_szInfoHead.."NhÀn danh hi÷u Æπi hÈi t˚ v‚ sœ <color=yellow>che m t danh hi÷u s≠ m´n ho∆c danh hi÷u Æπi hÈi v‚ l©m cÔng loπi cÒa bπn<color>, bπn x∏c nhÀn muËn nhÀn ph«n th≠Îng danh hi÷u cÒa Æπi hÈi t˚ v‚?",getn(selTab),selTab);
end;

function BWT_AddBiWuTitle(nID1,nID2)
	local nWeekNum,nBWLevel,nBWRank = GetPlayerBwRank();
	if nWeekNum == -1 then	--Relayπ“¡À
		return 0;
	end;
	if nBWRank == -1 or nBWRank > 10 then
		Talk(1,"",g_szInfoHead.."X’p hπng Æi”m t›ch lÚy tu«n tr≠Ìc kh´ng nªm trong 10 hπng Æ«u n™n kh´ng Æ≠Óc nhÀn ph«n th≠Îng.");
		return 0;
	end;
	local nTimeLeft = 7*24*3600;
	BWT_RemoveOtherBiWuTitle(nID2);
	AddTitle(nID1,nID2);
	SetTitleTime(nID1, nID2, GetTime() + nTimeLeft);
	SetCurTitle(nID1, nID2);
	BWDH_SetTask(TSK_GET_AWARD_WEEK,nWeekNum);
	WriteLog("["..LOG_HEAD.."]:"..GetName().."NhÀn ph«n th≠Îng danh hi÷u Æπi hÈi t˚ v‚. ID danh hi÷u: "..nID1..", "..nID2);
end;

function BWT_RemoveOtherBiWuTitle(nRoutePos)
	for i=23,28 do
		if IsTitleExist(i,nRoutePos) == 1 then
			RemoveTitle(i,nRoutePos);
		end;
	end;
end;

function BWT_GetHorseAward()
	if GetTask(TSK_BUY_HORSE) ~= 0 then
		Talk(1,"","Tu«n nµy bπn Æ∑ thu™ thÛ c≠Ïi, kh´ng th” thu™ n˜a.");
		return 0;
	end;
	local nWeekNum,nBWLevel,nBWRank = GetPlayerBwRank();
	if nWeekNum == -1 then	--Relayπ“¡À
		return 0;
	end;
	local selTab = {};
	if nBWLevel == 0 then
		tinsert(selTab,"Thu™ X›ch K˝ (TËc ÆÈ 30, ph› thu™ 10 vµng)/#BWT_BuyHorse(1)");
		tinsert(selTab,"Thu™ Hoµng K˝ (TËc ÆÈ 30, ph› thu™ 10 vµng)/#BWT_BuyHorse(2)");
	else
		tinsert(selTab,"Thu™ Tr∂o Hoµng Phi ßi÷n (TËc ÆÈ 40, ph› thu™ 20 vµng)/#BWT_BuyHorse(3)");
		tinsert(selTab,"Thu™ X›ch ThË (TËc ÆÈ 40, ph› thu™ 20 vµng)/#BWT_BuyHorse(4)");
	end;
	tinsert(selTab,"Kh´ng thu™/nothing");
	if nBWRank > 0 and nBWRank <= 3 then
		Say(g_szInfoHead.."X’p hπng t›ch lÚy tu«n tr≠Ìc cÒa bπn nªm trong 3 hπng Æ«u, x’p th¯ <color=yellow>"..nBWRank.."<color>, bπn c„ th” thu™ nh≠ng loπi thÛ c≠Ïi Î b™n tr™n. Bπn muËn thu™ loπi nµo? <color=red>ChÛ ˝: Hπn sˆ dÙng lµ 7 ngµy, y™u c«u nh©n vÀt c p 80 mÌi Æ≠Óc dÔng<color>. <color=yellow>N’u bπn hπng 1 l≠u ph∏i th◊ Æ≠Óc thu™ thÛ c≠Ïi mi‘n ph›.<color>",getn(selTab),selTab);
	else
		Talk(1,"",g_szInfoHead.."Xin lÁi! Tu«n tr≠Ìc bπn kh´ng Æπt 3 hπng Æ«u cÒa l≠u ph∏i, kh´ng th” thu™ thÛ c≠Ïi. ChÛc bπn may mæn.");
	end;
end;

g_tbHorseInfo =
{	--ID–≈œ¢£¨º€∏Ò£¨≥÷–¯ÃÏ ˝
	[1] = {{0,105,5,"X›ch K˝"},10,7},
	[2] = {{0,105,6,"Hoµng K˝"},10,7},
	[3] = {{0,105,10,"Tr∂o Hoµng Phi ßi÷n"},20,7},
	[4] = {{0,105,12,"X›ch ThË"},20,7},
}

function BWT_BuyHorse(nType)
	local nWeekNum,nBWLevel,nBWRank = GetPlayerBwRank();
	if nWeekNum == -1 then	--Relayπ“¡À
		return 0;
	end;
	if nBWRank <= 0 or nBWRank > 3 then
		Talk(1,"",g_szInfoHead.."X’p hπng t›ch lÚy tu«n tr≠Ìc nªm trong <color=yellow>3 hπng Æ«u<color> mÌi c„ th” thu™ thÛ c≠Ïi.");
		return 0;
	end;
	if gf_JudgeRoomWeight(2,100,"") == 0 then
		return 0;
	end;
	local nNeedMoney = g_tbHorseInfo[nType][2];
	if nBWRank ~= 1 then	--»Áπ˚≤ª «µ⁄1√˚æÕ“™∏¯«Æ£°
		if GetCash() < nNeedMoney*10000 then
			Talk(1,"","Ng©n l≠Óng cÒa bπn kh´ng ÆÒ, bπn c«n <color=yellow>"..nNeedMoney.."<color> l≠Óng mÌi Æ≠Óc thu™ ng˘a nµy.");
			return 0;
		end;
		Pay(nNeedMoney*10000);
	end;
	local nItemIdx = 0;
	local nTimeLeft = 7*24*3600;
	local nID1,nID2,nID3 = g_tbHorseInfo[nType][1][1],g_tbHorseInfo[nType][1][2],g_tbHorseInfo[nType][1][3];
	local szHorseName = g_tbHorseInfo[nType][1][4];
	local nLastDay = g_tbHorseInfo[nType][3];
	_,nItemIdx = AddItem(nID1,nID2,nID3,1,1,-1,-1,-1,-1,-1,-1);
	SetItemExpireTime(nItemIdx,nLastDay*24*3600);
	Msg2Player("Bπn nhÀn Æ≠Óc 1 "..szHorseName..", thÍi hπn "..nLastDay.."Thi™n");
	BWDH_SetTask(TSK_BUY_HORSE,1);
	WriteLog("["..LOG_HEAD.."]:"..GetName().."Thu™ 1 con ng˘a: "..szHorseName);
end;
--ªÒµ√ƒ≥∏ˆÕÊº“µƒ÷∞“µ√˚◊÷
function BWT_GetPlayerRouteName(nPIdx)
	local nOldPIdx = PlayerIndex;
	local szRouteName = "";
	PlayerIndex = nPIdx;
	szRouteName = gf_GetRouteName(GetPlayerRoute());
	PlayerIndex = nOldPIdx;
	return szRouteName;
end;
--“∆≥˝∑«∑®µƒ◊¥Ã¨
function BWT_RemoveNonlicetState()
	local tbNonlicet =
	{
		[1] = {9901,9906},
		[2] = {19801279,19801281},
	}
	for i=1,getn(tbNonlicet) do
		for j=tbNonlicet[i][1],tbNonlicet[i][2] do
			RemoveState(j);
		end;
	end;
end;
--ªÒ»°ÕÊº“√˚◊÷
function BWT_GetName(nPIdx)
	nPIdx = nPIdx or PlayerIndex;
	local nOldPIdx = PlayerIndex;
	local szName = "";
	PlayerIndex = nPIdx;
	if GetMaskStatus() == 1 then
		szName = "Ng≠Íi th«n b›";
	else
		szName = GetName();
	end;
	PlayerIndex = nOldPIdx;
	return szName;
end;
function nothing()

end;

--===============“‘œ¬Œ™¥¶¿ÌøÁ∑˛±»Œ‰∫Ø ˝======================
tGsName = {
--	{"1-1","Ã“ª®µ∫"},
--	{"1-2","Œ‰“ƒ…Ω"},
--	{"1-4","¡˙√≈’Ú"},
--	{"1-7","“©Õıπ»"},
--	{"1-10","‘∆√Œ‘Û"},
--	{"1-11","±˘–ƒ∂¥"},
--	{"1-12","«Â∑Á∏Û"},
--	{"1-13","◊œ‘∆–˘"},
--	{"1-14","Œ‰¡÷√À"},
--	{"2-1","Œ‚‘Ω¿œ◊Ê"},
--	{"2-3","¬Ã¡÷√À÷˜"},
--	{"2-4","«π…ÒŸ¯ÃÏ"},
--	{"3-1","ÃÏ ¶√ÿæ≥"},
--	{"3-3","Õı∆Ï≤ø¬‰"},
--	{"3-7","Ω£√≈∑…—©"},
--	{"3-9","Ω£∏Û Òµ¿"},
--	{"3-10","¬•¿ºœ˛‘¬"},
--	{"4-1","¬‰–«≥Ω"},
};

-- «∑Òø™∆Ù¡ÀøÁ∑˛±»Œ‰
--–¬∑˛ø™∆Ù–Ë“™ ÷∂Ø–ﬁ∏ƒªπ“™∏ƒ…œ√Êµƒrelay√˚
function GLB_BW_BiWuCheck()
	return 1;
end

tBwChangeItem = {
--	{30,{{2,95,596,1},"2º∂ ◊ ŒŒ∆ Œ∞¸"}},
--	{5, {{2,95,839,1},"Ã´ º Ø"}},
--	{30,{{2,95,739,1},"±»Œ‰…Ò√ÿ¿Ò∫–"}},
};
g_TempItemName = "Kinh nghi÷m ÆËi chi’n ";
--∂‘’Ωæ≠—È∂“ªª◊∞±∏
function GLB_BW_ChangeItem()
	local strtab = {};
	for i = 1,getn(tBwChangeItem) do
		tinsert(strtab,"ßÂng ˝"..tBwChangeItem[i][1]..g_TempItemName.."ßÊi"..tBwChangeItem[i][2][2].."/#GLB_BW_AskChange("..i..")");
	end
--	tinsert(strtab, "Œ““™¡Ï»°“´—Ù¡ÓªÚ©‘¬¡Ó	/GLB_BW_Award_Ling");
--	tinsert(strtab, "Œ““™ π”√“´—Ù¡ÓªÚ©‘¬¡Ó∂“ªª≈˚∑ÁªÚª’’¬		/#GLB_BW_ChangeItem2(2)");
--	tinsert(strtab, "Œ““™ π”√©‘¬ÀÈ∆¨ªÚ“´—ÙÀÈ∆¨∂“ªª≈˚∑ÁªÚª’’¬	/#GLB_BW_ChangeItem2(1)");
	tinsert(strtab, "ßÊi th≠Îng PVP	/#show_equip_shop(48)");

	tinsert(strtab,"K’t thÛc ÆËi thoπi/nothing");
	Say("Bπn muËn ÆÊi ph«n th≠Îng nµo?",
		getn(strtab),
		strtab)
end

function GLB_BW_AskChange(nType)
	if GetTask(TASK_BIWU_DUIZHAN_JINGYAN) < tBwChangeItem[nType][1] then
		Talk(1,"","  "..g_TempItemName.."Kh´ng ÆÒ."..g_TempItemName.."Tham gia ßπi HÈi T˚ V‚ li™n server sœ nhÀn Æ≠Óc.");
		return 0;
	end
	Say("Quy’t Æﬁnh dÔng <color=yellow>"..tBwChangeItem[nType][1].." Æi”m<color>"..g_TempItemName.."ßÊi <color=yellow>"..tBwChangeItem[nType][2][2].."<color> ch¯?",
		3,
		"ßÂng ˝/#GLB_BW_ConfirmChange("..nType..")",
		"trÎ lπi/GLB_BW_ChangeItem",
		"K’t thÛc ÆËi thoπi/nothing")
end

function GLB_BW_ConfirmChange(nType)
	if GetTask(TASK_BIWU_DUIZHAN_JINGYAN) < tBwChangeItem[nType][1] then
		Talk(1,"","  "..g_TempItemName.."Kh´ng ÆÒ."..g_TempItemName.."Tham gia ßπi HÈi T˚ V‚ li™n server sœ nhÀn Æ≠Óc.");
		return 0;
	end
	if gf_Judge_Room_Weight(1,100,"") ~= 1 then
		return 0;
	end
	BWDH_SetTask(TASK_BIWU_DUIZHAN_JINGYAN,GetTask(TASK_BIWU_DUIZHAN_JINGYAN)-tBwChangeItem[nType][1]);
	gf_SetLogCaption(" kinh nghi÷m ÆËi chi’n ÆÊi trang bﬁ ")
	gf_AddItemEx(tBwChangeItem[nType][2][1],tBwChangeItem[nType][2][2]);
	gf_SetLogCaption("");
end

function GLB_BW_Award_Ling(bConfirm)
	bConfirm = bConfirm or 0;

	if 1 ~= bConfirm then
		Say("Trong Thi™n M´n TrÀn Li™n Server, ng≠Íi ch¨i cuËi cÔng Æ∏nh trÛng boss CuÂng T≠Ìng Minh NhÀt, sœ c„ t≠ c∏ch Æ’n chÁ cÒa ta nhÀn 1 Di÷u D≠¨ng L÷nh. (CuÂng T≠Ìng Minh NhÀt chÿ xu t hi÷n trong Thi™n M´n TrÀn cÒa bang hÈi c p 3, ÆÂng thÍi mÁi cÙm server li™n th´ng chÿ xu t hi÷n 1 con boss) Trong Thi™n M´n TrÀn Li™n Server, ng≠Íi ch¨i cuËi cÔng Æ∏nh trÛng boss NgÙy T≠Ìng ∏m Nguy÷t, sœ c„ t≠ c∏ch Æ’n chÁ cÒa ta nhÀn 1 Hπo Nguy÷t L÷nh.",
		2,
		"Ta muËn nhÀn!	/#GLB_BW_Award_Ling(1)",
		"K’t thÛc ÆËi thoπi	/nothing");
		return
	end

	local nYYL	= gf_GetTaskByte(TASKID_TMZ_BOSS, 1);
	local nHYL	= gf_GetTaskByte(TASKID_TMZ_BOSS, 2);

	if 0 == nYYL and 0 == nHYL then
		Talk(1, "", "Bπn kh´ng th” nhÀn Di÷u D≠¨ng L÷nh ho∆c Hπo Nguy÷t L÷nh.");
		return 0;
	end

	if 1 ~= gf_JudgeRoomWeight(2, 100, "") then
		return 0;
	end

	if 0 < nYYL then
		gf_SetLogCaption("ßÊi Di÷u D≠¨ng L÷nh");
		gf_AddItemEx({2, 95, 742, nYYL, 1, -1, -1, -1, -1, -1, -1}, "Di÷u D≠¨ng L÷nh");
		gf_SetTaskByte(TASKID_TMZ_BOSS, 1, 0);
	end
	if 0 < nHYL then
		gf_SetLogCaption("ßÊi Hπo Nguy÷t L÷nh");
		gf_AddItemEx({2, 95, 743, nHYL, 1, -1, -1, -1, -1, -1, -1}, "Hπo Nguy÷t L÷nh");
		gf_SetTaskByte(TASKID_TMZ_BOSS, 2, 0);
	end
	gf_SetLogCaption("");

	return 1;
end

tBwChangeItem2 = {
	[1]	= {
		szMsg	= "DÔng 999 M∂nh Hπo Nguy÷t sœ ÆÊi Æ≠Óc Hπo Nguy÷t Phi Phong ho∆c Huy Ch≠¨ng, dÔng 999 M∂nh Di÷u D≠¨ng ÆÊi Æ≠Óc Di÷u D≠¨ng Phi Phong ho∆c Huy Ch≠¨ng.",
		tInfo	= { -- “´—ÙÀÈ∆¨°¢©‘¬ÀÈ∆¨°¢“´—Ù¡Ó°¢©‘¬¡Ó°¢ÃÏ√≈ΩŒƒª¢∑˚
			{{999, 0, 0, 0, 0},	0,	{{0, 118, 3, 1, 1, -1, -1, -1, -1, -1, -1}, "Di÷u D≠¨ng H·a V©n Phi Phong (Giao dﬁch)"}},
			{{999, 0, 0, 0, 0},	0,	{{0, 117, 3, 1, 1, -1, -1, -1, -1, -1, -1}, "Di÷u D≠¨ng ThËng Ng˘ L÷nh (Giao dﬁch)"}},
			{{0, 999, 0, 0, 0},	0,	{{0, 118, 2, 1, 1, -1, -1, -1, -1, -1, -1}, "Hπo Nguy÷t C»m ßoπn Phi Phong (Giao dﬁch)"}},
			{{0, 999, 0, 0, 0},	0,	{{0, 117, 2, 1, 1, -1, -1, -1, -1, -1, -1}, "Hπo Nguy÷t ¢n Ngh‹a L÷nh (Giao dﬁch)"}},
		},
	},
	[2]	= {
		szMsg	= "	Tham gia Thi™n M´n TrÀn Li™n Server sœ nhÀn Æ≠Óc Di÷u D≠¨ng L÷nh ho∆c Hπo Nguy÷t L÷nh, dÔng vÀt ph»m Æ„ Æ” Æ’n chÁ cÒa ta ÆÊi Phi Phong ho∆c Huy Ch≠¨ng.",
		tInfo	= { -- “´—ÙÀÈ∆¨°¢©‘¬ÀÈ∆¨°¢“´—Ù¡Ó°¢©‘¬¡Ó°¢ÃÏ√≈ΩŒƒª¢∑˚
			{{0, 0, 1, 0, 800},	5000, {{0, 118, 3, 1, 4, -1, -1, -1, -1, -1, -1}, "Di÷u D≠¨ng H·a V©n Phi Phong (Kh´ng th” giao dﬁch)"}},
			{{0, 0, 1, 0, 800},	5000, {{0, 117, 3, 1, 4, -1, -1, -1, -1, -1, -1}, "Di÷u D≠¨ng ThËng Ng˘ L÷nh (Kh´ng th” giao dﬁch)"}},
			{{0, 0, 0, 1, 200},	1200, {{0, 118, 2, 1, 4, -1, -1, -1, -1, -1, -1}, "Hπo Nguy÷t C»m ßoπn Phi Phong (Kh´ng th” giao dﬁch)"}},
			{{0, 0, 0, 1, 200},	1200, {{0, 117, 2, 1, 4, -1, -1, -1, -1, -1, -1}, "Hπo Nguy÷t ¢n Ngh‹a L÷nh (Kh´ng th” giao dﬁch)"}},
		},
	},
};

g_TempItemName2 = {{"M∂nh Di÷u D≠¨ng", 2, 95, 741}, {"M∂nh Hπo Nguy÷t", 2, 95, 740}, {"Di÷u D≠¨ng L÷nh", 2, 95, 742}, {"Hπo Nguy÷t L÷nh", 2, 95, 743}, {"Thi™n M´n Kim V®n HÊ PhÔ", 2, 100, 45}}

function GLB_BW_ChangeItem2(nIndex)
	if not nIndex then
		return 0;
	end

	local tChange = tBwChangeItem2[nIndex];
	if not tChange then
		return 0;
	end

	local tMenu = {};
	for nElemIdx, tElemInfo in tChange.tInfo do
		local szInfo = "DÔng thŒ";
		for idx, count in tElemInfo[1] do
			if 0 < count then
				szInfo = szInfo .. format("%d %s,", count, g_TempItemName2[idx][1]);
			end
		end
		if 0 < tElemInfo[2] then
			szInfo = szInfo .. format("%d vµng,", tElemInfo[2]);
		end
		szInfo = strsub(szInfo, 1, strlen(szInfo) - 2); -- »•µÙ◊Ó∫Ûµƒ°∞£¨°±∫≈ ªÚ’ﬂ °∞”√°±◊÷
		szInfo = szInfo .. format("ßÊi %s	/#GLB_BW_ConfirmChange2(%d, %d)", tElemInfo[3][2], nIndex, nElemIdx);
		tinsert(tMenu, szInfo);
	end

	tinsert(tMenu, "K’t thÛc ÆËi thoπi	/nothing");

	Say(tChange.szMsg, getn(tMenu), tMenu);
end

function GLB_BW_ConfirmChange2(nIndex, nElemIdx)
	if not nIndex then
		return 0;
	end

	local tChange = tBwChangeItem2[nIndex];
	if not tChange then
		return 0;
	end

	local tElem   = tChange.tInfo[nElemIdx];
	if not tElem then
		return 0;
	end

	for idx, count in tElem[1] do
		if count > GetItemCount(g_TempItemName2[idx][2], g_TempItemName2[idx][3], g_TempItemName2[idx][4]) then
			Talk(1, "", "Mang theo tr™n ng≠Íi" .. g_TempItemName2[idx][1] .. "Kh´ng ÆÒ" .. count .. ".");
			return 0;
		end
	end

	if 1 ~= gf_JudgeRoomWeight(1, 100, "") then
		return 0;
	end

	if 0 < tElem[2] and 1 ~= Pay(tElem[2] * 10000) then
		Talk(1, "", "Vµng tr™n ng≠Íi kh´ng ÆÒ" .. tElem[2] .. " Kim ");
		return 0;
	end

	for idx, count in tElem[1] do
		if 0 < count then
			if 1 ~= DelItem(g_TempItemName2[idx][2], g_TempItemName2[idx][3], g_TempItemName2[idx][4], count) then
				WriteLog(format(" ÆÊi %s [DeleteItem] [Failed] [Acc:%s] [Role:%s] [Item:%sx%d,%d,%d,%d]", tElem[3][2], GetAccount(), GetName(), g_TempItemName2[idx][1], count, g_TempItemName2[idx][2], g_TempItemName2[idx][3], g_TempItemName2[idx][4]));
				return 0;
			end
		end
	end

	gf_SetLogCaption("ßÊi"..tElem[3][2]);
	gf_AddItemEx(tElem[3][1], tElem[3][2]);
	gf_SetLogCaption("");

	Msg2Global(format("Ng≠Íi ch¨i %s Æ∑ ÆÊi 1 %s", GetName(), tElem[3][2]));

	return 1;
end

--ªÒ»°øÁ∑˛ÕÊº“«¯∑˛∫Õ√˚◊÷
function GLB_BW_GetRealmName(strName)
	local aa,bb,strGbGroup,strGbName = strfind(strName,"(.-)*(.*)");
	return strGbGroup,strGbName;
end

tBwGlobalAward = {
	{
		{"ThÛ c≠Ïi chuy™n dÔng cho ßπi HÈi T˚ V‚ ","GLB_BW_AddItemEx({0,105,107,1,1,-1,-1,-1,-1,-1,-1},'Ng©n HÊ',7*24*3600)"},
		{"Danh hi÷u: Vﬂng loπi-Gi∂i Nguy™n","GLB_BW_AddTitle(6,3,'Vﬂng loπi-Gi∂i Nguy™n')"},
	},
	{
		{"ThÛ c≠Ïi chuy™n dÔng cho ßπi HÈi T˚ V‚ ","GLB_BW_AddItemEx({0,105,107,1,1,-1,-1,-1,-1,-1,-1},'Ng©n HÊ',7*24*3600)"},
		{"Danh hi÷u: Vﬂng loπi-∏ Nguy™n","GLB_BW_AddTitle(6,4,'Vﬂng loπi-∏ Nguy™n')"},
	},
	{
		{"ThÛ c≠Ïi chuy™n dÔng cho ßπi HÈi T˚ V‚ ","GLB_BW_AddItemEx({0,105,107,1,1,-1,-1,-1,-1,-1,-1},'Ng©n HÊ',7*24*3600)"},
		{"Danh hi÷u: Vﬂng loπi-HÈi Nguy™n","GLB_BW_AddTitle(6,5,'Vﬂng loπi-HÈi Nguy™n')"},
	},
};

function BWT_GetGlobalAward()
	local nWeekNum = BWT_GetWeekNum();
	if nWeekNum == -1 then	--Relayπ“¡À
		return 0;
	end;
	local nBWRank = GetGlobalBwRank();
	if GetTask(TASK_BIWU_GET_REALM_AWARD) >= nWeekNum then
		Talk(1,"",g_szInfoHead.."Bπn Æ∑ nhÀn ph«n th≠Îng.");
		return 0;
	end;
	if gf_Judge_Room_Weight(4,100,g_szInfoHead) ~= 1 then
		return 0;
	end
	local tbRank = GetBwAllRank(1); --≤Œ ˝1±Ì æ»´∑˛≈≈√˚£¨≤Œ ˝0ªÚ≤ªÃÓ±Ì æ±æ∑˛≈≈√˚°£
	if tbRank == nil or getn(tbRank) == 0 then
		return 0;
	end
	local strName = GetName();
	local strGbGroup,strGbName = "","";
	local strCurGroup = GetRelayGroup();
	local nSelfRank,nBestRank = 0,0;
	local strShowName = "";
	for i=1,getn(tGsName) do
		if tGsName[i][1] == strCurGroup then
			strCurGroup = tGsName[i][2];
			break;
		end
	end
	for i=1,getn(tbRank) do
		strGbGroup,strGbName = GLB_BW_GetRealmName(tbRank[i].Name);
		if strGbName == strName then
			nSelfRank = i;
		end
		if strGbGroup == strCurGroup then
			strShowName = strShowName..","..strGbName;
			if nBestRank == 0 then
				nBestRank = i;
			end
		end
	end
	BWDH_SetTask(TASK_BIWU_GET_REALM_AWARD,nWeekNum);
	if nSelfRank ~= 0 and nSelfRank <= 3 then
		for i = 1,getn(tBwGlobalAward[nBWRank]) do
			dostring(tBwGlobalAward[nBWRank][i][2]);
		end
	end
	local tbRankAward = {{1,{2,0,109,3},"BÂng Lai Ti™n LÈ"},{10,{2,0,109,2},"BÂng Lai Ti™n LÈ"},{20,{2,0,109,1},"BÂng Lai Ti™n LÈ"},};
	if nBestRank > 20 or nBestRank == 0 then
		Talk(1,"",g_szInfoHead.."Tu«n tr≠Ìc server kh´ng c„ cao thÒ nhÀn Æ≠Óc t∏n th≠Îng cÒa tri“u Æ◊nh, mong c∏c vﬁ h∑y ti’p tÙc cË gæng.");
		return 0
	end
	for i = 1,getn(tbRankAward) do
		if nBestRank <= tbRankAward[i][1] then
			gf_AddItemEx(tbRankAward[i][2],tbRankAward[i][3]);
			Msg2Global("Do "..strShowName.."Trong ßπi HÈi T˚ V‚ bi”u hi÷n v≠Ót trÈi, ng≠Íi ch¨i trong server c„ th” nhÀn ph«n th≠Îng ["..tbRankAward[i][3].."].");
			break;
		end
	end
end

--∞—±‰¡ø÷µ–¥»Îπ≤œÌ ˝æ›ø‚
function GLB_BW_SetTask(nkey1,nkey2,tb)
	local strGbGroup,strName = GLB_BW_GetRealmName(GetName());
	strName = "Realm_"..strName;
	local TbList = {};
	local TbListTemp = {};
	local nNum = 16;
	local nItemKey = 0;
	local strItemKey = "";
	local strFormat = "";
	if nkey1 == 0 and nkey2 == 1 then --π∆ ¶
		local tb_gushi = {};
		for k,v in tb do
			local nValue = GetTask(v);
			strFormat = strFormat.."d";
			tinsert(tb_gushi,nValue);
		end
		AddRelayShareDataToSourceRealm(strName,nkey1,nkey2,g_ThisFile,"GLB_BW_ST_Nothing",0,"GS",strFormat,gf_UnPack(tb_gushi));
	elseif nkey1 == 0 and nkey2 == 0  then
		for i = 1,getn(tb) do
			tinsert(TbList,tb[i]);
			tinsert(TbList,GetTask(tb[i]));
		end
		nItemKey = ceil(getn(TbList)/nNum);
		for i = 1,nItemKey do
			local strFormat = ""
			TbListTemp[i] = {};
			for j = (i-1)*nNum+1,min(getn(TbList),nNum*i) do
				strFormat = strFormat.."d";
				tinsert(TbListTemp[i],TbList[j]);
			end
			strItemKey = "BW"..tostring(i);
			AddRelayShareDataToSourceRealm(strName,nkey1,nkey2,g_ThisFile,"GLB_BW_ST_Nothing",0,strItemKey,strFormat,gf_UnPack(TbListTemp[i]));
		end
--	elseif nkey1 == 0 and nkey2 == 2 then --Â–“£±“µƒœ˚∫ƒ
--		AddRelayShareDataToSourceRealm(strName,nkey1,nkey2,g_ThisFile,"GLB_BW_ST_Nothing",0,"XYB","d",GetTask(TASKID_XOYO_CONSUME));
--	elseif nkey1 == 0 and nkey2 == 3 then --Â–“£”Òµƒœ˚∫ƒ
--		AddRelayShareDataToSourceRealm(strName,nkey1,nkey2,g_ThisFile,"GLB_BW_ST_Nothing",0,"XYY","d",GetTask(TASKID_XOYOYU_CONSUME));
	end
end

function GLB_BW_ST_Nothing()

end

function GLB_BW_AddItemEx(tbItem,strName,nTime)
	nTime = nTime or 0;
	gf_SetLogCaption("ßπi HÈi T˚ V‚-Ph«n th≠Îng server");
	local nRet,nIdx = gf_AddItemEx(tbItem,strName);
	if nTime ~= 0 and nIdx ~= 0 then
		SetItemExpireTime(nIdx,nTime);
	end
	gf_SetLogCaption("")
end

function GLB_BW_AddTitle(nID1,nID2,strName)
	for i=3,5 do
		RemoveTitle(6,i);
	end
	if IsTitleExist(nID1,nID2) <= 0 then
		if AddTitle(nID1,nID2) > 0 then
			SetTitleTime(nID1,nID2, GetTime() + 7*24*3600);
			SetCurTitle(nID1,nID2)
			Msg2Player("Bπn nhÀn Æ≠Óc ["..strName.."] danh hi÷u");
			WriteLog("[ßπi HÈi T˚ V‚-Ph«n th≠Îng server]:"..GetName().." nhÀn Æ≠Óc ["..strName.."] danh hi÷u");
		end
	end
end

function GLB_BW_LEAVE(nCityID, nPIdx)
	nPIdx = nPIdx or PlayerIndex;
	local nOldPIdx = PlayerIndex;
	PlayerIndex = nPIdx;

	local nVersion,nCurGs = GetRealmType();
	UseScrollEnable(1);	--‘ –Ì π”√ªÿ≥«∑˚
	SetLogoutRV(0);
	UseMask(0,0);
--	if nCurGs == 0 then
--		NewWorld(nCityID,TB_EXIT[nCityID][1],TB_EXIT[nCityID][2]);
--	else
--		ChangeGroupWorld(nCityID,TB_EXIT[nCityID][1],TB_EXIT[nCityID][2],0);
--	end
	BWDH_Change_Map(nCityID,TB_EXIT_CITY[nCityID][1],TB_EXIT_CITY[nCityID][2])

	PlayerIndex = nOldPIdx;
end

function OnWant(nPIdx,nOppIdx)
	local nOldPIdx = PlayerIndex;
	PlayerIndex = nPIdx;
	local nCheckMapCode1,nCheckMapCode2 = 0,0;
	local nCheckTag = 0;

	BWDH_SetTask(TSK_OPPNAME_HASH,0);
	BWDH_SetTask(TSK_OPPNAME_HASH,0,nOppIdx);
	nCheckMapCode1 = BWT_CheckValidMap();
	nCheckMapCode2 = BWT_CheckValidMap(nOppIdx);
	if nCheckMapCode1 == 0 then	--1∫≈—° ÷ºÏ≤È√ªÕ®π˝
		gf_ShowMsg("Kh≠Ìc tı t˚ v‚ (kh´ng c„ trong b∂n ÆÂ quy Æﬁnh), trı 2 Æi”m! Bπn Æ∑ rÍi kh·i so tµi.");
		BWT_AddPoint(-2)
		nCheckTag = 1;	--±Ì æ”–»À√ªÕ®π˝ºÏ≤È
	end;
	if nCheckMapCode2 == 0 then	--2∫≈—° ÷ºÏ≤È√ªÕ®π˝
		if nCheckTag == 0 then	--»Áπ˚1∫≈ºÏ≤ÈÕ®π˝¡À
			gf_ShowMsg("ßËi thÒ kh≠Ìc tı t˚ v‚!");	--∏¯1∫≈∑¢œ˚œ¢
		end;
		gf_ShowMsg("Kh≠Ìc tı t˚ v‚ (kh´ng c„ trong b∂n ÆÂ quy Æﬁnh), trı 2 Æi”m! Bπn Æ∑ rÍi kh·i so tµi.",1,nOppIdx);
		BWT_AddPoint(-2,nOppIdx)
		nCheckTag = 1;
	else	--»Áπ˚2∫≈—° ÷ºÏ≤ÈÕ®π˝
		if nCheckTag == 1 then	--2∫≈Õ®π˝£¨1∫≈√ªÕ®π˝
			gf_ShowMsg("ßËi thÒ kh≠Ìc tı t˚ v‚!",1,nOppIdx);	--∏¯2∫≈∑¢œ˚œ¢
		end;
	end;
	if nCheckTag == 1 then	--»Áπ˚”–»À√ªÕ®π˝ºÏ≤È
		PlayerIndex = nOldPIdx;
		return 0;
	end;
	if BWT_OpenMatch(PlayerIndex,nOppIdx) == 0 then
		gf_ShowMsg("Tπm thÍi kh´ng c„ khu thi Æ u d≠ ra");
		BWT_JoinGestConvention();
		BWT_JoinGestConvention(nOppIdx);
		gf_ShowMsg("Tπm thÍi kh´ng c„ khu thi Æ u d≠ ra",1,nOppIdx);
	end;
	PlayerIndex = nOldPIdx;
end

function GLB_BW_Get_Block_Route()
	local tRoute		= gf_GetRouteTable();
	local tBlockRoute	= {};

	for i, nRoute in tRoute do
		if 1 == gf_GetTaskBit(TASKID_BIWU_BLOCK_ROUTE, i) then
			tinsert(tBlockRoute, nRoute);
		end
		if MAXNUM_BLOCK_ROUTE <= getn(tBlockRoute) then
			break
		end
	end

	tBlockRoute.n = nil;

	return tBlockRoute;
end

function GLB_BW_Block_Route_Check(nRoute)
	local tRoute		= gf_GetRouteTable();
	local nRet = 1;
	for i,k in tRoute do
		if k == nRoute then
			if gf_GetTaskBit(TASKID_BIWU_BLOCK_ROUTE, i) == 1 then
				nRet = 0;
			end
			break;
		end
	end
	return nRet;
end

function GLB_BW_Block_Route_Check_Ex(nPIdx1, nPIdx2)
	local nRet		= 0;
	local nOldPIdx	= 0;
	local nRoute1	= GetPlayerRoute(nPIdx1);
	local nRoute2	= GetPlayerRoute(nPIdx2);

	if nRoute1 == nRoute2 then
		return 1;
	end

	nOldPIdx	= PlayerIndex;
	PlayerIndex	= nPIdx1;
	nRet		= GLB_BW_Block_Route_Check(nRoute2);
	PlayerIndex	= nOldPIdx;

	if 0 == nRet then
		return 0;
	end

	nOldPIdx	= PlayerIndex;
	PlayerIndex	= nPIdx2;
	nRet		= GLB_BW_Block_Route_Check(nRoute1);
	PlayerIndex	= nOldPIdx;

	return nRet;
end

function GLB_BW_Block_Route_Cost(nPIdx)
--	nPIdx1 = nPIdx1 or PlayerIndex;
--
--	local nOldPIdx	= PlayerIndex;
--	PlayerIndex		= nPIdx;
--	local tRoute	= GLB_BW_Get_Block_Route();
--	if getn(tRoute) > 0 then
--		PayXYY(TB_BW_BLOCK_ROUTE_COST[getn(tRoute)], format("BLOCK_ROUTE[%d]", getn(tRoute)));
--	end
--	PlayerIndex		= nOldPIdx;
end

function WLZB_AddPoint()
	local nData = tonumber(date("%Y%m%d"));
	if nData < 20110428 or nData > 20110519 then
		return
	end
	local s = SDB("_GL_GestConvention_Jiaoyi_w", 1, GetPlayerRoute());
	s:apply("\\script\\biwudahui\\tournament\\mission\\mission.lua", "WLZB_AddPoint_CB");
end

function WLZB_AddPoint_CB(key, n1, n2, nCount)
	local nData = tonumber(date("%Y%m%d"));
	if nData < 20110428 or nData > 20110519 then
		return
	end
	local t = SDB("_GL_GestConvention_Jiaoyi_w", n1, n2);
	local point = getBound(t, nCount) + 20;
	Msg2Player(format("Bπn nhÀn Æ≠Óc %d Æi”m V‚ L©m Tranh B∏!", point));
	point = point + GetTask(TASKID_WLZB_POINT);
	BWDH_SetTask(TASKID_WLZB_POINT, point);
	--GLB_BW_SetTask(0,0,tRelayTask);
	exgsvr_func_save_player_task()--œÚ‘¥∑˛¥Ê≈Ã

	--SendGlbDBData(1, format('DELETE FROM `wlzb_auditions` WHERE `name`="%s";', name));
	--format('UPDATE `wlzb_auditions` SET `point`=%d WHERE `name`="%s";', point, name);
	SendGlbDBData(0, format('REPLACE INTO `wlzb_auditions` VALUES ("%s", "%s", %d, %d, "%s");',
		GetName(), tRouteName[GetPlayerRoute()], GetLevel(), point, GetRelayGroup()));
end

function getBound(t,nCount)
	if not t then
		return 0
	end
	local myname = GetName();
	for i = 0, min(nCount, 20) do
		local l = t[i];
		if l[1] == myname then
			return 20 - i;
		end
	end
	return 0;
end

function WLZB_DecPoint()
	local nData = tonumber(date("%Y%m%d"));
	if nData < 20110428 or nData > 20110519 then
		return
	end
	local lastPoint = GetTask(TASKID_WLZB_POINT);
	local point = min(lastPoint, max(10, floor(lastPoint * 0.03)));
	if point <= 0 then return end
	Msg2Player(format("Bπn tÊn th t %d Æi”m V‚ L©m Tranh B∏!", point));
	point = GetTask(TASKID_WLZB_POINT) - point;
	BWDH_SetTask(TASKID_WLZB_POINT, point);
	--GLB_BW_SetTask(0,0,tRelayTask);
	exgsvr_func_save_player_task()--œÚ‘¥∑˛¥Ê≈Ã

	--SendGlbDBData(1, format('DELETE FROM `wlzb_auditions` WHERE `name`="%s";', name));
	--format('UPDATE `wlzb_auditions` SET `point`=%d WHERE `name`="%s";', point, name);
	SendGlbDBData(0, format('REPLACE INTO `wlzb_auditions` VALUES ("%s", "%s", %d, %d, "%s");',
		GetName(), tRouteName[GetPlayerRoute()], GetLevel(), point, GetRelayGroup()));
end

function BWDH_Change_Map(nMapId, nMapX, nMapY, nRule)
	if BWDH_OPEN_IN_MATCH_FIELD and BWDH_OPEN_IN_MATCH_FIELD == 1 then
		ChangeGroupWorld(nMapId, nMapX, nMapY)
	else
		NewWorld(nMapId, nMapX, nMapY)
	end
end
