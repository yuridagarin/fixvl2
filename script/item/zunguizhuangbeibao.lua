--×ğ¹ó×°±¸°ü½Å±¾
--by vivi
--2008/04/21

--ÔªË§×°±¸
tYuanshuai = {
	{{"Tèng nguyªn so¸i ®Çu kh«i",0,103,2251},
	{"Tèng nguyªn so¸i chiÕn bµo",0,100,2251},
	{"Tèng nguyªn so¸i chiÕn phôc",0,101,2251},
	{"Tèng nguyªn so¸i hæ phï",0,102,2301},
	{"Tèng nguyªn so¸i lÖnh kú",0,102,2305},
	{"Tèng so¸i phï",0,102,2501},
	{"Tèng so¸i kú",0,102,2505}},
	{{"Liªu nguyªn so¸i ®Çu kh«i",0,103,2255},
	{"Liªu nguyªn so¸i chiÕn bµo",0,100,2255},
	{"Liªu nguyªn so¸i chiÕn phôc",0,101,2255},
	{"Liªu nguyªn so¸i hæ phï",0,102,2311},
	{"Liªu nguyªn so¸i lÖnh kú",0,102,2315},
	{"Liªu so¸i phï",0,102,2511},
	{"Liªu so¸i kú",0,102,2515}}
}

--µÚ3Ì×Ê¦ÃÅ×°±¸Ãû×Ö ps£ºÆäÊµÃ»ÓÃµ½Õâ¸ö±í-_-|£¬²»¹ıÕâÃ´ĞÁ¿àĞ´ÁË¾Í·ÅÕâ£¬ÒÔºóËµ²»¶¨ÓÃµÃ×Å
fe_tbFactionEquipExTHreeName = 
{
	[0] = {},
	[1] = {},	
	[2] = 
		{	--ÉÙÁÖË×¼Ò
			[3] = {"Phôc Ma Kim Cang chiÕn kh«i","ChiÕn ı kh¶i gi¸p","ChiÕn ı phôc","Phôc Ma Kim Cang ChiÕn ı Bµn ChØ","Phôc Ma Kim Cang ChiÕn ı Giíi ChØ","§¹t Ma Kim Cang_ChiÕn ı C«n (§ao)"},
		},
	[3] = 
		{	--ÉÙÁÖìøÉ®
			[3] = {"ThiÒn TŞnh m·o","ThiÒn TŞnh bµo","ThiÒn TŞnh phôc","TruyÒn Kinh ThiÒn TŞnh Bµn ChØ","TruyÒn Kinh ThiÒn TŞnh Ngäc Giíi ChØ","TruyÒn Kinh  ThiÒn TŞnh Tr­îng"},
		},
	[4] = 
		{	--ÉÙÁÖÎäÉ®
			[3] = {"Hé Ph¸p La H¸n kh«i","La H¸n Hé Ph¸p_ §Êu Khİ Kh¶i Gi¸p","§Êu Khİ phôc","Hé Ph¸p La H¸n §Êu Khİ Bµn ChØ","Hé Ph¸p La H¸n §Êu Khİ Giíi ChØ","Hé Ph¸p La H¸n_§Êu Khİ Thñ"},
		},
	[5] = {},			--ÌÆÃÅ
	[6] = 
		{	--ÌÆÃÅ
			[3] = {"Bİ §éc §Çu C©n","Bİ §éc y","Bİ §éc trang","Bİ §éc Béi","Bİ §éc ChØ Hoµn","Bİ ®éc Ch©m"},
		},
	[7] = {},			--¶ëáÒ
	[8] = 
		{	--¶ëáÒ·ğ¼Ò
			[3] = {"Ph¸p V©n KÕ","Ph¸p V©n y","Ph¸p V©n Trang","Tö Tróc Sø Ph¸p V©n Giíi","Tö Tróc Sø Ph¸p V©n Giíi","Tö Tróc Sø Ph¸p V©n KiÕm"},
		},
	[9] = 
		{	--¶ëáÒË×¼Ò
			[3] = {"Ph¸p ¢m KÕ","Ph¸p ¢m y","Ph¸p ¢m Trang","H¶i NguyÖt Sø Ph¸p ¢m Ngäc Giíi ChØ","H¶i NguyÖt Sø Ph¸p ¢m Thóy Giíi ChØ","H¶i NguyÖt Sø Ph¸p ¢m CÇm"},
		},
	[10] = {},			--Ø¤°ï
	[11] = 
		{	--Ø¤°ï¾»ÒÂ
			[3] = {"Tø H¶i c©n","Tø H¶i y","Hµo Khİ phôc","Tø H¶i HiÖp Hµo Khİ Ngäc Béi","Tø H¶i HiÖp Hµo Khİ Giíi ChØ","Tø H¶i Y phôc"},
		},
	[12] = 
		{	--Ø¤°ïÎÛÒÂ
			[3] = {"Tô NghÜa c©n","B¸t §¹i §Ö Tö_Tô NghÜa Y","Tô NghÜa phôc","B¸t §¹i §Ö Tö Tô NghÜa Ngäc Béi","B¸t §¹i §Ö Tö Tô NghÜa Giíi ChØ","B¸t §¹i §Ö Tö_Tô NghÜa C«n"},
		},
	[13] = {},			--Îäµ±
	[14] = 
		{	--Îäµ±µÀ¼Ò
			[3] = {"Tø T­îng c©n","Tø T­îng ph¸p bµo","Tø T­îng phôc","V« Ng· Tø T­îng Giíi ChØ","V« Ng· Tø T­îng ChØ Hoµn","Tø T­îng Ph¸p KiÕm"},
		},
	[15] = 
		{	--Îäµ±Ë×¼Ò
			[3] = {"Linh Phong c©n","Linh Phong Phôc","Linh Phong phôc","Nhµn V©n HiÖp §¹o Linh Phong ChØ","Nhµn V©n HiÖp §¹o Linh Phong Hoµn","Linh Phong Bót"},
		},
	[16] = {},			--ÑîÃÅ
	[17] = 
		{	--ÑîÃÅÇ¹Æï
			[3] = {"Long T­¬ng t­íng qu©n_Ngao Khİ Kh«i","Tinh Kh¶i gi¸p","TŞnh Gi¸p phôc","PhÊn Vâ Hæ Phï","PhÊn Vâ LÖnh Kú","ThÊu Gi¸p Th­¬ng"},
		},
	[18] = 
		{	--ÑîÃÅ¹­Æï
			[3] = {"Tinh Gi¸p kh«i","PhÊn Uy T­íng Qu©n kh¶i gi¸p","Tinh Gi¸p phôc","PhÊn Uy Hæ Phï","PhÊn Uy LÖnh Kú","Xuyªn Gi¸p cung"},
		},
	[19] = {},			--Îå¶¾
	[20] = 
		{	--Îå¶¾Ğ°ÏÀ
			[3] = {"H¾c V« Th­êng M¶nh §éc §Çu C©n","H¾c V« Th­êng M·nh §éc y","H¾c V« Th­êng M·nh §éc","H¾c V« Th­êng M·nh §éc HuyÕt Béi","M·nh §éc H¾c Hoµn","H¾c V« Th­êng M·nh §éc ®ao"},
		},
	[21] = 
		{	--Îå¶¾¹ÆÊ¦
			[3] = {"B¹ch V« Th­êng Quû §éc §Çu C©n","B¹ch V« Th­êng Ngôy §éc Y","B¹ch V« Th­êng Ngôy §éc","Quû §éc HuyÕt Béi","Quû §éc H¾c Hoµn","B¹ch V« Th­êng Quû §éc Tr¶o"},
		},
}

function OnUse(nItemIdx)
	if GetTask(545) ~= 0 then
		Talk(1,"","Ng­¬i ®· dïng bao nµy, mçi nh©n vËt chØ cã thÓ sö dông 1 lÇn.");
		return
	end
	local strtab = {
		"Ta muèn nhËn trang bŞ nguyªn so¸i §¹i Tèng (§¹i Liªu)/#zg_give_item("..nItemIdx..",1)",
		"Ta muèn nhËn trang bŞ cao cÊp S­ M«n/#zg_give_item("..nItemIdx..",2)",
		"Ta muèn nhËn trang bŞ trung cÊp S­ M«n/#zg_give_item("..nItemIdx..",3)",
		"T¹m thêi ch­a l·nh, ®îi ta ®ñ ®iÒu kiÖn míi l·nh."
	};
	Say("Vâ L©m TruyÒn Kú 2 tÆng quµ ®Æc biÖt, chØ cÇn ®ñ ®iÒu kiÖn th× cã thÓ nhËn trang bŞ. <color=red>Chó ı: Mçi nh©n vËt chØ cã thÓ nhËn 1 trang bŞ. VËt phÈm nµy cã hiÖu lùc kÓ tõ ngµy 28 th¸ng 12 n¨m 2008.<color>",
		getn(strtab),
		strtab);
end

function zg_give_item(nItemIdx,nType)
	if nType == 1 then
		if GetTask(704) ~= 6 and GetTask(704) ~= -6 then
			Talk(1,"","Xin lçi, vËt nµy chØ cã nguyªn so¸i §¹i Tèng hoÆc §¹i Liªu míi nhËn ®­îc, khi nµo ®ñ ®iÒu kiÖn th× h½n ®Õn. <color=red>Tham gia chiÕn tr­êng cã thÓ trë thµnh nguyªn so¸i, cô thÓ vµ thuéc tİnh trang bŞ vui lßng tham kh¶o h­íng dÉn.<color>");
			return
		else
			if GetTask(704) == 6 then
				Say("HiÖn giê b¹n lµ nguyªn so¸i §¹i Tèng, rÊt vui ®­îc tÆng b¹n trang bŞ nguyªn so¸i miÔn phİ, b¹n ®ång ı chø?",
					2,
					"§ång ı/#zg_confirm_give_item("..nItemIdx..","..nType..")",
					"T¹m thêi kh«ng cÇn/nothing");
			elseif GetTask(704) == -6 then
				Say("HiÖn giê b¹n lµ nguyªn so¸i §¹i Liªu, rÊt vui ®­îc tÆng b¹n trang bŞ nguyªn so¸i miÔn phİ, b¹n ®ång ı chø?",
					2,
					"§ång ı/#zg_confirm_give_item("..nItemIdx..","..nType..")",
					"T¹m thêi kh«ng cÇn/nothing");
			end
		end
	elseif nType == 2 then
		if GetTask(336) < 4000 then
			Talk(1,"","Xin lçi, vËt nµy chØ cã ng­êi cã ®iÓm cèng hiÕn S­ M«n trªn 4000 míi cã thÓ nhËn ®­îc, khi nµo ®ñ ®iÒu kiÖn th× h½n ®Õn. <color=red>Hoµn thµnh nhiÖm vô S­ M«n tuÇn hoµn cã thÓ nhËn ®­îc ®iÓm cèng hiÕn s­ m«n, cô thÓ cã thÓ hái Ch­ëng M«n. Thuéc tİnh trang bŞ cã thÓ hái ë cöa hiÖu m«n ph¸i.<color>");
			return
		else
			local nRoute = GetPlayerRoute();
			if nRoute == 0 or nRoute == 1 or nRoute == 5 or nRoute == 7 or nRoute == 10 or nRoute == 13 or nRoute == 16 or nRoute == 19 then
				Talk(1,"","Xin lçi, vËt nµy ph¶i gia nhËp l­u ph¸i míi cã thÓ l·nh nhËn, khi nµo ®ñ ®iÒu kiÖn h½n ®Õn.");
				return
			else		
				Say("§iÓm cèng hiÕn S­ M«n hiÖn giê cña b¹n ®· ®¹t ®Õn 4000, rÊt vui ®­îc tÆng b¹n bé trang, b¹n ®ång ı chø?",
					2,
					"§ång ı/#zg_confirm_give_item("..nItemIdx..","..nType..")",
					"T¹m thêi kh«ng cÇn/nothing");
			end
		end
	elseif nType == 3 then
		local nRoute = GetPlayerRoute();
		if nRoute == 0 or nRoute == 1 or nRoute == 5 or nRoute == 7 or nRoute == 10 or nRoute == 13 or nRoute == 16 or nRoute == 19 then
			Talk(1,"","Xin lçi, vËt nµy ph¶i gia nhËp l­u ph¸i míi cã thÓ l·nh nhËn, khi nµo ®ñ ®iÒu kiÖn h½n ®Õn.");
			return
		else
			Say("B¹n sÏ nhËn ®­îc bé trang bŞ S­ M«n lôc 2 do chóng t«i tÆng, mÆc vµo sÏ ®­îc céng 300 ®iÓm cèng hiÕn S­ M«n, nh­ng b¹n cÇn ph¶i ®¹t ®Õn <color=red>cÊp 50<color> míi cã thÓ sö dông, b¹n ®ång ı chø?",
				2,
				"§ång ı/#zg_confirm_give_item("..nItemIdx..","..nType..")",
				"T¹m thêi kh«ng cÇn/nothing");
		end
	end
end

function zg_confirm_give_item(nItemIdx,nType)
	if Zgc_pub_goods_add_chk(6,600) ~= 1 then
		return
	end
	if DelItemByIndex(nItemIdx,1) == 1 then
		if nType == 1 then
			local nBody = GetBody();
			if GetTask(704) == 6 then
				SetTask(545,1);
				AddItem(tYuanshuai[1][1][2],tYuanshuai[1][1][3],tYuanshuai[1][1][4]+nBody-1,1,4,-1,-1,-1,-1,-1,-1);
				AddItem(tYuanshuai[1][2][2],tYuanshuai[1][2][3],tYuanshuai[1][2][4]+nBody-1,1,4,-1,-1,-1,-1,-1,-1);
				AddItem(tYuanshuai[1][3][2],tYuanshuai[1][3][3],tYuanshuai[1][3][4]+nBody-1,1,4,-1,-1,-1,-1,-1,-1);
				local nRand = random(4,7);
				AddItem(tYuanshuai[1][nRand][2],tYuanshuai[1][nRand][3],tYuanshuai[1][nRand][4]+nBody-1,1,4,-1,-1,-1,-1,-1,-1);
				nRand = randomx(4,7,nRand);
				AddItem(tYuanshuai[1][nRand][2],tYuanshuai[1][nRand][3],tYuanshuai[1][nRand][4]+nBody-1,1,4,-1,-1,-1,-1,-1,-1);
				WriteLog("[Tói trang bŞ T«n Quı]:"..GetName().."NhËn trang bŞ nguyªn so¸i Tèng. Tµi kho¶n:"..GetAccount());
			elseif GetTask(704) == -6 then
				SetTask(545,1);
				AddItem(tYuanshuai[2][1][2],tYuanshuai[2][1][3],tYuanshuai[2][1][4]+nBody-1,1,4,-1,-1,-1,-1,-1,-1);
				AddItem(tYuanshuai[2][2][2],tYuanshuai[2][2][3],tYuanshuai[2][2][4]+nBody-1,1,4,-1,-1,-1,-1,-1,-1);
				AddItem(tYuanshuai[2][3][2],tYuanshuai[2][3][3],tYuanshuai[2][3][4]+nBody-1,1,4,-1,-1,-1,-1,-1,-1);
				local nRand = random(4,7);
				AddItem(tYuanshuai[2][nRand][2],tYuanshuai[2][nRand][3],tYuanshuai[2][nRand][4]+nBody-1,1,4,-1,-1,-1,-1,-1,-1);
				nRand = randomx(4,7,nRand);
				AddItem(tYuanshuai[2][nRand][2],tYuanshuai[2][nRand][3],tYuanshuai[2][nRand][4]+nBody-1,1,4,-1,-1,-1,-1,-1,-1);		
				WriteLog("[Tói trang bŞ T«n Quı]:"..GetName().."NhËn trang bŞ nguyªn so¸i Liªu. Tµi kho¶n:"..GetAccount());
			end		
		elseif nType == 2 then
			if GetTask(336) >= 4000 then
				local nRoute = GetPlayerRoute();
				local nBody = GetBody();
				if nRoute ~= 0 and nRoute ~= 1 and nRoute ~= 5 and nRoute ~= 7 and nRoute ~= 10 and nRoute ~= 13 and nRoute ~= 16 and nRoute ~= 19 then
					SetTask(545,1);
					fe_AddFactionEquipmentTHree(nRoute,nBody,3);
					WriteLog("[Tói trang bŞ T«n Quı]:"..GetName().."NhËn trang bŞ S­ M«n 3. Tµi kho¶n:"..GetAccount());
				end
			end
		elseif nType == 3 then
			local nRoute = GetPlayerRoute();
			local nBody = GetBody();
			if nRoute ~= 0 and nRoute ~= 1 and nRoute ~= 5 and nRoute ~= 7 and nRoute ~= 10 and nRoute ~= 13 and nRoute ~= 16 and nRoute ~= 19 then		
				SetTask(545,1);
				SetTask(336,GetTask(336)+300);
				Msg2Player("B¹n ®­îc 300 ®iÓm cèng hiÕn S­ M«n");
				fe_AddFactionEquipmentTHree(nRoute,nBody,2);
				WriteLog("[Tói trang bŞ T«n Quı]:"..GetName().."NhËn trang bŞ S­ M«n 2. Tµi kho¶n:"..GetAccount());				
			end
		end
	end
end

--¸øµÚ2¡¢3Ì×Ê¦ÃÅ×°±¸£¬½äÖ¸IDÓĞÎÊÌâ£¬²»ÊÊÓÃÓÚµÚ4¡¢5Ì×
--nRoute£ºÂ·Ïß
--nBody£ºÌåĞÎ
--nGeneration£ºÖ¸Ã÷ÎªµÚ¼¸Ì×
--nSpecFlag£º×¨ÎªÉÙÁÖË×¼ÒÁôµÄÌØÊâ±ê¼Ç¡£0Îª¸øµ¶ºÍ¹÷£¬1¸ø¹÷£¬2¸øµ¶
--ĞÂÓÃº¯ÊıÖ÷ÒªÔ­ÒòÔÚÓÚÕâÀï¸øµÄµÚ3Ì×Ê¦ÃÅÉèÖÃÎª°î¶¨×°±¸£¬¼´AddItemµÚ4¸ö²ÎÊıÌîÎª4¡£
function fe_AddFactionEquipmentTHree(nRoute,nBody,nGeneration,nSpecFlag)
	nSpecFlag = nSpecFlag or 0;
	local nID2,nID3 = 0,0;
	local tbWeaponID2 = {nil,5,8,0,nil,1,nil,2,10,nil,0,5,nil,2,9,nil,6,4,nil,7,11};
	if nRoute == 8 or nRoute == 9 then	--¶ëáÒÌØÊâ´¦Àí
		nID3 = nRoute*100+(nGeneration-1)*10+nBody-2;
	else
		nID3 = nRoute*100+(nGeneration-1)*10+nBody;
	end;
	AddItem(0,103,nID3,1,4,-1,-1,-1,-1,-1,-1);
	AddItem(0,100,nID3,1,4,-1,-1,-1,-1,-1,-1);
	AddItem(0,101,nID3,1,4,-1,-1,-1,-1,-1,-1);
	AddItem(0,102,nID3,1,4,-1,-1,-1,-1,-1,-1);
	if nRoute == 2 then	--¸ÃËÀµÄÉÙÁÖË×¼Ò
		if nSpecFlag == 0 or nSpecFlag == 1 then
			AddItem(0,5,nID3,1,4,-1,-1,-1,-1,-1,-1);
		end;
		if nSpecFlag == 0 or nSpecFlag == 2 then
			AddItem(0,3,nID3,1,4,-1,-1,-1,-1,-1,-1);
		end;
	else
		nID2 = tbWeaponID2[nRoute];
		if nID2 ~= nil then
			AddItem(0,nID2,nID3,1,4,-1,-1,-1,-1,-1,-1);
		end;
	end;
	if nGeneration >= 3 then	--µÚÈıÌ×¿ªÊ¼²ÅÓĞ2¸ö½äÖ¸
		--ÁíÒ»¸ö½äÖ¸		
		if nRoute == 2 or nRoute == 3 or nRoute == 4 or nRoute == 8 or nRoute == 9 then
			nID3 = nID3 + 2;
		else
			nID3 = nID3 + 4;
		end	
			AddItem(0,102,nID3,1,4,-1,-1,-1,-1,-1,-1);	
	end
	WriteLog("[Tói trang bŞ T«n Quı]:"..GetName().."Më tói trang bŞ T«n Quı ®­îc trang bŞ S­ M«n 3. nSpecFlag: "..nSpecFlag);
end;

function nothing()

end;

function Zgc_pub_goods_add_chk(goods_num,goods_weight)
		if GetFreeItemRoom() < goods_num then
			Talk (1,"","<color=red>kho¶ng trèng<color> trong hµnh trang kh«ng ®ñ!")
			return 0
		elseif (GetMaxItemWeight() - GetCurItemWeight()) < goods_weight then			--ÅĞ¶ÏÍæ¼Ò¸ºÖØºÍ¿Õ¼ä
			Talk (1,"","<color=red>Søc lùc<color> cña b¹n kh«ng ®ñ!")
			return 0
		else 
			return 1
		end
end

function randomx(a,b,c)
	local r = random(a,b-1);
	if r < c then
		return r;
	else
		return r+1;
	end
end