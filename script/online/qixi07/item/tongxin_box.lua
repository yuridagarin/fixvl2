--Í¬ĞÄÏ»½Å±¾
--by vivi
--08/02/2007

--ÁÙÊ±±äÁ¿
TT_TONGXIN_ATTRI = 185; --¼ÇÂ¼µÚÒ»ÌõÊôĞÔ

--ÊôĞÔÒ»ÁĞ±í
tAttriOne = {
	{"T¨ng ngo¹i c«ng 6%",368,4},
	{"T¨ng Néi c«ng 6%",369,4},
	{"T¨ng tæn th­¬ng 78",372,5},
	{"TiÕp tôc kĞo dµi thêi gian c«ng kİch hç trî 30%",41,6},
	{"KĞo dµi thêi gian hç trî phßng ngù 30%",42,6}
	}

--ÊôĞÔ¶şºÍÊôĞÔÈıÁĞ±í
tAttriTwo = {--ÊôĞÔÃû  ÊôĞÔid  lv1-lv7µÄ¸ÅÂÊ		
	{"Ngo¹i kİch + ",368,0,0,35,70,100,0,0},
	{"Néi kİch t¨ng ",369,0,0,35,70,100,0,0},
	{"S¸t th­¬ng t¨ng ",372,0,0,35,70,100,0,0},
	{"TÊn c«ng kÌm ®éc s¸t",363,20,40,60,80,100,0,0},
	{"Ph¸ phßng thñ ®èi ph­¬ng",362,0,0,0,0,100,0,0},
	{"TÊn c«ng t¨ng ",77,0,0,35,70,100,0,0},
	{"Ph¸t huy c«ng kİch lín nhÊt",346,0,0,35,70,100,0,0},
	{"Tû lÖ ®¸nh ph¹m vi",335,0,0,35,70,100,0,0},
	{"Vò khİ ®¸nh ngo¹i lín nhÊt t¨ng ",65,0,0,35,70,100,0,0},
	{"Vò khİ ®¸nh ngo¹i thÊp nhÊt t¨ng ",66,0,0,35,70,100,0,0},
	{"Vò khİ ®¸nh néi lín nhÊt t¨ng",67,0,0,35,70,100,0,0},
	{"Vò khİ ®¸nh néi thÊp nhÊt t¨ng ",68,0,0,35,70,100,0,0},
	{"TÊn c«ng lµm søc m¹nh ®èi ph­¬ng gi¶m",348,0,0,35,70,100,0,0},
	{"TÊn c«ng lµm g©n cèt ®èi ph­¬ng gi¶m",349,0,0,35,70,100,0,0},
	{"TÊn c«ng lµm néi c«ng ®èi ph­¬ng gi¶m",350,0,0,35,70,100,0,0},
	{"KhiÕn ®èi ph­¬ng gi¶m Linh ho¹t ",351,0,0,35,70,100,0,0},
	{"TÊn c«ng lµm th©n ph¸p ®èi ph­¬ng gi¶m",352,0,0,35,70,100,0,0},
	{"TÊn c«ng lµm phßng ngo¹i ®èi ph­¬ng gi¶m",353,0,0,35,70,100,0,0},
	{"TÊn c«ng lµm gi¶m néi phßng ®èi ph­¬ng",354,0,0,35,70,100,0,0},
	{"Tû lÖ nhÊt ®Şnh lµm ®èi ph­¬ng khİ huyÕt hao tæn",53,0,0,0,0,50,100,0},
	{"Tû lÖ nhÊt ®Şnh lµm ®èi ph­¬ng ch©n nguyªn hao tæn",54,0,0,0,0,50,100,0},
	{"C«ng kİch khiÕn ngo¹i phßng cña ®èi ph­¬ng gi¶m",382,20,40,60,80,100,0,0},
	{"C«ng kİch khiÕn néi lùc cña ®èi ph­¬ng gi¶m ",383,20,40,60,80,100,0,0},
	{"TÊn c«ng lµm ®èi ph­¬ng hao tæn néi lùc",49,0,0,0,0,100,0,0},
	{"H¹ gôc ®èi ph­¬ng sinh lùc håi phôc ",333,0,0,35,70,100,0,0},
	{"Tû lÖ mµi mßn vò khİ gi¶m",9,0,0,35,70,100,0,0},
	{"§¸nh tËp trung t¨ng",342,0,0,35,70,100,0,0},
	{"Chİnh x¸c t¨ng",337,0,0,35,70,100,0,0},
	{"G©n cèt t¨ng",357,0,0,35,70,100,0,0},
	{"Søc m¹ng t¨ng",58,0,0,35,70,100,0,0},
	{"Th©n ph¸p t¨ng",59,0,0,35,70,100,0,0},
	{"Linh ho¹t t¨ng",60,0,0,35,70,100,0,0},
	{"Néi c«ng t¨ng ",61,0,0,35,70,100,0,0},
	{"Hç trî tÊn c«ng  duy tr× ",41,20,40,60,80,90,100,0},
	{"Hç trî phßng thñ duy tr× ",42,20,40,60,80,90,100,0},
	{"TÊt c¶ thuéc tİnh t¨ng",367,0,0,50,100,0,0,0}
	}

--76¼¶ÎäÆ÷table£¬ĞòºÅ¶ÔÓ¦Íæ¼ÒÂ·Ïß
tWeapon = {
	[2]= {"Cæ §İnh",0,3,64,200},
	[3]= {"A La H¸n Tr­îng",0,8,97,100},
	[4]= {"V¹n NhÉn",0,0,14,220},
	[6]= {"M·n Thiªn Hoa Vò",0,1,53,130},	
	[8]= {"Háa Tinh",0,2,36,90},	
	[9]= {"Hi Nh©n CÇm",0,10,75,140},
	[11]= {"V¹n NhÉn",0,0,14,220},
	[12]= {"LiÖt DiÖm",0,5,40,200},
	[14]= {"Háa Tinh",0,2,36,90},	
	[15]= {"ThÇn Hµnh",0,9,86,130},	
	[17]= {"§¹i Hµo L«i Th­¬ng",0,6,108,130},	
	[18]= {"ThÇn Cung",0,4,119,130},
	[20]= {"L¨ng Phong",0,7,12,200},
	[21]= {"M·nh hæ",0,11,12,200},
	};

--¸øËæ»ú76¼¶ÎäÆ÷table
tRandomW = {
	[1]= {"Cæ §İnh",0,3,64,200},
	[2]= {"A La H¸n Tr­îng",0,8,97,100},
	[3]= {"V¹n NhÉn",0,0,14,220},
	[4]= {"M·n Thiªn Hoa Vò",0,1,53,130},	
	[5]= {"Háa Tinh",0,2,36,90},	
	[6]= {"Hi Nh©n CÇm",0,10,75,140},
	[7]= {"V¹n NhÉn",0,0,14,220},
	[8]= {"LiÖt DiÖm",0,5,40,200},
	[9]= {"Háa Tinh",0,2,36,90},	
	[10]= {"ThÇn Hµnh",0,9,86,130},	
	[11]= {"§¹i Hµo L«i Th­¬ng",0,6,108,130},	
	[12]= {"ThÇn Cung",0,4,119,130},
	[13]= {"L¨ng Phong",0,7,12,200},
	[14]= {"M·nh hæ",0,11,12,200},
	};

function GetPlayerSex()	
	local mySex -- ÓÃÒÔÏÔÊ¾ÈËÎïĞÔ±ğµÄ×Ö·û
	if (GetSex() == 1) then
		mySex = "ThiÕu hiÖp";
	elseif (GetSex() == 2) then
		mySex = "C« n­¬ng";
	end;
	return mySex;
end

--º¯ÊıÃû³Æ£ºÎïÆ·Ìí¼Ó¼ì²éº¯Êı
--¹¦        ÄÜ£º¶Ôµ±Ç°Íæ¼Ò¿É·ñÕı³£Ìí¼ÓÎïÆ·½øĞĞ¼ì²â
--´å³¤ 
function Zgc_pub_goods_add_chk(goods_num,goods_weight)
		if GetFreeItemRoom() < goods_num then
			Talk (1,"cancel","<color=red>kho¶ng trèng<color> trong hµnh trang kh«ng ®ñ!")
			return 0
		elseif (GetMaxItemWeight() - GetCurItemWeight()) < goods_weight then			--ÅĞ¶ÏÍæ¼Ò¸ºÖØºÍ¿Õ¼ä
			Talk (1,"cancel","<color=red>Søc lùc<color> cña b¹n kh«ng ®ñ!")
			return 0
		else 
			return 1
		end
end	

function OnUse()
	local strtab = {
		"Thuéc tİnh ThÇn Binh 1 /choose_attri",
		"¸i cha, thÇn binh v« chñ, ch­a thÓ giao hép ra./nothing"
		}
	Say("<color=green>Hép §ång t©m<color>: trªn viÕt r»ng 'nÕu cã t×nh nh©n ı hîp t©m ®Çu, chuyÖn g× còng cã thÓ v­ît qua', b¹n h·y chän mét sè ph­¬ng h­íng ph¸t triÓn trong hép nµy. Chó ı, thuéc tİnh hµng thø nhÊt cña ph­¬ng h­íng ph¸t triÓn nµy do "..GetPlayerSex().." chØ ®Şnh, thuéc tİnh hµng thø hai vµ thø ba tuú ı ®­a ra.",getn(strtab),strtab);
end

function choose_attri()
	local strtab = {};
	for i=1,getn(tAttriOne) do
		tinsert(strtab,tAttriOne[i][1].."/#confirm_attri("..i..")");
	end
	tinsert(strtab,"§Ó ta suy nghÜ mét l¸t, sau ®ã sÏ më hép/nothing");
	Say("<color=green>Hép §ång t©m<color>:"..GetPlayerSex().."Hy väng xuÊt hiÖn thuéc tİnh thÇn binh hµng thø nhÊt lµ",getn(strtab),strtab);
end

function confirm_attri(nAttri)
	local strtab = {
		"Ta chän xong råi, ®­a Hép thÇn binh ra ®©y/give_weapon",		
		"Ta muèn kiÓm tra xem thuéc tİnh thÇn binh hµng thø 2 vµ thø 3 lµ g×/#attri_list(0)",
		"Trêi, thÇn binh v« chñ, hay lµ ®Ó sau nµy h½ng më!/cancel"
		}
	SetTaskTemp(TT_TONGXIN_ATTRI,nAttri);
	Say("<color=green>Hép §ång t©m<color>:"..GetPlayerSex().."Chän thuèc tİnh thø nhÊt lµ <color=yellow>"..tAttriOne[nAttri][1].."<color>. B¹n muèn thÇn binh ra khái hép kh«ng?",getn(strtab),strtab);
end

function attri_list(nPage)
	local page_num = 7;   --Ã¿Ò³¶Ô»°ÏÔÊ¾µÄÊôĞÔÊı 
	local dia_attri = {};  --ÏÔÊ¾¶Ô»°±í
	local attri_remain_num = getn(tAttriTwo) - (nPage*page_num);	--ÕâÒ»Ò³ºó»¹Ê£ÏÂ¶àÉÙÌõÊôĞÔÊı
	local num_this_dia = 7;
	if attri_remain_num <= 7 then
		num_this_dia = attri_remain_num;
	end	
	for i=1,num_this_dia do
		tinsert(dia_attri,tAttriTwo[(nPage*page_num)+i][1].."/#confirm_attri("..GetTaskTemp(TT_TONGXIN_ATTRI)..")");
	end
	if nPage ~= 0 then
		tinsert(dia_attri,"Trang tr­íc/#attri_list("..(nPage-1)..")");
	end
	if attri_remain_num > page_num then
		tinsert(dia_attri,"Trang kÕ/#attri_list("..(nPage+1)..")");
	end
		tinsert(dia_attri,"trë l¹i/#confirm_attri("..GetTaskTemp(TT_TONGXIN_ATTRI)..")");
		
	Say("<color=green>Hép §ång t©m<color>: thuéc tİnh thÇn binh hµng thø 2 vµ thø 3 cã thÓ xuÊt hiÖn lµ",
		getn(dia_attri),
		dia_attri);
end

function give_weapon()
	if Zgc_pub_goods_add_chk(1,220) ~= 1 then   --¿Õ¼ä¸ºÖØ¼ì²â È¡×îÖØÎäÆ÷
		return
	end	
	local attri_one = GetTaskTemp(TT_TONGXIN_ATTRI);
	local two_ran = random(1,getn(tAttriTwo)); --Ëæ»úÊôĞÔ
	local three_ran = random(1,getn(tAttriTwo));	
	if DelItem(2,1,1153,1) == 1 then			
		if tAttriTwo[two_ran][2] == tAttriOne[attri_one][2] then --µÚ2ÏîÊôĞÔÊÇ·ñ¸úµÚÒ»ÏîÏàµÈ
			local x = random(1,100);
			if x > 50 then															--50%¸ÅÂÊ³É¹¦	
				two_ran = randomx(1,getn(tAttriTwo),two_ran);  --Ã»random³É¹¦ÏàÍ¬ÊôĞÔÔòÖØĞÂrandomÒ»´Î£¬µ±È»³ıÈ¥µ±Ç°ÊôĞÔ
			end
		end                                         
		--3ÊôĞÔ¶¼ÏàÍ¬
		if tAttriTwo[three_ran][2] == tAttriOne[attri_one][2] and tAttriTwo[two_ran][2] == tAttriOne[attri_one][2] then --µÚ3ÏîÊôĞÔÒ²ÏàµÈ
			local y = random(1,100);
			if y > 20 then															--20%¸ÅÂÊ³É¹¦
				three_ran = randomx(1,getn(tAttriTwo),three_ran);  
			end
		end
		--µÚ3ÊôĞÔÓëµÚ2ÊôĞÔÏàÍ¬»òÕßÓëµÚ1ÊôĞÔÏàÍ¬£¬Ç°ÌáÊÇµÚ2ÊôĞÔºÍµÚ1ÊôĞÔ¶¼²»Í¬
		if tAttriTwo[two_ran][2] ~= tAttriOne[attri_one][2] then
			if tAttriTwo[three_ran][2] == tAttriOne[attri_one][2] or tAttriTwo[three_ran][2] == tAttriTwo[two_ran][2] then			
				local m = random(1,100);
				if m > 50 then
					three_ran = randomx(1,getn(tAttriTwo),three_ran);
				end
			end
		end		
			get_weapon(two_ran,three_ran); --¸øÓèÎäÆ÷
	end
end

function get_weapon(aTwo,aThree)
	local aOne = GetTaskTemp(TT_TONGXIN_ATTRI);	
	local nroute = 0; --¼ÇÂ¼Íæ¼ÒµÄÂ·Ïß
	local nlv = random(1,100);									--Ëæ»úÄ§·¨µÈ¼¶		                  
	local mlv = random(1,100);				          		
	local ilv = 3;															--¼ÇÂ¼Ä§·¨µÈ¼¶£¬³õÊ¼Îª±íµÄµÚÈı¸öÎ»ÖÃ
	local jlv = 3;
	for i=3,9	do
		if nlv <= tAttriTwo[aTwo][i] then
			ilv=i;
			break;
		end
	end
	for j=3,9 do
		if jlv <= tAttriTwo[aThree][j] then
			jlv=j;
			break;
		end
	end			

	if GetPlayerRoute() == 0 or GetPlayerRoute() == 1 or GetPlayerRoute() == 5 or GetPlayerRoute() == 7 or GetPlayerRoute() == 10 or GetPlayerRoute() == 13 or GetPlayerRoute() == 16 or GetPlayerRoute() == 19 then 
		local p = random(1,14); --¸øËæ»úÎäÆ÷
		local add_flog = AddItem(tRandomW[p][2],tRandomW[p][3],tRandomW[p][4],1,1,tAttriOne[aOne][3],tAttriOne[aOne][2],ilv-2,tAttriTwo[aTwo][2],jlv-2,tAttriTwo[aThree][2]);
		if add_flog == 1 then
			Msg2Player("B¹n më Hép §ång t©m, nhËn ®­îc 1 thÇn binh");
			SetTaskTemp(TT_TONGXIN_ATTRI,0);
		else
			WriteLog("Hép §ång t©m: ng­êi ch¬i"..GetName().."NhËn ThÇn binh thÊt b¹i, vŞ trİ thÊt b¹i: "..add_flog);
		end
	else
		nroute = GetPlayerRoute();
		local add_flog = AddItem(tWeapon[nroute][2],tWeapon[nroute][3],tWeapon[nroute][4],1,1,tAttriOne[aOne][3],tAttriOne[aOne][2],ilv-2,tAttriTwo[aTwo][2],jlv-2,tAttriTwo[aThree][2]);
		if add_flog == 1 then
			Msg2Player("B¹n më Hép §ång t©m, nhËn ®­îc 1 thÇn binh");
			SetTaskTemp(TT_TONGXIN_ATTRI,0);
		else
			WriteLog("Hép §ång t©m: ng­êi ch¬i"..GetName().."NhËn ThÇn binh thÊt b¹i, vŞ trİ thÊt b¹i: "..add_flog);
		end
	end
end

function randomx(a,b,c)
	local r = random(a,b-1);
	if r < c then
		return r;
	else
		return r+1;
	end
end

function cancel()
	SetTaskTemp(TT_TONGXIN_ATTRI,0);
end

function nothing()
end