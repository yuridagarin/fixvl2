Include("\\script\\vng\\lib\\vnglib_award.lua");
szNpcName = "<color=green>Häc trß thî rÌn L­u: <color>"
tbThuongUngNguyenSoai = {
	[1] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Gi¸p",{0,100,3024},{0,100,30037,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[2] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Trang",{0,101,3024},{0,101,30037,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[3] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Kh«i",{0,103,3024},{0,103,30037,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[4] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Hæ",{0,102,3056},{0,102,30064,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[5] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i LÖnh",{0,102,3060},{0,102,30068,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[6] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Phï",{0,102,3064},{0,102,30072,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[7] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Kú",{0,102,3068},{0,102,30076,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	
	[8] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Gi¸p",{0,100,3025},{0,100,30038,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[9] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Trang",{0,101,3025},{0,101,30038,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[10] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Kh«i",{0,103,3025},{0,103,30038,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[11] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Hæ",{0,102,3057},{0,102,30065,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[12] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i LÖnh",{0,102,3061},{0,102,30069,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[13] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Phï",{0,102,3065},{0,102,30073,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[14] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Kú",{0,102,3069},{0,102,30077,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	
	[15] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Gi¸p",{0,100,3026},{0,100,30039,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[16] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Trang",{0,101,3026},{0,101,30039,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[17] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Kh«i",{0,103,3026},{0,103,30039,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[18] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Hæ",{0,102,3058},{0,102,30066,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[19] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i LÖnh",{0,102,3062},{0,102,30070,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[20] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Phï",{0,102,3066},{0,102,30074,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[21] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Kú",{0,102,3070},{0,102,30078,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	
	[22] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Gi¸p",{0,100,3027},{0,100,30040,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[23] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Trang",{0,101,3027},{0,101,30040,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[24] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Kh«i",{0,103,3027},{0,103,30040,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[25] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Hæ",{0,102,3059},{0,102,30067,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[26] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i LÖnh",{0,102,3063},{0,102,30071,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[27] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Phï",{0,102,3067},{0,102,30075,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[28] = {"Th­¬ng ¦ng Tèng Nguyªn So¸i Kú",{0,102,3071},{0,102,30079,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	
	[29] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Gi¸p",{0,100,3028},{0,100,30049,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[30] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Trang",{0,101,3028},{0,101,30049,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[31] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Kh«i",{0,103,3028},{0,103,30049,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[32] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Hæ",{0,102,3072},{0,102,30100,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[33] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i LÖnh",{0,102,3076},{0,102,30104,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[34] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Phï",{0,102,3080},{0,102,30108,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[35] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Kú",{0,102,3084},{0,102,30112,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	
	[36] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Gi¸p",{0,100,3029},{0,100,30050,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[37] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Trang",{0,101,3029},{0,101,30050,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[38] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Kh«i",{0,103,3029},{0,103,30050,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[39] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Hæ",{0,102,3073},{0,102,30101,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[40] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i LÖnh",{0,102,3077},{0,102,30105,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[41] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Phï",{0,102,3081},{0,102,30109,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[42] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Kú",{0,102,3085},{0,102,30113,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	
	[43] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Gi¸p",{0,100,3030},{0,100,30051,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[44] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Trang",{0,101,3030},{0,101,30051,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[45] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Kh«i",{0,103,3030},{0,103,30051,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[46] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Hæ",{0,102,3074},{0,102,30102,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[47] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i LÖnh",{0,102,3078},{0,102,30106,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[48] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Phï",{0,102,3082},{0,102,30110,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[49] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Kú",{0,102,3086},{0,102,30114,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	
	[50] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Gi¸p",{0,100,3031},{0,100,30052,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[51] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Trang",{0,101,3031},{0,101,30052,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[52] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Kh«i",{0,103,3031},{0,103,30052,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[53] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Hæ",{0,102,3075},{0,102,30103,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[54] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i LÖnh",{0,102,3079},{0,102,30107,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[55] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Phï",{0,102,3083},{0,102,30111,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[56] = {"Th­¬ng ¦ng Liªu Nguyªn So¸i Kú",{0,102,3087},{0,102,30115,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
}

tbPunish1 = {item={{gdp={2,1,504,1}, name = "N÷ Oa Tinh Th¹ch"}}}
tbPunish2 = {item={{gdp={2,1,30229,1}, name = "B¹ch Kim Hång Bao"}}}

function OnPutinCheck(param, idx, genre, detail, particular)
	local tbItemPutin = {"§¹i Tèng-Liªu Nguyªn So¸i", {{0,100,3024},{0,101,3024},{0,103,3024},{0,102,3056},{0,102,3060},{0,102,3064},{0,102,3068},{0,100,3025},{0,101,3025},{0,103,3025},{0,102,3057},{0,102,3061},{0,102,3065},{0,102,3069},{0,100,3026},{0,101,3026},{0,103,3026},{0,102,3058},{0,102,3062},{0,102,3066},{0,102,3070},{0,100,3027},{0,101,3027},{0,103,3027},{0,102,3059},{0,102,3063},{0,102,3067},{0,102,3071},{0,100,3028},{0,101,3028},{0,103,3028},{0,102,3072},{0,102,3076},{0,102,3080},{0,102,3084},{0,100,3029},{0,101,3029},{0,103,3029},{0,102,3073},{0,102,3077},{0,102,3081},{0,102,3085},{0,100,3030},{0,101,3030},{0,103,3030},{0,102,3074},{0,102,3078},{0,102,3082},{0,102,3086},{0,100,3031},{0,101,3031},{0,103,3031},{0,102,3075},{0,102,3079},{0,102,3083},{0,102,3087}}}
	local nItemAllow = 0
	local tbCheckList = GetPutinItem();
	for i=1,getn(tbItemPutin[2]) do
		if tbItemPutin[2][i][1] == genre and tbItemPutin[2][i][2] == detail and tbItemPutin[2][i][3] == particular then
			nItemAllow = 1
			break
		end
	end
	if nItemAllow == 0 then
		Talk(1,"",szNpcName .. "ChØ cã thÓ ®Æt vµo trang bÞ " .. tbItemPutin[1])
		return 0
	end
	if GetEquipAttr(idx,2) < 13 and (genre == 0 and detail ~= 102) then
		Talk(1,"",szNpcName .. "Trang bÞ ph¶i ®­îc c­êng hãa 13 trë lªn.")
		return 0
	end
	return 1
end


function OnPutinComplete(param)
	if gf_JudgeRoomWeight(2,500) == 0 then
		Talk(1,"",szNpcName.."Hµnh trang hoÆc søc lùc kh«ng ®ñ, ng­¬i h·y s¾p xÕp l¹i nhÐ!");
		return 0
	end
	local tbUpgradeList = GetPutinItem();
	local nGold = 10000000
	local nBKHongbao = 15
	local nNuOa = 4
	if tbUpgradeList[1][3] == 102 then
		nGold = 20000000
		nBKHongbao = 20
		nNuOa = 6
	end
	
	local tbRate = {
		[1] = {[1] = 1, nRate = 01.00},
		[2] = {[1] = 2, nRate = 49.50},
		[3] = {[1] = 3, nRate = 49.50},
	}
	if tbUpgradeList[1][3] == 103 or  tbUpgradeList[1][3] == 101 or (tbUpgradeList[1][3] == 102 and ((tbUpgradeList[1][4] >= 3064 and tbUpgradeList[1][4] <= 3067) or (tbUpgradeList[1][4] >= 3080 and tbUpgradeList[1][4] <= 3083))) then
		tbRate = {
			[1] = {[1] = 1, nRate = 06.00},
			[2] = {[1] = 2, nRate = 47.00},
			[3] = {[1] = 3, nRate = 47.00},
		}
	end
		
	if GetCash() < nGold then
		Talk(1,"",szNpcName.."C¸c h¹ kh«ng ®ñ l­îng vµng ta cÇn.");
		return 0
	end	
	if GetItemCount(2,1,30229) < nBKHongbao then
		Talk(1,"",szNpcName.."C¸c h¹ kh«ng cã ®ñ sè l­îng B¹ch Kim Hång Bao ta cÇn.")
		return 0
	end
	if GetItemCount(2,1,504) < nNuOa then
		Talk(1,"",szNpcName.."C¸c h¹ kh«ng cã ®ñ sè l­îng N÷ Oa Tinh Th¹ch ta cÇn.")
		return 0
	end
	
	LIB_Award.szLogTitle = "NANG CAP THUONG UNG NGUYEN SOAI"
	LIB_Award.szLogAction = "thµnh c«ng"
	
	local tbAward = {}
	for i=1,getn(tbThuongUngNguyenSoai) do
		if (tbThuongUngNguyenSoai[i][2][1] == tbUpgradeList[1][2]) and (tbThuongUngNguyenSoai[i][2][2] == tbUpgradeList[1][3]) and (tbThuongUngNguyenSoai[i][2][3] == tbUpgradeList[1][4]) then
			tbAward = {item={{gdp=tbThuongUngNguyenSoai[i][3], name = tbThuongUngNguyenSoai[i][1]}}}
			nOption = LIB_Award:GetValueByRate(tbRate)
			if nOption == 1 then
				if DelItem(2,1,30229,nBKHongbao) == 1 and DelItem(2,1,504,nNuOa) == 1 and Pay(nGold) == 1 then
					DelItemByIndex(tbUpgradeList[1][1],-1)
					LIB_Award:Award(tbAward)
					Talk(1,"",szNpcName.."N©ng cÊp thµnh c«ng, " .. tbThuongUngNguyenSoai[i][1] .. " nµy lµ cña c¸c h¹.")
				else
					Talk(1,"",szNpcName.."C¸c h¹ kh«ng ®ñ vËt phÈm yªu cÇu, kh«ng thÓ tiÕn hµnh n©ng cÊp.")
				end
			elseif nOption == 2 then
				LIB_Award:Punish(tbPunish1)
				Pay(nGold)
				Talk(1,"",szNpcName.."N©ng cÊp thÊt b¹i, h·y thö l¹i lÇn n÷a...")
			else
				LIB_Award:Punish(tbPunish2)
				Pay(nGold)
				Talk(1,"",szNpcName.."N©ng cÊp thÊt b¹i, h·y thö l¹i lÇn n÷a...")
			end
			break
		end
	end
	return 1
end
