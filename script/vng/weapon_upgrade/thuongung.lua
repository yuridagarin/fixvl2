Include("\\script\\vng\\lib\\vnglib_award.lua");
szNpcName = "<color=green>Häc trß thî rÌn L­u: <color>"
tbThuongUngTuongQuan = {
	[1] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Gi¸p",{0,100,30017},{0,100,30033,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[2] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Trang",{0,101,30017},{0,101,30033,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[3] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Kh«i",{0,103,30017},{0,103,30033,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[4] = {"Tèng Th­¬ng ¦ng T­íng Qu©n LÖnh",{0,102,30013},{0,102,30052,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[5] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Kú",{0,102,30017},{0,102,30056,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[6] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Phï",{0,102,30021},{0,102,30060,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[7] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Gi¸p",{0,100,30018},{0,100,30034,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[8] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Trang",{0,101,30018},{0,101,30034,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[9] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Kh«i",{0,103,30018},{0,103,30034,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[10] = {"Tèng Th­¬ng ¦ng T­íng Qu©n LÖnh",{0,102,30014},{0,102,30053,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[11] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Kú",{0,102,30018},{0,102,30057,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[12] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Phï",{0,102,30022},{0,102,30061,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[13] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Gi¸p",{0,100,30019},{0,100,30035,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[14] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Trang",{0,101,30019},{0,101,30035,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[15] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Kh«i",{0,103,30019},{0,103,30035,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[16] = {"Tèng Th­¬ng ¦ng T­íng Qu©n LÖnh",{0,102,30015},{0,102,30054,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[17] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Kú",{0,102,30019},{0,102,30058,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[18] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Phï",{0,102,30023},{0,102,30062,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[19] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Gi¸p",{0,100,30020},{0,100,30036,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[20] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Trang",{0,101,30020},{0,101,30036,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[21] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Kh«i",{0,103,30020},{0,103,30036,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[22] = {"Tèng Th­¬ng ¦ng T­íng Qu©n LÖnh",{0,102,30016},{0,102,30055,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[23] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Kú",{0,102,30020},{0,102,30059,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[24] = {"Tèng Th­¬ng ¦ng T­íng Qu©n Phï",{0,102,30024},{0,102,30063,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[25] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Gi¸p",{0,100,30021},{0,100,30045,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[26] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Trang",{0,101,30021},{0,101,30045,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[27] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Kh«i",{0,103,30021},{0,103,30045,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[28] = {"Liªu Th­¬ng ¦ng T­íng Qu©n LÖnh",{0,102,30025},{0,102,30088,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[29] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Kú",{0,102,30029},{0,102,30092,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[30] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Phï",{0,102,30033},{0,102,30096,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[31] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Gi¸p",{0,100,30022},{0,100,30046,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[32] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Trang",{0,101,30022},{0,101,30046,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[33] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Kh«i",{0,103,30022},{0,103,30046,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[34] = {"Liªu Th­¬ng ¦ng T­íng Qu©n LÖnh",{0,102,30026},{0,102,30089,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[35] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Kú",{0,102,30030},{0,102,30093,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[36] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Phï",{0,102,30034},{0,102,30097,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[37] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Gi¸p",{0,100,30023},{0,100,30047,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[38] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Trang",{0,101,30023},{0,101,30047,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[39] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Kh«i",{0,103,30023},{0,103,30047,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[40] = {"Liªu Th­¬ng ¦ng T­íng Qu©n LÖnh",{0,102,30027},{0,102,30090,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[41] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Kú",{0,102,30031},{0,102,30094,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[42] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Phï",{0,102,30035},{0,102,30098,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[43] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Gi¸p",{0,100,30024},{0,100,30048,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[44] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Trang",{0,101,30024},{0,101,30048,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[45] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Kh«i",{0,103,30024},{0,103,30048,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[46] = {"Liªu Th­¬ng ¦ng T­íng Qu©n LÖnh",{0,102,30028},{0,102,30091,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[47] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Kú",{0,102,30032},{0,102,30095,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
	[48] = {"Liªu Th­¬ng ¦ng T­íng Qu©n Phï",{0,102,30036},{0,102,30099,1,1,-1,-1,-1,-1,-1,-1,-1,0}},
}

tbPunish1 = {item={{gdp={2,1,504,1}, name = "N÷ Oa Tinh Th¹ch"}}}
tbPunish2 = {item={{gdp={2,1,539,1}, name = "Hoµng Kim Hång Bao"}}}

function OnPutinCheck(param, idx, genre, detail, particular)
	local tbItemAllow = {
		[100] = {
			[30017] = 1, [30018] = 1, [30019] = 1, [30020] = 1, [30021] = 1, [30022] = 1, [30023] = 1, [30024] = 1,
		},
		[101] = {
			[30017] = 1, [30018] = 1, [30019] = 1, [30020] = 1, [30021] = 1, [30022] = 1, [30023] = 1, [30024] = 1,
		},
		[103] = {
			[30017] = 1, [30018] = 1, [30019] = 1, [30020] = 1, [30021] = 1, [30022] = 1, [30023] = 1, [30024] = 1,
		},
		[102] = {
			[30013] = 1, [30017] = 1, [30021] = 1, [30014] = 1, [30018] = 1, [30022] = 1, [30015] = 1, [30019] = 1,
			[30023] = 1, [30016] = 1, [30020] = 1, [30024] = 1, [30025] = 1, [30029] = 1, [30033] = 1, [30026] = 1,
			[30030] = 1, [30034] = 1, [30027] = 1, [30031] = 1, [30035] = 1, [30028] = 1, [30032] = 1, [30036] = 1,
		},
	}
	if genre ~= 0 or tbItemAllow[detail][particular] ~= 1 then
		Talk(1,"",szNpcName .. "ChØ cã thÓ ®Æt vµo trang bÞ Ngù Long T­íng Qu©n.")
		return 0
	end
	
	if GetEquipAttr(idx,2) < 10 and detail ~= 102 then
		Talk(1,"",szNpcName .. "Trang bÞ ph¶i ®­îc c­êng hãa 10 trë lªn.")
		return 0
	end
	return 1
end


function OnPutinComplete(param)
	local tbNguyenLieu = {
		[100] = {8, 3, 300}, -- {nu oa, hoang kim hong bao, vang}
		[101] = {8, 3, 300},
		[103] = {8, 3, 300},
		[102] = {10, 10, 600},
	}
	
	if gf_JudgeRoomWeight(2,500) == 0 then
		Talk(1,"",szNpcName.."Hµnh trang hoÆc søc lùc kh«ng ®ñ, ng­¬i h·y s¾p xÕp l¹i nhÐ!");
		return 0
	end
	
	local tbUpgradeList = GetPutinItem();
	if getn(tbUpgradeList) < 1 then
		return 0
	end
	
	local tbItem = tbUpgradeList[1]
	
	if GetItemCount(2,1,504) < tbNguyenLieu[tbItem[3]][1] then
		Talk(1,"",szNpcName.."C¸c h¹ kh«ng cã ®ñ "..tbNguyenLieu[tbItem[3]][1].." N÷ Oa Tinh Th¹ch.")
		return 0
	end
	
	if GetItemCount(2,1,539) < tbNguyenLieu[tbItem[3]][2] then
		Talk(1,"",szNpcName.."C¸c h¹ kh«ng cã ®ñ "..tbNguyenLieu[tbItem[3]][2].." Hoµng Kim Hång Bao.")
		return 0
	end
	
	if GetCash() < tbNguyenLieu[tbItem[3]][3]*10000 then
		Talk(1,"",szNpcName.."C¸c h¹ kh«ng cã ®ñ "..tbNguyenLieu[tbItem[3]][3].." vµng.");
		return 0
	end

	--DoWait(26,27,5)
	LIB_Award.szLogTitle = "NANG CAP THUONG UNG TUONG QUAN"
	LIB_Award.szLogAction = "thµnh c«ng"
	local tbRate = {
		[1] = {[1] = 1, nRate = 2.00},
		[2] = {[1] = 2, nRate = 49.00},
		[3] = {[1] = 3, nRate = 49.00},
	}
	if tbItem[3] == 102 then
		tbRate = {
			[1] = {[1] = 1, nRate = 8.00},
			[2] = {[1] = 2, nRate = 46.00},
			[3] = {[1] = 3, nRate = 46.00},
		}	
	elseif tbItem[3] == 100 then
		tbRate = {
			[1] = {[1] = 1, nRate = 4.44},
			[2] = {[1] = 2, nRate = 47.78},
			[3] = {[1] = 3, nRate = 47.78},
		}	
	end
	
	local tbAward = {}
	for i=1,getn(tbThuongUngTuongQuan) do
		if (tbThuongUngTuongQuan[i][2][1] == tbUpgradeList[1][2]) and (tbThuongUngTuongQuan[i][2][2] == tbUpgradeList[1][3]) and (tbThuongUngTuongQuan[i][2][3] == tbUpgradeList[1][4]) then
			tbAward = {item={{gdp=tbThuongUngTuongQuan[i][3], name = tbThuongUngTuongQuan[i][1]}}}
			nOption = LIB_Award:GetValueByRate(tbRate)
			if nOption == 1 then
				if DelItem(2,1,504,tbNguyenLieu[tbItem[3]][1]) == 1 and DelItem(2,1,539,tbNguyenLieu[tbItem[3]][2]) == 1 and Pay(tbNguyenLieu[tbItem[3]][3]*10000) == 1 then
					DelItemByIndex(tbUpgradeList[1][1],-1)
					LIB_Award:Award(tbAward)
					Talk(1,"",szNpcName.."N©ng cÊp thµnh c«ng, " .. tbThuongUngTuongQuan[i][1] .. " nµy lµ cña c¸c h¹.")
				else
					Talk(1,"",szNpcName.."C¸c h¹ kh«ng ®ñ vËt phÈm yªu cÇu, kh«ng thÓ tiÕn hµnh n©ng cÊp.")
				end
			elseif nOption == 2 then
				LIB_Award:Punish(tbPunish1)
				Pay(tbNguyenLieu[tbItem[3]][3]*10000)
				Talk(1,"",szNpcName.."N©ng cÊp thÊt b¹i, h·y thö l¹i lÇn n÷a...")
			else
				LIB_Award:Punish(tbPunish2)
				Pay(tbNguyenLieu[tbItem[3]][3]*10000)
				Talk(1,"",szNpcName.."N©ng cÊp thÊt b¹i, h·y thö l¹i lÇn n÷a...")
			end
			break
		end
	end
	return 1
end
