-----------------------------------------------------------------------
-- ╫ёоюгИт╣ II й╕цехннЯ
-- 2006/05/16
-- Created by Tony(Jizheng)
-----------------------------------------------------------------------

-- ╠М╦Янд╪ЧюЮ╣дж╖Ёжрт╪╟╣ьм╪лЬв╙╣дж╖Ёж
Include("\\script\\task\\random\\task_gotoworld.lua");
-- ╩т╩мж╝р╧м╥нд╪Ч
Include("\\script\\shinynight_head.lua");
Include("\\script\\lib\\lingshi_head.lua");
--2006дЙй╔╣╝╫з╩Н╤╞╫╠юЬж╖Ёж
Include("\\script\\online\\zgc_temp_fun.lua")
--2007дЙй╔╣╝╩Н╤╞
Include("\\script\\online\\newyear08\\newyear08_head.lua");
--2009дЙ6тб7тб╩Н╤╞
Include("\\script\\online\\viet_event\\200907\\event_head.lua");
--т╫до09дЙ7тб╩Н╤╞©╙╧ьм╥нд╪Ч
Include("\\script\\online\\viet_event\\200907\\eventopen.lua");
Include("\\script\\lib\\writelog.lua");
--2009дЙ8тб╩Н╤╞
Include("\\script\\online\\viet_event\\200908\\viet0908_head.lua");
--2009дЙ9тб╩Н╤╞
Include("\\script\\online\\viet_event\\200909\\event_head.lua");
--2009дЙ11тб╩Н╤╞
Include("\\script\\online\\viet_event\\200911\\event_head.lua");
--2009дЙ12тб╩Н╤╞
Include("\\script\\online\\viet_event\\200912\\event_head.lua");

--╢с2010дЙ©╙й╪т╫дой╕цехннЯ╣ц╫╠юЬмЁр╩тзобцФ╟Э╨╛уБ╦Жнд╪ЧюОцФй╣ожё╛х╩╨Стз╠╬нд╪ЧюОцФ╣Всцё╛╡╩сцц©╢н╤╪пч╦дуБ╦Жнд╪Ч
Include("\\script\\online_activites\\award.lua");--for Give_Faction_Award()
Include("\\script\\online\\viet_event\\vng_task_control.lua")
Include("\\script\\vng\\award\\feature_award.lua");
Include("\\script\\voz\\xacthuc\\xacthuc.lua");
--========================================================================

TT_COLLECT_ITEM = 1				-- йу╪╞р╩╤╗нОф╥╡╒грр╙гСио╫╩ё╛ю╢т╢йг╢Р╧ж╣ТбД
TT_KILL_MONSTER = 2				-- и╠кюр╩╤╗йЩа©╣дль╤╗╧жнО
TT_UPGRAGE_ATTR = 3				-- иЩ╪╤р╩╤╗йЩж╣╣дль╤╗йТптё╗╠ххГ╬╜яИё╛иЫмШё╛╣х╪╤ё╛PKж╣╣х╣хё╘
TT_SHOWOFF_ITEM = 4				-- йу╪╞нОф╥ё╛╣╚йгю╢т╢╬мйгил╣Й
TT_SEND_MAIL = 5				-- сКдЁNPC╤т╩╟

-- хннЯ╠Да©╪гб╪╠М -----------------------------------------------------------------------------
TASKVALUE_CUR_DATE_ID = 333			-- ╣╠г╟й╕цехннЯ╢╕сз╣дй╠╪Дхуфз YYYYMMDDё╛сцсзгЕЁЩ334╠Да©йЩж╣
TASKVALUE_FACTION_CONTRI_CUR_DAY_ID = 334	-- ╣╠лЛ╩Я╣ц╣дй╕це╧╠ов╤х╢Ф╥е╣дхннЯ╠Да©
TASKVALUE_DIFFICULT_LEVEL_ID = 335	-- ╣╠г╟я║тЯ╣дй╕цехннЯ╣ддя╤х╣х╪╤
TASKVALUE_FACTION_CONTRI_ID = 336	-- й╕це╧╠ов╤х╢Ф╥е╣дхннЯ╠Да©

-- 337 - 340 й╕цехннЯа╢сц╣дхннЯ╠Да©
-- 341 - 344 ил╩АхннЯа╢╣дхннЯ╠Да©

LAST_USE_DATE = 85			-- й╕цеаНйИио╢нй╧сц╣дхуфз
MULTI_COUNT = 86			-- ╣╠г╟╪сЁи╠╤йЩ

TASKVALUE_FACTION_EVENT_ID = 345	-- й╕цехннЯ╢Сйб╪Ч╣дхннЯID╢Ф╥е╣дхннЯ╠Да©
TASKVALUE_CUR_DAY_TIMES_ID = 346	-- ╫ЯлЛвЖак╪╦╢нй╕цехннЯ╣д╪мб╪
-- 347 ря╬╜╠╩сцё╛й╕цехннЯпХр╙и╠╧ж╣дйЩа©

TASKVALUE_LAST_CARD_CONTRIBUTE_ID = 348			-- ио╢наЛх║й╕цеаНефй╠╨Р╣дй╕це╧╠ов╤хйЩж╣╪гб╪╣дхннЯ╠Да©
TASKVALUE_LAST_GET_EVENT_DATE_ID = 349			-- ио╢наЛх║й╕це╢Сйб╪Ч╣дй╠╪Д╤н©╙й╪хуфз
TASKVALUE_GET_EVENT_TIMES_ID = 350				-- ╠╬й╠╪Д╤ндзря╬╜Ё╒йтаЛх║й╕це╢Сйб╪Ч╣д╢нйЩ
TASKVALUE_LAST_GET_EVENT_PRIZE_DATE_ID = 351	-- ио╢наЛх║й╕це╢Сйб╪Ч╫╠юЬ╣дй╠╪Д╤н©╙й╪хуфз
TASKVALUE_GET_EVENT_PRIZE_TIMES_ID = 352		-- ╠╬й╠╪Д╤ндзря╬╜Ё╒йтаЛх║й╕це╢Сйб╪Ч╫╠юЬ╣д╢нйЩ

-- хннЯ╠Да©╪гб╪╠М end--------------------------------------------------------------------------

TASK_ID_SHAOLIN_SUJIA = 1		-- иыажкв╪рё╛хЩ╦Ждя╤х╬мйг 1 2 3
TASK_ID_SHAOLIN_CHANSENG = 4	-- иыажЛЬи╝ё╛хЩ╦Ждя╤х╬мйг 4 5 6
TASK_ID_SHAOLIN_WUSENG = 7		-- иыажнДи╝ё╛хЩ╦Ждя╤х╬мйг 7 8 9

TASK_ID_DEFAULT_ROUTE = 10		-- х║оШхннЯ╩РуъфДкШ╣дж╩пХр╙╨мил╩АхннЯгЬ╠П©╙й╧сц╣дхннЯа╢ID

TASK_ID_WUDANG_DAOJIA = 12		-- нД╣╠╣ю╪рё╛хЩ╦Ждя╤х╬мйг 12 13 14
TASK_ID_WUDANG_SUJIA = 15		-- нД╣╠кв╪рё╛хЩ╦Ждя╤х╬мйг 15 16 17

TASK_ID_EMEI_FOJIA = 18			-- ╤КАр╥П╪рё╛хЩ╦Ждя╤х╬мйг 18 19 20
TASK_ID_EMEI_SUJIA = 21			-- ╤КАркв╪рё╛хЩ╦Ждя╤х╬мйг 21 22 23

TASK_ID_TANGMEN = 24			-- лфце,хЩ╦Ждя╤х╬мйг 24 25 26

TASK_ID_GAIBANG_JINGYI = 27		-- ь╓╟О╬╩рб, хЩ╦Ждя╤х╬мйг 27 28 29
TASK_ID_GAIBANG_WUYI = 30		-- ь╓╟Оншрб, хЩ╦Ждя╤х╬мйг 30 31 32

TASK_ID_YANGMEN_QIANGQI = 33	-- яНцег╧фО, хЩ╦Ждя╤х╬мйг 33 34 35
TASK_ID_YANGMEN_GONGQI = 36		-- яНце╧╜фО, хЩ╦Ждя╤х╬мйг 36 37 38

TASK_ID_WUDU_XIEXIA = 39		-- нЕ╤╬п╟ою, хЩ╦Ждя╤х╬мйг 39 40 41
TASK_ID_WUDU_GUSHI = 42			-- нЕ╤╬╧фй╕, хЩ╦Ждя╤х╬мйг 42 43 44

TASK_ID_KUNLUN_TIANSHI = 45		-- ю╔бьлЛй╕, хЩ╦Ждя╤х╬мйг 45 46 47

TASK_ID_CUIYAN_WUXIAN = 48		-- ╢ДялнХои, хЩ╦Ждя╤х╬мйг 48 49 50
TASK_ID_CUIYAN_LINGNV = 51		-- ╢ДялаИе╝, хЩ╦Ждя╤х╬мйг 51 52 53

TASK_ID_MINGJIAO_SHENGZHAN = 54		-- цВ╫лй╔у╫, хЩ╦Ждя╤х╬мйг 54 55 56
TASK_ID_MINGJIAO_XUEREN = 57		-- цВ╫ля╙хк, хЩ╦Ждя╤х╬мйг 57 58 59
TASK_ID_MINGJIAO_ZHENBING = 60		-- цВ╫луС╠Ь, хЩ╦Ждя╤х╬мйг 60 61 62

--========================================================================


-- й╕цехннЯ╣дхК©зё╛nFactionRouteNo╢З╠МиоцФ╣дмФ╪раВеиё╛я║хннЯсц╣д║ё
function task_main_entrance(nFactionRouteNo)
	if GetReputation() < 5 then
		Msg2Player("Ph╤i cЦ ╝iсm danh vДng tУ 5 trК l╙n mМi cЦ thс nhкn nhiжm vТ S╜ m╚n!")
		return
	end
	local nTaskState = GetChainTaskStatus(nFactionRouteNo)
	-- ╣╠г╟╣х╪╤╣диЫмШочжф
	local nFactionReputationLimit = 0;
	local nLevel = GetLevel()
	local nCurContriEEE = GetTask(TASKVALUE_FACTION_CONTRI_ID)	-- ╣╠г╟й╕це╧╠ов╤х
	local nCreateTime = GetCreateTime()
	
	-- 1150732800 йг2006дЙ6тб20хуё╛уБ╦Жй╠╪Дртг╟╫╗а╒╣д╫ги╚╤╪©иртаЛх║╡╧Ё╔
	if (nCreateTime < 1150732800) then
		if (nLevel < 60) then
			nFactionReputationLimit = 0
		elseif (nLevel < 70) then
			nFactionReputationLimit, nBaseDayLimit, nExtraDayLimit = GetFactionRepuLimit()
			nFactionReputationLimit = floor(nFactionReputationLimit / 3)
		elseif (nLevel < 80) then
			nFactionReputationLimit = 1000
		else
			nFactionReputationLimit = 1500
		end
	end
	gf_WriteLogEx("Nhiem vu Su Mon", "tham gia")
	-- ╩╧ц╩сп╫с╧ЩхннЯ
	if (nTaskState == 0) then		
		if ((nCurContriEEE == 0) and (nFactionReputationLimit > 0) and GetTask(TASKVALUE_DIFFICULT_LEVEL_ID) == 0) then	-- ╣зр╩╢н╫схннЯ
			SetTask(TASKVALUE_FACTION_CONTRI_ID, nFactionReputationLimit)
			SetTask(TASKVALUE_LAST_CARD_CONTRIBUTE_ID, nFactionReputationLimit)
			Msg2Player("C╗n cЬ theo ╝╪ng cйp, phгn th╜Кng ╝И cХng hiуn cho lгn ╝гu l╣m nhiжm vТ s╜ m╚n l╣"..nFactionReputationLimit.." ╝iсm")
		end
		get_new_task(nFactionRouteNo)
		
	-- ря╬╜╫с╣╫хннЯ╣╚йг╩╧ц╩спмЙЁи		
	elseif (nTaskState == 1) then	
		process_cur_task(nFactionRouteNo)
		
	-- ря╬╜мЙЁиакио╢н╫с╣╫╣дхннЯ
	elseif (nTaskState == 2) then	
		get_next_task(nFactionRouteNo)
	end
end;



-- мФ╪ря║тЯмкЁЖ╤т╩╟
function cancel_dialog()
end;



-- я║тЯакр╩╦ЖхннЯ╦ЬмФ╪рё╛ря╬╜╪с╣╫иМиоакё╛мФ╪р©иртя║тЯйгвЖ╩╧йг╡╩вЖ
function get_one_task(task_link_id)

	--		          дЙ	       тб	       ху	       й╠	       ╥ж	       цК
	local nCurrTime = {date("%Y"), date("%m"), date("%d"), date("%H"), date("%M"), date("%S")}
	local nCurDate = tonumber( nCurrTime[1]..nCurrTime[2]..nCurrTime[3])	-- ожтз╣дхуфз
	local nLastTaskDate = GetTask(TASKVALUE_CUR_DATE_ID)					-- ио╢н╫схннЯ╣дхуфз
	
	if (nLastTaskDate < nCurDate) then
		SetTask(TASKVALUE_CUR_DATE_ID, nCurDate)			-- иХжцпб╣дхуфз
		SetTask(TASKVALUE_FACTION_CONTRI_CUR_DAY_ID, 0)		-- гЕ©у╣╠лЛ╩Я╣ц╣дй╕це╧╠ов╤х
		SetTask(TASKVALUE_CUR_DAY_TIMES_ID, 0)				-- гЕ©у╣╠лЛвЖак╣дй╕цехннЯ╢нйЩ
	end
	-- Modify by Trungbt
	local tbCheckType = {3, 6, 9, 12, 14, 17, 20, 23, 26, 29, 32, 35, 38, 41, 44}
	--Msg2Player("Gia tri check ID:  "..task_link_id)
	for i = 1, getn(tbCheckType) do
		if task_link_id == tbCheckType[i] then
			SetTask(TSK_CSD_ALLOW, 1)
			break
		end

	end
	------------------------

	-- ╪Л╡И╫ЯлЛ╢нйЩ╧╩акц╩спё╛╧╩5╢н╬м╡╩хц╪лпЬвЖак - Jeep tag ожтз╡╩╪Л╡Иак
	--local nCurDayTimes = GetTask(TASKVALUE_CUR_DAY_TIMES_ID)
	--if (nCurDayTimes >= 5) then
	--	Say("н╙й╕╦у╦у╡И©╢╧ЩакдЦвЖ╧Щ╣дхннЯё╛╫ЯхудЦн╙й╕це╥Нов╣д╧╠ов╤хря╬╜вЦ╧╩║ён╙й╕╬м╡╩тыеи╦ЬдЦ╦Э╤ЮхннЯакё╛дЦ╩╧йгцВхутыю╢╟иё║", 0)
	--	return
	--end

	-- ╥ЯтР...
	-- я║х║р╩╦Ж╠╬аВеи╣дкФ╩ЗхннЯё╛╡╒гр╥╣╩ьхннЯюЮпм
	local nTaskType = SelectRandomTask(task_link_id)
	SetTask(TASKVALUE_DIFFICULT_LEVEL_ID, task_link_id)
	
	-- ожтзй╕цехннЯ╬мйги╠╧ж
	if (nTaskType == TT_KILL_MONSTER) then
		strAnswer = {"╖ж tЖ ╝Еng Щ!/confirm_accept_task",
					 "╖ж tЖ thЫc lЫc cъn kпm, ╝с luyжn mИt thЙi gian ╝╥!/cancel_task"}

		-- кФ╩Зя║тЯр╩╦Ж╥╒хннЯ╣д╩╟ё╛╧Ч╧Чё╛╡ъ╩╝лН╠М╩АспбЫм╢©Юя╫ё║ Amen.	
		local nSel = random(1, 3)
		local strTaskInfo = GetInfo(task_link_id, nSel)
		local strAnswer = {
			"╖ж tЖ ╝Еng Щ!/confirm_accept_task",
			"╖ж tЖ thЫc lЫc cъn kпm, ╝с luyжn mИt thЙi gian ╝╥!/cancel_task",
		}
		Say(strTaskInfo, getn(strAnswer), strAnswer);
	end
end;

function confirm_accept_task()
	AskClientForString("confirm_accept_task_recv", "", 1, 20, "Nhкp: sm")
	
end

function confirm_accept_task_recv(szKey)
	
	if szKey == 'sm' then
		confirm_accept_task_ok()
	else
		Say("Vui lъng nhкp chВ sm v╣o ╚ kiсm tra", 0);
	end
end

-- х╥хо╫сйэй╕╦╣╥жеД╣дхннЯё╛╡╒гря║тЯйг╥Яж╠╫сх╔хннЯкЫтз╣ь
function confirm_accept_task_ok()
	local nMapIndex = tonumber(GetCurTaskLinkMapIndex(TASK_ID_DEFAULT_ROUTE));
	-- тз╣ьм╪╠Мжпдэ╧╩╣ц╣╫р╙х╔╣д╣ьм╪
	if ((nMapIndex ~= 0) and (nMapIndex ~= nil)) then
		Say("Ng╜╛i nhкn ╝╜Нc 1 nhiжm vТ s╜ m╚n, muХn ╝уn ╝Ц kh╚ng?",
			2,
			"Phiрn s╜ phТ ╝╜a ╝ж tЖ ╝уn n╛i l╣m nhiжm vТ!/#gotoWorld("..nMapIndex..")",
			"╖a t╧ s╜ phТ! ╖ж tЖ sо tЫ ╝i!/cancel_dialog");
	else
		TaskTip("B╧n nhкn ╝╜Нc 1 nhiжm vТ s╜ m╚n!");
	end
	Msg2Player("B╧n nhкn ╝╜Нc 1 nhiжm vТ s╜ m╚n!");
end;



-- мФ╪рх╥хор╙х║оШ╥жеД╦Ьвт╪╨╣дхннЯё╛╫Ьпп©шЁЩиЫмШ╨мгЕЁЩхннЯ╣д╡ывВ
function confirm_cancel_task()
	-- й╕це╧╠ов╤хвЦ╧╩©ш╬мхцкШх║оШ
	local nCurFactionContribute = GetTask(TASKVALUE_FACTION_CONTRI_ID)
	if (nCurFactionContribute >= 5) then			
		-- рРн╙кЫспй╕цехннЯ╤╪йг╧╚сцр╩╤нхннЯ╠Да©╪гб╪╣д
		-- кЫртуБюОж╩р╙╡╩йгил╩АхннЯ╣д11╬м©иртак
		CleanTask(TASK_ID_DEFAULT_ROUTE)
		SetTask(TASKVALUE_FACTION_CONTRI_ID, nCurFactionContribute - 5)
		Say("Nhiжm vТ ╝╥ hЯy, b╧n cЦ thс nhкn nhiжm vТ mМi.", 0);
		Msg2Player("B╧n bч tФn thйt 5 ╝iсm cХng hiуn do hЯy nhiжm vТ!");
		TaskTip("B╧n bч tФn thйt 5 ╝iсm cХng hiуn do hЯy nhiжm vТ!");
		SetTask(TSK_CSD_ALLOW,0)	-- Modify by Trungbt	
	-- й╕це╧╠ов╤х╡╩╧╩©ш
	else
		CleanTask(TASK_ID_DEFAULT_ROUTE)
		SetTask(TASKVALUE_FACTION_CONTRI_ID, 0)
		Say("Nhiжm vТ ╝╥ hЯy, b╧n cЦ thс nhкn nhiжm vТ mМi.", 0);
		Msg2Player("╖И cХng hiуn gi╤m xuХng 0 do b╧n ╝╥ hЯy nhiжm vТ!");
	end
end;



-- мФ╪рр╙гСх║оШ╥жеД╦Ьвт╪╨╣дхннЯё╛й╕╦╣╩А╫лсЩкШйг╥Ят╦рБё╛рРн╙╩АкПй╖й╕це╧╠ов╤х╣д
function cancel_task()
	Say("<color=yellow>HЯy bА nhiжm vТ<color> sо ╤nh h╜Кng tМi <color=yellow>╝И cХng hiуn s╜ m╚n<color>, ng╜╛i muХn hЯy nhiжm vТ n╣y kh╚ng?",
		2,
		"Nhiжm vТ n╣y ta kh╚ng muХn l╣m!/confirm_cancel_task",
		"╖с ta suy nghэ l╧i!/cancel_dialog");
end;

-- мФ╪ртзж╢ппхннЯжпр╙гСх║оШхннЯё╛й╕╦╣╩А╦ЬкШтых╥хор╩╢н
function cancel_processing_task()
	Say("<color=yellow>HЯy bА nhiжm vТ<color> sо ╤nh h╜Кng tМi <color=yellow>╝И cХng hiуn s╜ m╚n<color>. Ng╜╛i muХn hЯy bА thкt ╜?",
		2,
		"Nhiжm vТ n╣y ta kh╚ng muХn l╣m!/confirm_cancel_task",
		"Cho ta th╙m c╛ hИi!/cancel_dialog");
end;

-- ╣зр╩╢н╫схннЯё╛мФ╪ря║тЯр╙вЖй╡ц╢дя╤х╣дхннЯ
function get_new_task(nFactionRouteNo)
	task_link_id_low = nFactionRouteNo;
	task_link_id_middle = nFactionRouteNo + 1;
	task_link_id_high = nFactionRouteNo + 2;
	
	strTalk = {"Kh╦ l╬m! ╖с xem ng╜╛i giСp ╝╜Нc gв cho s╜ m╚n!",
			   "\n Nhiжm vТ s╛ cйp (Phгn th╜Кng kinh nghiжm v╣ ╝И cХng hiуn)./#get_one_task("..task_link_id_low..")",
			   "\n Nhiжm vТ trung cйp (Phгn th╜Кng tu luyжn v╣ ╝И cХng hiуn)./#get_one_task("..task_link_id_middle..")",
			   "\n Nhiжm vТ cao cйp (Phгn th╜Кng ╝И cХng hiуn)./#get_one_task("..task_link_id_high..")",
			   "\n ╖ж tЖ kh╚ng thс ╝╤m nhкn, cгn ph╤i rлn luyжn th╙m!/cancel_dialog"}
	
	-- ╟╢мФ╪р╣д╣х╪╤ё╛дэ╫с╣╫╣дхннЯ╣ддя╤х╣х╪╤р╡сп╡╩м╛
	local nCurPlayerLevel = GetLevel()
	if (nCurPlayerLevel < 30) then
		Say(strTalk[1], 2, strTalk[2], strTalk[5]);
	elseif (nCurPlayerLevel < 60) then
		Say(strTalk[1], 3, strTalk[2], strTalk[3], strTalk[5]);
	else
		Say(strTalk[1], 4, strTalk[2], strTalk[3], strTalk[4], strTalk[5]);
	end
end;



-- уЩтзж╢ппхннЯ╣дй╠╨Р╨мй╕╦╣╤т╩╟
function process_cur_task(nFactionRouteNo)
		-- ╩Ях║╦цхннЯ╣д╣ьм╪ ID
		local nMapIndex = tonumber(GetCurTaskLinkMapIndex(TASK_ID_DEFAULT_ROUTE));
		
		local strTalk = {"Ng╜╛i l╣m xong nhiжm vТ vi s╜ giao ch╜a?",
						 "NhВng nhiжm vТ ta giao, ng╜╛i l╣m ╝уn ╝╘u rЕi?",
						 "NhЙ s╜ phТ kiсm tra sХ nhiжm vТ ╝ж tЖ ╝╥ l╣m./faction_event_finish",
						 "Nhiжm vТ lкp l╧i lгn n╣y ╝╥ ho╣n th╣nh!/confirm_finish_task",
						 "╖ж tЖ kпm cАi kh╚ng thс ╝╤m nhкn, xin ╝╜Нc hЯy nhiжm vТ!/cancel_faction_event",
						 "╖ж tЖ kпm cАi kh╚ng thс ╝╤m nhкn, xin ╝╜Нc hЯy nhiжm vТ!/cancel_processing_task",
						 "Xin s╜ phТ cho th╙m щt thЙi gian, hiжn ch╜a ho╣n th╣nh/cancel_dialog"}
	
		if (GetTask(TASKVALUE_FACTION_EVENT_ID) == 0) then
			Say(strTalk[1], 3, strTalk[4], strTalk[6], strTalk[7]);
		else
			Say(strTalk[2], 5, strTalk[3], strTalk[4], strTalk[5], strTalk[6], strTalk[7]);
		end
end;



-- й╕╦╣к╣дЦйг╥ЯмЙЁиакхннЯё╛м╫╣э╩ь╢Пк╣ря╬╜мЙЁиак╣д
function confirm_finish_task()
	-- ╡Л©╢йг╥Яря╬╜мЙЁиакхннЯ
	if GetReputation() < 5 then
		Msg2Player("Ph╤i cЦ ╝iсm danh vДng tУ 5 trК l╙n mМi cЦ thс tr╤ nhiжm vТ S╜ m╚n!")
		return
	end
	local nCurFactionContribute = GetTask(TASKVALUE_FACTION_CONTRI_ID)
	local nCurTaskLinkID = GetTask(TASKVALUE_DIFFICULT_LEVEL_ID)	-- ╣╠г╟дя╤х╣х╪╤
	local nTaskFinish = QueryTaskFinish(nCurTaskLinkID)
	local nFactionReputationLimit, nBaseDayLimit, nExtraDayLimit = GetFactionRepuLimit()	-- ╣╠г╟╣х╪╤╣диЫмШочжф
	local nLevel = GetLevel();

	-- ╩т╩мж╝р╧╫╠юЬ╥╜╠╤╣д╠╤бй
	local multiple = get_reward_multiple(SYS_MASTER_REPEATTASK)
	local nPerCent = floor(100 * multiple)				-- ╫╠юЬ╣д╟ы╥ж╠х
	nBaseDayLimit = floor(nBaseDayLimit * multiple)
	nExtraDayLimit = floor(nExtraDayLimit * multiple)

	-- Modify by Trungbt
--	if GetTask(TSK_CSD_ALLOW) == 1 then
--		local nCSD_SuMon = mod(GetTask(TSK_CSD_COUNT_A), 1000)
--		if nCSD_SuMon < 300 and GetTask(TSK_CSD) == 1 then
--			SetTask(TSK_CSD_COUNT_A, GetTask(TSK_CSD_COUNT_A) + 1)
--		end
--		SetTask(TSK_CSD_ALLOW, 0)
--	end
	HoanThanhNhiemVuSuMon()
	------------------------------------

	local bExtra = 0;
	local nDayReputationLimit = nBaseDayLimit

	-- ╪Л╡ИмФ╪рйг╥Яйг╦ъ╪╤хннЯдя╤х	
	if ((nCurTaskLinkID == TASK_ID_SHAOLIN_SUJIA + 2) or
		(nCurTaskLinkID == TASK_ID_SHAOLIN_CHANSENG + 2) or
		(nCurTaskLinkID == TASK_ID_SHAOLIN_WUSENG + 2) or
		(nCurTaskLinkID == TASK_ID_WUDANG_DAOJIA + 2) or
		(nCurTaskLinkID == TASK_ID_WUDANG_SUJIA + 2) or
		(nCurTaskLinkID == TASK_ID_EMEI_FOJIA + 2) or
		(nCurTaskLinkID == TASK_ID_EMEI_SUJIA + 2) or
		(nCurTaskLinkID == TASK_ID_TANGMEN + 2) or
		(nCurTaskLinkID == TASK_ID_GAIBANG_JINGYI + 2) or
		(nCurTaskLinkID == TASK_ID_GAIBANG_WUYI + 2) or
		(nCurTaskLinkID == TASK_ID_YANGMEN_QIANGQI + 2) or
		(nCurTaskLinkID == TASK_ID_YANGMEN_GONGQI + 2) or
		(nCurTaskLinkID == TASK_ID_WUDU_XIEXIA + 2) or
		(nCurTaskLinkID == TASK_ID_WUDU_GUSHI + 2) or
		(nCurTaskLinkID == TASK_ID_KUNLUN_TIANSHI + 2) or
		(nCurTaskLinkID == TASK_ID_CUIYAN_WUXIAN + 2) or
		(nCurTaskLinkID == TASK_ID_CUIYAN_LINGNV + 2) or
		(nCurTaskLinkID == TASK_ID_MINGJIAO_SHENGZHAN + 2) or
		(nCurTaskLinkID == TASK_ID_MINGJIAO_XUEREN + 2) or
		(nCurTaskLinkID == TASK_ID_MINGJIAO_ZHENBING + 2)) then
		
		bExtra = 1
		nDayReputationLimit = nExtraDayLimit
	end

	--╪гб╪╫ЯлЛ╣дй╠╪Дё╛сцю╢х╥хо╫ЯлЛйг╥Я╩╧©иртаЛх║й╕це╧╠ов╤х
	--		          дЙ	       тб	       ху	       й╠	       ╥ж	       цК
	local nCurrTime = {date("%Y"), date("%m"), date("%d"), date("%H"), date("%M"), date("%S")}
	local nCurDate = tonumber( nCurrTime[1]..nCurrTime[2]..nCurrTime[3])	-- ожтз╣дхуфз
	local nLastTaskDate = GetTask(TASKVALUE_CUR_DATE_ID)					-- ио╢н╫схннЯ╣дхуфз
	
	if (nLastTaskDate < nCurDate) then
		SetTask(TASKVALUE_CUR_DATE_ID, nCurDate)			-- иХжцпб╣дхуфз
		SetTask(TASKVALUE_FACTION_CONTRI_CUR_DAY_ID, 0)		-- гЕ©у╣╠лЛ╩Я╣ц╣дй╕це╧╠ов╤х
		SetTask(TASKVALUE_CUR_DAY_TIMES_ID, 0)				-- гЕ©у╣╠лЛвЖак╣дй╕цехннЯ╢нйЩ
	end

	if (nTaskFinish == 1) then
		local nCurDayTimes = GetTask(TASKVALUE_CUR_DAY_TIMES_ID) + 1
		if nCurDayTimes == 5 then	--╣з5╢нмЙЁи╫╠аИй╞еД╥╫
			local nPFLevel = 0;
			if nLevel < 30 then
				nPFLevel = 1
			elseif nLevel < 40 then
				nPFLevel = random(1,2);
			elseif nLevel < 50 then
				nPFLevel = random(1,3);
			elseif nLevel < 60 then
				nPFLevel = random(1,4);
			elseif nLevel < 80 then
				nPFLevel = random(1,5);
			elseif nLevel <= 100 then
				nPFLevel = random(2,5);
			end;
            if GetAntiEnthrallmentStatus() == 0 then
    			if nPFLevel ~= 0 then
    				lspf_AddPeiFangInBottle(nPFLevel,1);
    				Msg2Player("B╧n nhкn ╝╜Нc 1 "..nPFLevel.."PhХi chу linh th╧ch cйp, ╝╥ cho v╣o TТ Linh ╝ьnh");
                end;
			end;
		end;		
		SetTask(TASKVALUE_CUR_DAY_TIMES_ID, nCurDayTimes)	-- ╦Эпб╫ЯлЛря╬╜вЖак╣дхннЯ╢нйЩ
		if get_chrims_state() == 1 then
			if nCurDayTimes == 1 or nCurDayTimes == 2 then
				local nRand1 = random(getn(tStrewTask)-9,getn(tStrewTask));
				local nRand2 = random(getn(tStrewTask)-9,getn(tStrewTask));
				AddItem(tStrewTask[nRand1][3],tStrewTask[nRand1][4],tStrewTask[nRand1][5],tStrewTask[nRand1][1]);
				AddItem(tStrewTask[nRand2][3],tStrewTask[nRand2][4],tStrewTask[nRand2][5],tStrewTask[nRand2][1]);
				Msg2Player("B╧n nhкn ╝╜Нc "..tStrewTask[nRand1][2].."Thiжp chСc mУng"..tStrewTask[nRand1][1].."Tr╜╛ng");	
				Msg2Player("B╧n nhкn ╝╜Нc "..tStrewTask[nRand2][2].."Thiжp chСc mУng"..tStrewTask[nRand2][1].."Tr╜╛ng");
			end
		end	
		SetTask(TASKVALUE_CUR_DAY_TIMES_ID, nCurDayTimes)	-- ╦Эпб╫ЯлЛря╬╜вЖак╣дхннЯ╢нйЩ
	        local nFactionNum = GetTask(VET_201009_00_TASK_NUM_FACTION)
                if ((nCurTaskLinkID == TASK_ID_SHAOLIN_SUJIA) or
		    (nCurTaskLinkID == TASK_ID_SHAOLIN_CHANSENG) or
		    (nCurTaskLinkID == TASK_ID_SHAOLIN_WUSENG) or
		    (nCurTaskLinkID == TASK_ID_WUDANG_DAOJIA) or
                    (nCurTaskLinkID == TASK_ID_WUDANG_SUJIA) or
		    (nCurTaskLinkID == TASK_ID_EMEI_FOJIA) or
		    (nCurTaskLinkID == TASK_ID_EMEI_SUJIA) or
		    (nCurTaskLinkID == TASK_ID_TANGMEN) or
		    (nCurTaskLinkID == TASK_ID_GAIBANG_JINGYI) or
		    (nCurTaskLinkID == TASK_ID_GAIBANG_WUYI) or
		    (nCurTaskLinkID == TASK_ID_YANGMEN_QIANGQI) or
		    (nCurTaskLinkID == TASK_ID_YANGMEN_GONGQI) or
		    (nCurTaskLinkID == TASK_ID_WUDU_XIEXIA) or
		    (nCurTaskLinkID == TASK_ID_WUDU_GUSHI) or
		    (nCurTaskLinkID == TASK_ID_KUNLUN_TIANSHI) or
		    (nCurTaskLinkID == TASK_ID_CUIYAN_WUXIAN ) or
		    (nCurTaskLinkID == TASK_ID_CUIYAN_LINGNV ) or
		    (nCurTaskLinkID == TASK_ID_MINGJIAO_SHENGZHAN ) or
		    (nCurTaskLinkID == TASK_ID_MINGJIAO_XUEREN ) or
		    (nCurTaskLinkID == TASK_ID_MINGJIAO_ZHENBING )) then
                    if mod(nFactionNum,10) == 0 then
                        nFactionNum = nFactionNum + 1
                    end
		elseif ((nCurTaskLinkID == TASK_ID_SHAOLIN_SUJIA + 1) or
		    (nCurTaskLinkID == TASK_ID_SHAOLIN_CHANSENG + 1) or
		    (nCurTaskLinkID == TASK_ID_SHAOLIN_WUSENG + 1) or
		    (nCurTaskLinkID == TASK_ID_WUDANG_DAOJIA + 1) or
                    (nCurTaskLinkID == TASK_ID_WUDANG_SUJIA + 1) or
		    (nCurTaskLinkID == TASK_ID_EMEI_FOJIA + 1) or
		    (nCurTaskLinkID == TASK_ID_EMEI_SUJIA + 1) or
		    (nCurTaskLinkID == TASK_ID_TANGMEN + 1) or
		    (nCurTaskLinkID == TASK_ID_GAIBANG_JINGYI + 1) or
		    (nCurTaskLinkID == TASK_ID_GAIBANG_WUYI + 1) or
		    (nCurTaskLinkID == TASK_ID_YANGMEN_QIANGQI + 1) or
		    (nCurTaskLinkID == TASK_ID_YANGMEN_GONGQI + 1) or
		    (nCurTaskLinkID == TASK_ID_WUDU_XIEXIA + 1) or
		    (nCurTaskLinkID == TASK_ID_WUDU_GUSHI + 1) or
		    		    (nCurTaskLinkID == TASK_ID_KUNLUN_TIANSHI+1) or
		    (nCurTaskLinkID == TASK_ID_CUIYAN_WUXIAN+1 ) or
		    (nCurTaskLinkID == TASK_ID_CUIYAN_LINGNV+1 ) or
		    (nCurTaskLinkID == TASK_ID_MINGJIAO_SHENGZHAN+1 ) or
		    (nCurTaskLinkID == TASK_ID_MINGJIAO_XUEREN+1 ) or
		    (nCurTaskLinkID == TASK_ID_MINGJIAO_ZHENBING+1 )) then
                    if mod(floor(nFactionNum/10),10) == 0 then
                        nFactionNum = nFactionNum + 10
                    end
                elseif ((nCurTaskLinkID == TASK_ID_SHAOLIN_SUJIA + 2) or
		    (nCurTaskLinkID == TASK_ID_SHAOLIN_CHANSENG + 2) or
		    (nCurTaskLinkID == TASK_ID_SHAOLIN_WUSENG + 2) or
		    (nCurTaskLinkID == TASK_ID_WUDANG_DAOJIA + 2) or
                    (nCurTaskLinkID == TASK_ID_WUDANG_SUJIA + 2) or
		    (nCurTaskLinkID == TASK_ID_EMEI_FOJIA + 2) or
		    (nCurTaskLinkID == TASK_ID_EMEI_SUJIA + 2) or
		    (nCurTaskLinkID == TASK_ID_TANGMEN + 2) or
		    (nCurTaskLinkID == TASK_ID_GAIBANG_JINGYI + 2) or
		    (nCurTaskLinkID == TASK_ID_GAIBANG_WUYI + 2) or
		    (nCurTaskLinkID == TASK_ID_YANGMEN_QIANGQI + 2) or
		    (nCurTaskLinkID == TASK_ID_YANGMEN_GONGQI + 2) or
		    (nCurTaskLinkID == TASK_ID_WUDU_XIEXIA + 2) or
		    (nCurTaskLinkID == TASK_ID_WUDU_GUSHI + 2) or
		    (nCurTaskLinkID == TASK_ID_KUNLUN_TIANSHI+2) or
		    (nCurTaskLinkID == TASK_ID_CUIYAN_WUXIAN+2 ) or
		    (nCurTaskLinkID == TASK_ID_CUIYAN_LINGNV+2 ) or
		    (nCurTaskLinkID == TASK_ID_MINGJIAO_SHENGZHAN+2 ) or
		    (nCurTaskLinkID == TASK_ID_MINGJIAO_XUEREN+2 ) or
		    (nCurTaskLinkID == TASK_ID_MINGJIAO_ZHENBING+2 )) then
                    if mod(floor(nFactionNum/100),10) == 0 then
                        nFactionNum = nFactionNum + 100
                    end
	        end
                --ц©╢н╩Н╤╞╦Ь╫╠юЬ╤╪╣Всц╢к╨╞йЩё╛╡╩тыоЯртг╟р╩яЫц©╢н╩Н╤╞╤╪п╢р╩╦Ж╨╞йЩю╢╦Ь╫╠юЬ
                SetTask(VET_201009_00_TASK_NUM_FACTION,nFactionNum)
                Give_Faction_Award();--from "\script\online_activites\award.lua"
		
		
        if GetAntiEnthrallmentStatus() == 0 then
            FinishTaskStep(nCurTaskLinkID, 0, nPerCent)			-- ╫АйЬ╣╠г╟хннЯ╡╒гр╥╒╫╠
        elseif GetAntiEnthrallmentStatus() == 1 then
            FinishTaskStep(nCurTaskLinkID, 0, floor(nPerCent/2))			-- 3п║й╠╥юЁацтв╢л╛╦Ьр╩╟К╫╠юЬ
        else
            --5п║й╠╥юЁацтв╢л╛╡╩╦Ь╫╠юЬ
        end
		-- й╕м╫хннЯ ё╗й╕цеё╘
		local nChance, nMaxChance = CustomDataRead("mp_shimen")
		if nChance ~= nil then
			nChance = nChance + 1
			if nChance < nMaxChance then
				CustomDataSave("mp_shimen", "dd", nChance, nMaxChance)
				Msg2Player("Nhiжm vТ S╜ ╝Е- tвnh hвnh ho╣n th╣nh S╜ m╚n-:"..nChance.."/"..nMaxChance)
			else
				PrenticeCompleteTask()
			end
		end
		-- уК╤точжфр╙╤т╩Я╣ц╣диЫмШ╫Ьпп╢╕юМ
		-- тЖ╪с╨С╣дй╕це╧╠ов╤х
		local nFactionContributeAfter = GetTask(TASKVALUE_FACTION_CONTRI_ID)
		-- ╫ЯлЛря╬╜╩Я╣ц╣дй╕це╧╠ов╤х
		local nCurDayGainReputation = GetTask(TASKVALUE_FACTION_CONTRI_CUR_DAY_ID)
		
		-- уБ╢нтЖ╪с╣дй╕це╧╠ов╤х
		local nAddedThisTimeContribute = nFactionContributeAfter - nCurFactionContribute
		
		-- Ё╛╧Щак╣╠лЛдэ╩Я╣ц╣диЫмШ╣ЦйЩё╛©ш╩ьх╔
		if (nCurDayGainReputation > nDayReputationLimit) then
			local nShouldBeMinus = nCurDayGainReputation - nDayReputationLimit
			-- хГ╧ШйгвЖак╦ъ╪╤хннЯты╩ью╢вЖ╣м╪╤хннЯё╛дгц╢ж╩╪УуБ╢нвЖ╣дхннЯ╣ц╣╫╣дй╕це╧╠ов╤х║ё
			if (nFactionContributeAfter - nShouldBeMinus < nCurFactionContribute) then
				nShouldBeMinus = nFactionContributeAfter - nCurFactionContribute
			end
			SetTask(TASKVALUE_FACTION_CONTRI_CUR_DAY_ID, nCurDayGainReputation - nShouldBeMinus)
			SetTask(TASKVALUE_FACTION_CONTRI_ID, nFactionContributeAfter - nShouldBeMinus)
			nAddedThisTimeContribute = nAddedThisTimeContribute - nShouldBeMinus
			if (bExtra == 1) then
				Msg2Player("H╚m nay ng╜╛i kh╚ng thс nhкn th╙m ╝iсm cХng hiуn s╜ m╚n, mau ╝i rлn luyжn th╙m!")
			else
				Msg2Player("H╚m nay ng╜╛i kh╚ng thс nhкn th╙m ╝iсm cХng hiуn s╜ m╚n nh╜ng nуu l╣m th╙m nhВng nhiжm vТ kh╦c cРng ╝╜Нc ╝iсm.")
			end
		end
		
		nFactionContributeAfter = GetTask(TASKVALUE_FACTION_CONTRI_ID)	-- ╢╕юМ╨С╣дй╕це╧╠ов╤х
		if (nFactionContributeAfter < 0) then
			SetTask(TASKVALUE_FACTION_CONTRI_ID, 0)
			nFactionContributeAfter = 0
		end
		
		-- Ё╛╧Щак╠╬╣х╪╤дэ╩Я╣ц╣двН╤Юй╕це╧╠ов╤хё╛©ш╩ьх╔
		if (nFactionContributeAfter > nFactionReputationLimit) then
			local nShouldBeMinuss = nFactionContributeAfter - nFactionReputationLimit
			SetTask(TASKVALUE_FACTION_CONTRI_CUR_DAY_ID, nCurDayGainReputation - nShouldBeMinuss)
			SetTask(TASKVALUE_FACTION_CONTRI_ID, nFactionReputationLimit)
			nAddedThisTimeContribute = nAddedThisTimeContribute - nShouldBeMinuss
			Msg2Player("╖╪ng cйp hiжn t╧i kh╚ng thс nhкn th╙m ╝iсm cХng hiуn s╜ m╚n, l╙n mИt cйp nВa h╥y quay l╧i.")
		end
		if GetReputation() >= 5 then
			ModifyReputation(-5, 0)
		else
			ModifyReputation(0 - GetReputation(), 0)
		end
		
		if (GetTask(TASKVALUE_FACTION_CONTRI_CUR_DAY_ID) < 0) then
			SetTask(TASKVALUE_FACTION_CONTRI_CUR_DAY_ID, 0)
		end
		
		-- й╕цехннЯфДкШ╫╠юЬё╨
		other_faction_prize();
		
		-- еп╤ойг╥Я©ирт╫с╣╫й╕це╣днДаж╢Сйб╪ЧхннЯё╛р╙ц╩╫с╣╫грлУ╪ЧбЗвЦ
		local bHaveOwnFactionEvent = GetTask(TASKVALUE_FACTION_EVENT_ID)
		if ((bHaveOwnFactionEvent == 0) and (check_faction_event_condition() == 1)) then
			if (StartFactionEvent() == 1) then
				local nSel = random(1, 4)
				local strTaskInfo = QueryFactionEventInfo(nSel)
				Say(strTaskInfo, 0);
			else
				Say("Tiуn bИ nhanh l╬m! ╖с Vi S╜ d╧y ng╜╛i th╙m chСt vБ nghж!", 0)
			end
		else
			Say("Tiуn bИ nhanh l╬m! ╖с Vi S╜ d╧y ng╜╛i th╙m chСt vБ nghж!", 0)
		end
		
		if (nAddedThisTimeContribute < 0) then
			nAddedThisTimeContribute = 0
		end

-- ===================й╕цеаНйИ╪сЁи╪фкЦ===================================================		
		local nLastLingshuDate = GetTask(LAST_USE_DATE)			-- й╕цеаНйИио╢нй╧сц╣дхуфз
		local nMultiCount = GetTask(MULTI_COUNT)				-- ╣╠г╟╪сЁи╠╤йЩ
		if (nLastLingshuDate == nCurDate) then
			local nStillShouldPlus = nAddedThisTimeContribute * (nMultiCount - 1)
			local nNowFactionContribute = GetTask(TASKVALUE_FACTION_CONTRI_ID)
			nNowFactionContribute = nNowFactionContribute + nStillShouldPlus
			SetTask(TASKVALUE_FACTION_CONTRI_ID, nNowFactionContribute)
			nAddedThisTimeContribute = nAddedThisTimeContribute + nStillShouldPlus
		else
			SetTask(MULTI_COUNT, 1)
		end
-- ===================й╕цеаНйИ╪сЁи╪фкЦ================================================end
		
		Msg2Player("Nhiжm vТ lгn n╣y b╧n nhкn ╝╜Нc  "..nAddedThisTimeContribute.." ╝iсm cХng hiуn s╜ m╚n!")
	else
		Say("Nhiжm vТ dт nh╜ vкy m╣ kh╚ng l╣m ╝╜Нc! Ng╜╛i qu╦ kпm cБi!", 0)
		--if (nCurFactionContribute > 0) then
		--	SetTask(TASKVALUE_FACTION_CONTRI_ID, nCurFactionContribute - 1)
		--end
	end
end;


-- ╢╕сзмЙЁиакио╦ЖхннЯ╣дгИ©Жобё╛я╞нймФ╪рйг╥Я╪лпЬвЖ
function get_next_task(nFactionRouteNo)
	local nCurDifficulty = GetTask(TASKVALUE_DIFFICULT_LEVEL_ID)
	local strTalk = {"Kh╦ l╬m, cЦ muХn l╣m th╙m kh╚ng? Hay muХn thЖ nhiжm vТ khЦ h╛n?",
					 "╖ж tЖ ╝Еng Щ!/#get_one_task("..nCurDifficulty..")",
					 "Nhiжm vТ n╣y ╝╥ ho╣n th╣nh, xin kiсm tra l╧i/faction_event_finish",
					 "╖ж tЖ kпm cАi kh╚ng thс ╝╤m nhкn, xin ╝╜Нc hЯy nhiжm vТ!/cancel_faction_event",
					 "╖ж tЖ muХn nhкn nhiжm vТ khЦ h╛n/#get_new_task("..nFactionRouteNo..")",
					 "╖ж tЖ muХn xem ╖iсm cХng hiуn s╜ m╚n/query_faction_contribute",
					 "╖ж tЖ cъn kпm cАi muХn rлn luyжn th╙m./cancel_dialog"}
	
	if (GetTask(TASKVALUE_FACTION_EVENT_ID) == 0) then
		Say(strTalk[1], 4, strTalk[2], strTalk[5], strTalk[6], strTalk[7])
	else
		Say(strTalk[1], 6, strTalk[2], strTalk[3], strTalk[4], strTalk[5], strTalk[6], strTalk[7]);
	end		 
end;

-- ╡Ия╞мФ╪р╣╠г╟╣дй╕це╧╠ов╤х
function query_faction_contribute()
	local nCurFactionContribute = GetTask(TASKVALUE_FACTION_CONTRI_ID)
	-- ╣╠г╟╣х╪╤╣диЫмШочжф
	local nFactionReputationLimit, nBaseDayLimit, nExtraDayLimit = GetFactionRepuLimit()
	Say("╖И cХng hiуn s╜ m╚n l╣ <color=yellow>"..nCurFactionContribute.."<color>, ╝╪ng cйp hiжn t╧i nhкn ╝╜Нc ╝iсm cХng hiуn tХi ╝a l╣ <color=yellow>"..nFactionReputationLimit.."<color>, cХ l╙n! MК giao diжn F3 cЦ thс xem ╝И cХng hiуn s╜ m╚n.", 0)
end;

-- ╪Л╡ИмФ╪рйг╥Яря╬╜мЙЁиакнДаж╢Сйб╪ЧхннЯ
function faction_event_finish()
	local bFinished = FinishFactionEvent()	-- ╪Л╡Ийг╥ЯмЙЁиакй╕це╢Сйб╪Ч
	if (bFinished == 1) then
		--╪схК©у╪Д╦╨жьеп╤о
		if get_free_room(1) ~= 1 then
			return 0;
		end
		local nBefore = GetTask(TASKVALUE_FACTION_CONTRI_ID)
		faction_event_prize()
		local nAfter = GetTask(TASKVALUE_FACTION_CONTRI_ID)
		local nAdded = nAfter - nBefore
		
		Say("L╣m tХt l╬m! CХ l╙n! Ng╜╛i mМi nhкn ╝╜Нc <color=yellow>"..nAdded.."<color> ╝iсm c╚ng hiуn S╜ M╚n", 0)
	else
		Say("Nhiжm vТ ta giao ng╜╛i vиn ch╜a ho╣n th╣nh", 0)
	end
end;

-- еп╤ойг╥Я©ирт╫с╣╫нДаж╢Сйб╪Ч
function check_faction_event_condition()
	--мФ╪р╢с50╪╤©ирт╫с╣╫╦цхннЯ
	local nLevel = GetLevel()
	if (nLevel < 50) then
		return 0
	end
	
	--╪гб╪╫ЯлЛ╣дй╠╪Д
	--		          дЙ	       тб	       ху	       й╠	       ╥ж	       цК
	local nCurrTime = {date("%Y"), date("%m"), date("%d"), date("%H"), date("%M"), date("%S")}
	local nCurDate = tonumber( nCurrTime[1]..nCurrTime[2]..nCurrTime[3])	-- ожтз╣дхуфз
	-- ио╢наЛх║й╕це╢Сйб╪Ч╣дй╠╪Д╤н©╙й╪хуфз
	local nLastGetEventDate = GetTask(TASKVALUE_LAST_GET_EVENT_DATE_ID)
	-- ╠╬й╠╪Д╤ндзря╬╜Ё╒йтаЛх║й╕це╢Сйб╪Ч╣д╢нйЩ
	local nCurGetEventTimes = GetTask(TASKVALUE_GET_EVENT_TIMES_ID)
	
	if ((nCurDate - nLastGetEventDate) > 7) then
		SetTask(TASKVALUE_GET_EVENT_TIMES_ID, 0)
		SetTask(TASKVALUE_LAST_GET_EVENT_DATE_ID, nCurDate)
		if ((nCurGetEventTimes >= 10) and (nCurGetEventTimes < 40)) then	-- ио╦Ж╫в╤нря╬╜вЖак10╢н╩╧ц╩спаЛ╣╫
			return 1
		end
	end
	
	-- ╠╬жэря╬╜╫с╣╫╧Щак
	if (nCurGetEventTimes >= 40) then
		return 0
	end
	
	--╫сйэ╢Сйб╪ЧхннЯ╣д╦ебйн╙╨Ц╤╗ж╣,╦ебйн╙3%,р╩жэж╩дэ╫сйэр╩╢нхннЯ.(╡исцн╠кФ╩З)
	local nRate = random(0, 100)
	if (nRate < 3) then
		SetTask(TASKVALUE_GET_EVENT_TIMES_ID, 40)
		return 1
	else
		SetTask(TASKVALUE_GET_EVENT_TIMES_ID, nCurGetEventTimes + 1)
		return 0
	end
end;

-- й╕цехннЯмЙЁирт╨С╣дфДкШ╫╠юЬ
function other_faction_prize()
-- ц©50╣Ц╧╠ов╤х й╕цеаНеф р╩╦Ж

	-- ╫ЯлЛвЖак╪╦╢нй╕цехннЯак
	local nCurDayTimes = GetTask(TASKVALUE_CUR_DAY_TIMES_ID)  
	-- ╬ЮюКио╢наЛй╕цеаНефтЖ╪сак╤Юиый╕це╧╠ов╤х
	local nLastGetCard = GetTask(TASKVALUE_LAST_CARD_CONTRIBUTE_ID)
	local nCurFactionContribute = GetTask(TASKVALUE_FACTION_CONTRI_ID)
	if nCurFactionContribute < nLastGetCard then	--хГ╧Ш╣╠г╟ж╣п║сзио╢н╩Я╣цаНефй╠╣дж╣
		SetTask(TASKVALUE_LAST_CARD_CONTRIBUTE_ID,nCurFactionContribute);
		nLastGetCard = nCurFactionContribute;
	end;
	local nContributeAdded = nCurFactionContribute - nLastGetCard
	
	if (nContributeAdded >= 20) then
		if GetAntiEnthrallmentStatus() == 0 then
			send_a_faction_card()	-- ╦Ьр╩╦Жй╕цеаНеф
			SetTask(TASKVALUE_LAST_CARD_CONTRIBUTE_ID, (nLastGetCard + 20))
			local nRoute = GetPlayerRoute();
			if nRoute >= 23 then
				Msg2Player("╖iсm cХng hiуn s╜ m╚n cЯa ng╜╛i ╝╜Нc tщch lРy 20 ╝iсm");
			else
				Msg2Player("╖И cХng hiуn s╜ m╚n ╝Я 20 ╝iсm nhкn ╝╜Нc lжnh b╣i s╜ m╚n!")
			end
		end
	end
	
	-- ╣╠лЛ╣зр╩╢нмЙЁий╕цехннЯ
	if (nCurDayTimes == 1 or nCurDayTimes == 6) then
		local nCurLevelOfExpPrize = GetLevel()
		local nExpPrize = 0
		if (nCurFactionContribute <= 3000) then
			nExpPrize = floor(nCurLevelOfExpPrize * nCurLevelOfExpPrize * nCurLevelOfExpPrize * 0.4)
		else
			nExpPrize = nCurLevelOfExpPrize * nCurLevelOfExpPrize * nCurLevelOfExpPrize
		end
		if GetAntiEnthrallmentStatus() == 1 then
			nExpPrize = floor(nExpPrize/2)
		elseif GetAntiEnthrallmentStatus() == 2 then
			nExpPrize = 0
		end		
		ModifyExp(nExpPrize)
		Msg2Player("Ho╣n th╣nh nhiжm vТ S╜ m╚n, nhкn ╝╜Нc "..nExpPrize.." ╝iсm kinh nghiжm!")
		WriteLogEx(VIET_0911_LOG_TITLE,"s╜ m╚n lгn thЬ "..nCurDayTimes)
	end
	
	--09дЙ11тб╩Н╤╞╦Ь╤НмБ╫╠юЬ
	
	if  nCurDayTimes == 10 then
		local nCurLevelOfExpPrize = GetLevel()
		local nExpPrize = 0
		if (nCurFactionContribute <= 3000) then
			nExpPrize = floor(nCurLevelOfExpPrize * nCurLevelOfExpPrize * nCurLevelOfExpPrize * 0.4)			
		else
			nExpPrize = nCurLevelOfExpPrize * nCurLevelOfExpPrize * nCurLevelOfExpPrize
		end
		nExpPrize = nExpPrize + floor(nExpPrize/3)
		if GetAntiEnthrallmentStatus() == 1 then
			nExpPrize = floor(nExpPrize/2)
		elseif GetAntiEnthrallmentStatus() == 2 then
			nExpPrize = 0
		end	
		ModifyExp(nExpPrize)
		Msg2Player("H╚m nay l╣ lгn "..nCurDayTimes.." ho╣n th╣nh nhiжm vТ s╜ m╚n, nhкn ╝╜Нc ╝iсm kinh nghiжm cИng th╙m."..nExpPrize.." ╝iсm!")
		WriteLogEx(VIET_0911_LOG_TITLE,"s╜ m╚n lгn thЬ "..nCurDayTimes)
	else
		local nCurLevelOfExpPrize = GetLevel()
		local nExpPrize = 0
		if (nCurFactionContribute <= 3000) then
			nExpPrize = floor(nCurLevelOfExpPrize * nCurLevelOfExpPrize * nCurLevelOfExpPrize * 0.4)			
		else
			nExpPrize = nCurLevelOfExpPrize * nCurLevelOfExpPrize * nCurLevelOfExpPrize
		end
		nExpPrize = floor(nExpPrize/7)
		if GetAntiEnthrallmentStatus() == 1 then
			nExpPrize = floor(nExpPrize/2)
		elseif GetAntiEnthrallmentStatus() == 2 then
			nExpPrize = 0
		end	
		ModifyExp(nExpPrize)
		Msg2Player("H╚m nay l╣ lгn "..nCurDayTimes.." ho╣n th╣nh nhiжm vТ s╜ m╚n, nhкn ╝╜Нc ╝iсm kinh nghiжm cИng th╙m."..nExpPrize.." ╝iсm!")
		WriteLogEx(VIET_0911_LOG_TITLE,"s╜ m╚n lгn thЬ "..nCurDayTimes)
	end
	-------------й╔╣╝╫з╩Н╤╞╫╠юЬеи╥╒-------------------
--		Xmas_prize_get(2)
	----------------------╫АйЬ-------------------------------
end;

-- й╕це╢Сйб╪ЧмЙЁирт╨С╣д╫╠юЬ
function faction_event_prize()
	-- ╦ЬмФ╪р╬╜яИ╫╠юЬё╛йЩж╣йгмФ╪р╣х╪╤╣дхЩ╢н╥╫
	local nPlayerLevelOfExp = GetLevel()
	local nShouldGiveExp = nPlayerLevelOfExp * nPlayerLevelOfExp * nPlayerLevelOfExp
	ModifyExp(nShouldGiveExp)
	Msg2Player("Vв ╝╥ cХng hiуn cho S╜ M╚n, b╧n nhкn ╝╜Нc"..nShouldGiveExp.." ╝iсm kinh nghiжm!")
	
	-- йг╥Я╩Я╣цакцееиць╪╝
	local bGetSuperMisteryBook = 0

	--╪гб╪╫ЯлЛ╣дй╠╪Д
	--		          дЙ	       тб	       ху	       й╠	       ╥ж	       цК
	local nCurrTime = {date("%Y"), date("%m"), date("%d"), date("%H"), date("%M"), date("%S")}
	local nCurDate = tonumber( nCurrTime[1]..nCurrTime[2]..nCurrTime[3])	-- ожтз╣дхуфз
	local nLastTaskDate = GetTask(TASKVALUE_CUR_DATE_ID)					-- ио╢н╫схннЯ╣дхуфз
	
	if (nLastTaskDate < nCurDate) then
		SetTask(TASKVALUE_CUR_DATE_ID, nCurDate)			-- иХжцпб╣дхуфз
		SetTask(TASKVALUE_FACTION_CONTRI_CUR_DAY_ID, 0)		-- гЕ©у╣╠лЛ╩Я╣ц╣дй╕це╧╠ов╤х
		SetTask(TASKVALUE_CUR_DAY_TIMES_ID, 0)				-- гЕ©у╣╠лЛвЖак╣дй╕цехннЯ╢нйЩ
	end
	
	-- ио╢наЛх║й╕це╢Сйб╪Ч╫╠юЬ╣дй╠╪Д╤н©╙й╪хуфз
	local nLastGetSuperPrizeDate = GetTask(TASKVALUE_LAST_GET_EVENT_PRIZE_DATE_ID)
	-- ╠╬й╠╪Д╤ндзря╬╜Ё╒йтаЛх║й╕це╢Сйб╪Ч╫╠юЬ╣д╢нйЩ
	local nCurGetSuperPrizeTimes = GetTask(TASKVALUE_GET_EVENT_PRIZE_TIMES_ID)
		
	-- цееи45╪╤ць╪╝,╩Я╣ц╦ебй12.5%,а╫╦Жтб(8жэ,╡╩йгнОюМтб)р╩╦Жхк©ирт╩Я╣ц1╠╬.(╡исцн╠кФ╩З)
	if ((nCurDate - nLastGetSuperPrizeDate) >= 56) then	-- 28лЛрт╨Сак
		SetTask(TASKVALUE_GET_EVENT_PRIZE_TIMES_ID, 0)
		SetTask(TASKVALUE_LAST_GET_EVENT_PRIZE_DATE_ID, nCurDate)
	end
	
	local nLottos = random(0, 1000);
	if (nCurGetSuperPrizeTimes == 7) then		-- г╟фъ╢н╤╪ц╩спаЛ╣╫ё╛уБ╢нр╩╤╗╥╒
		really_get_a_super_mistery_book()
		bGetSuperMisteryBook = 1
	elseif (nCurGetSuperPrizeTimes < 7) then	-- кФ╩З12.5%╣д╪╦бй©идэдц╣╫й╕цець╪╝
		if (nLottos < 125) then
			really_get_a_super_mistery_book()
			bGetSuperMisteryBook = 1
		end
	end
	
	-- лЛо╪,воо╪,уЁрб,пчбч,нЕ╧М,╡╧╫П,╡╧й╞╧╡н╙87.5%,ц©╢нж╩©идэ╩Я╣цр╩╠╬ць╪╝.
	-- р╙тзц╩сп╩Я╣ццееиць╪╝╣дгИ©Жобдц╣╫
	if (bGetSuperMisteryBook == 0) then
		if nLottos <= 800 then
			local nBookID = random(1, 7)
			if (nBookID == 1) then
				AddItem(0, 107, 64, 1)		-- лЛо╪
			elseif (nBookID == 2) then
				AddItem(0, 107, 65, 1)		-- воо╪
			elseif (nBookID == 3) then
				AddItem(0, 107, 66, 1)		-- уЁрб
			elseif (nBookID == 4) then
				AddItem(0, 107, 60, 1)		-- пчбч
			elseif (nBookID == 5) then
				AddItem(0, 107, 63, 1)		-- нЕ╧М
			elseif (nBookID == 6) then
				AddItem(0, 107, 61, 1)		-- ╡╧╫П
			else
				AddItem(0, 107, 62, 1)		-- ╡╧й╞
			end
		else
		 local	tMijiName = {
							{"TЬ Linh Chiуn Щ PhФ",0,107,159},
							{"TЬ Linh Thi╙n Щ PhФ",0,107,160},
							{"TЬ Linh TЖ Щ PhФ",0,107,161}
						};	
		 local nRandtb = random(1,3);
		 AddItem(tMijiName[nRandtb][2],tMijiName[nRandtb][3],tMijiName[nRandtb][4],1);		
		end
	end
	
	-- й╕цеиЫмШ╫╠юЬё╛╫╠юЬ50╣Ц
	-- ╣╠г╟╣х╪╤╣диЫмШочжф
	local nFactionReputationLimit, nBaseDayLimit, nExtraDayLimit = GetFactionRepuLimit()
	-- ╣╠г╟╣дй╕цеиЫмШ ╨м ╫ЯлЛря╬╜╩Я╣ц╣дй╕цеиЫмШ
	local nFactionContribute = GetTask(TASKVALUE_FACTION_CONTRI_ID)
	local nCurDayGainReputation = GetTask(TASKVALUE_FACTION_CONTRI_CUR_DAY_ID)
	
	local nShouldAdd = 50
	nCurDayGainReputation = nShouldAdd + nCurDayGainReputation
	if (nCurDayGainReputation > nExtraDayLimit) then
		nShouldAdd = nShouldAdd - (nCurDayGainReputation - nExtraDayLimit)
		nCurDayGainReputation = nExtraDayLimit
	end
	
	SetTask(TASKVALUE_FACTION_CONTRI_ID, (nFactionContribute + nShouldAdd))
	SetTask(TASKVALUE_FACTION_CONTRI_CUR_DAY_ID, nCurDayGainReputation)
	--SetTask(TASKVALUE_CUR_DAY_TIMES_ID, 5)	-- иХжц╫ЯлЛ╡╩сц╪лпЬ╫сй╕цехннЯак
	
	-- ╧Ж╤╞╧╚╦Ф
	local strPlayerName = GetName()
	local strNews = "[Nhiжm vТ s╜ m╚n]: Ng╜Йi ch╛i "..strPlayerName.."  Ho╣n th╣nh nhiжm vТ s╜ m╚n nhкn ╝╜Нc quyсn mкt tчch."
--	AddGlobalNews(strNews)
end;

-- уФуЩ╦Ц╣╫йжакр╩╠╬й╕це45╪╤ць╪╝
function really_get_a_super_mistery_book()
	SetTask(TASKVALUE_GET_EVENT_PRIZE_TIMES_ID, 4)
	
	local nFactionRoute = GetPlayerRoute()	-- ╩Я╣цмФ╪р╣даВеийЩ╬щ
	local nRate = random(0, 1)				-- ддр╩╠╬ць╪╝
	
	if (nFactionRoute == 2) then			-- иыажкв╪р
		AddItem(0, 107, (1 + nRate), 1)		-- ╫П╦у╥Эд╖╬╜ or ╫П╦у╥Эд╖пд╥╗
	elseif (nFactionRoute == 3) then		-- иыажЛЬвз
		AddItem(0, 107, (5 + nRate), 1)		-- нчЁ╬ць╪╝ or нчЁ╬пд╥╗
	elseif (nFactionRoute == 4) then		-- иыажнДвз
		AddItem(0, 107, (3 + nRate), 1)		-- г╠аЗць╪╝ or г╠аЗпд╥╗
		
	elseif (nFactionRoute == 6) then		-- лфце
		AddItem(0, 107, (7 + nRate), 1)		-- лЛбчць╪╝ or лЛбчпд╥╗
		
	elseif (nFactionRoute == 8) then		-- ╤КАр╥П╪р
		AddItem(0, 107, (9 + nRate), 1)		-- хГрБць╪╝ or хГрБпд╥╗
	elseif (nFactionRoute == 9) then		-- ╤КАркв╪р
		AddItem(0, 107, (11 + nRate), 1)	-- ╠л╨ёфв or ╠л╨ёпд╥╗
		
	elseif (nFactionRoute == 11) then		-- ь╓╟О╬╩рб
		AddItem(0, 107, (13 + nRate), 1)	-- ╩ЛЦГць╪╝ or ╩ЛЦГпд╥╗
	elseif (nFactionRoute == 12) then		-- ь╓╟Оншрб
		AddItem(0, 107, (15 + nRate), 1)	-- чЯлЛць╪╝ or чЯлЛпд╥╗
		
	elseif (nFactionRoute == 14) then		-- нД╣╠╣ю╪р
		AddItem(0, 107, (17 + nRate), 1)	-- ╩цс╟ць╪╝ or ╩цс╟пд╥╗
	elseif (nFactionRoute == 15) then		-- нД╣╠кв╪р
		AddItem(0, 107, (19 + nRate), 1)	-- ╬Щвсць╪╝ or ╬Щвспд╥╗
		
	elseif (nFactionRoute == 17) then		-- яНцег╧фО
		AddItem(0, 107, (21 + nRate), 1)	-- уР╬Эць╪╝ or уР╬Эпд╥╗
	elseif (nFactionRoute == 18) then		-- яНце╧╜фО
		AddItem(0, 107, (23 + nRate), 1)	-- ╢╘тфць╪╝ or ╢╘тфпд╥╗
		
	elseif (nFactionRoute == 20) then		-- нЕ╤╬п╟ою
		AddItem(0, 107, (25 + nRate), 1)	-- сдз╓╧Мб╪ or сдз╓пд╥╗
	elseif (nFactionRoute == 21) then		-- нЕ╤╬╧фй╕
		AddItem(0, 107, (27 + nRate), 1)	-- аИ╧фць╪╝ or аИ╧фпд╥╗
	elseif (nFactionRoute == 23) then		-- ю╔бьлЛй╕
		AddItem(0, 107, (180 + nRate), 1)	-- аИ╧фць╪╝ or аИ╧фпд╥╗
	elseif (nFactionRoute == 25) then		-- цВ╫лй╔у╫
		AddItem(0, 107, (182 + nRate), 1)	-- аИ╧фць╪╝ or аИ╧фпд╥╗
	elseif (nFactionRoute == 26) then		-- цВ╫луС╠Ь
		AddItem(0, 107, (184 + nRate), 1)	-- аИ╧фць╪╝ or аИ╧фпд╥╗
	elseif (nFactionRoute == 27) then		-- цВ╫ля╙хк
		AddItem(0, 107, (186 + nRate), 1)	-- аИ╧фць╪╝ or аИ╧фпд╥╗
	elseif (nFactionRoute == 29) then		-- ╢ДялнХои
		AddItem(0, 107, (188 + nRate), 1)	-- аИ╧фць╪╝ or аИ╧фпд╥╗
	elseif (nFactionRoute == 30) then		-- ╢ДялаИе╝
		AddItem(0, 107, (190 + nRate), 1)	-- аИ╧фць╪╝ or аИ╧фпд╥╗
	end
	
	Msg2Player("B╧n nhкn ╝╜Нc 1 quyсn mкt tчch!")
end;

--╦ЬсХй╕це╦ъ╪╤ць╪╝ё╛пбцееир╙╪с
function get_advanced_faction_book()
	local tGaojiMiji = {
				[0] = {{"Kim Cang B╦t Nh╥ Kinh",0,107,166},{"V╚ Trгn BЕ ╖р Kinh",0,107,168},{"Tiрm Long Tчch Diжt Kinh",0,107,167},{"Thi╙n La Li╙n Ch╘u LТc",0,107,169},{"Nh╜ Щ Kim ╖ьnh Mкt Tчch",0,107,170},{"Bщch H╤i Tuyжt ╒m PhФ",0,107,171},{"HГn ╖Иn Trйn Nh╧c Mкt Tчch",0,107,172},{"QuЭ Thi╙n Du Long Mкt Tчch",0,107,173},{"Huyтn ╤nh M╙ Tung Mкt Tчch",0,107,174},{"Qu╘n TЖ Tiжt Phong Mкt Tчch",0,107,175},{"Trйn Qu╘n Phi Long Th╜╛ng PhФ",0,107,176},{"Xuy╙n V╘n L╧c HЕng Mкt Tчch",0,107,177},{"U Minh Phong Ma LТc",0,107,178},{"Linh CФ Huyтn T╣ LТc",0,107,179}},
				[1] = {{"Kim Cang B╦t Nh╥ Kinh",0,107,166},{"V╚ Trгn BЕ ╖р Kinh",0,107,168},{"Tiрm Long Tчch Diжt Kinh",0,107,167}},
				[2] = {{"Kim Cang B╦t Nh╥ Kinh",0,107,166}},
				[3] = {{"V╚ Trгn BЕ ╖р Kinh",0,107,168}},
				[4] = {{"Tiрm Long Tчch Diжt Kinh",0,107,167}},
				[5] = {{"Thi╙n La Li╙n Ch╘u LТc",0,107,169}},
				[6] = {{"Thi╙n La Li╙n Ch╘u LТc",0,107,169}},
				[7] = {{"Nh╜ Щ Kim ╖ьnh Mкt Tчch",0,107,170},{"Bщch H╤i Tuyжt ╒m PhФ",0,107,171}},
				[8] = {{"Nh╜ Щ Kim ╖ьnh Mкt Tчch",0,107,170}},
				[9] = {{"Bщch H╤i Tuyжt ╒m PhФ",0,107,171}},
				[10] = {{"HГn ╖Иn Trйn Nh╧c Mкt Tчch",0,107,172},{"QuЭ Thi╙n Du Long Mкt Tчch",0,107,173}},
				[11] = {{"HГn ╖Иn Trйn Nh╧c Mкt Tчch",0,107,172}},
				[12] = {{"QuЭ Thi╙n Du Long Mкt Tчch",0,107,173}},
				[13] = {{"Huyтn ╤nh M╙ Tung Mкt Tчch",0,107,174},{"Qu╘n TЖ Tiжt Phong Mкt Tчch",0,107,175}},
				[14] = {{"Huyтn ╤nh M╙ Tung Mкt Tчch",0,107,174}},
				[15] = {{"Qu╘n TЖ Tiжt Phong Mкt Tчch",0,107,175}},
				[16] = {{"Trйn Qu╘n Phi Long Th╜╛ng PhФ",0,107,176},{"Xuy╙n V╘n L╧c HЕng Mкt Tчch",0,107,177}},
				[17] = {{"Trйn Qu╘n Phi Long Th╜╛ng PhФ",0,107,176}},
				[18] = {{"Xuy╙n V╘n L╧c HЕng Mкt Tчch",0,107,177}},
				[19] = {{"U Minh Phong Ma LТc",0,107,178},{"Linh CФ Huyтn T╣ LТc",0,107,179}},
				[20] = {{"U Minh Phong Ma LТc",0,107,178}},
				[21] = {{"Linh CФ Huyтn T╣ LТc",0,107,179}},
				[22] = {{"Thiсm L╚i Mкt Tчch",0,107,198}},
				[23] = {{"Thiсm L╚i Mкt Tчch",0,107,198}},
				[24] = {{"Tr╤m Nhкt Mкt Tчch",0,107,199},{"H╣nh Trкn Mкt Tчch",0,107,200},{"Phong Huyуt Mкt Tчch",0,107,201}},
				[25] = {{"Tr╤m Nhкt Mкt Tчch",0,107,199}},
				[26] = {{"H╣nh Trкn Mкt Tчch",0,107,200}},
				[27] = {{"Phong Huyуt Mкt Tчch",0,107,201}},
				[28] = {{"U MИng PhФ",0,107,202},{"B╦ch Hoa PhФ",0,107,203}},
				[29] = {{"U MИng PhФ",0,107,202}},
				[30] = {{"B╦ch Hoa PhФ",0,107,203}},
			};
	local nFactionRoute = GetPlayerRoute()	-- ╩Я╣цмФ╪р╣даВеийЩ╬щ
	local nRandom = random(1,getn(tGaojiMiji[nFactionRoute]));
	local nAdd_flag = AddItem(tGaojiMiji[nFactionRoute][nRandom][2],tGaojiMiji[nFactionRoute][nRandom][3],tGaojiMiji[nFactionRoute][nRandom][4],1);
	if nAdd_flag == 1 then
		Msg2Player("B╧n nhкn ╝╜Нc 1 quyсn"..tGaojiMiji[nFactionRoute][nRandom][2]);
		WriteLog("[SЫ kiжn s╜ m╚n]: "..GetName().."Ho╣n th╣nh sЫ kiжn s╜ m╚n ╝╜Нc 1 "..tGaojiMiji[nFactionRoute][nRandom][1]);
	else
		WriteLog("[SЫ kiжn s╜ m╚n]: "..GetName().."Ho╣n th╣nh sЫ kiжn s╜ m╚n ╝╜Нc 1 "..tGaojiMiji[nFactionRoute][nRandom][1].."Thйt b╧i: "..nAdd_flag);
	end	
end


-- ╦Ьр╩╦Жй╕цеаНефё╛╟╢цееи╦Ь╣д
function send_a_faction_card()
	if CheckXacThuc() == 0 then
		Msg2Player("T╣i kho╤n ch╜a x╦c thЫc kh╚ng ╝╜Нc nhкn s╜ m╚n lжnh b╣i.")
		return
	end
	
	local nFaction = GetPlayerFaction()		-- ╣ц╣╫мФ╪рйгдд╦Жцееи╣д

	if (nFaction == 1) then			-- иыаж
		AddItem(2, 0, 205, 1)		-- иыажй╕цеаНеф
	elseif (nFaction == 2) then		-- нД╣╠
		AddItem(2, 0, 206, 1)		-- нД╣╠й╕цеаНеф
	elseif (nFaction == 3) then		-- ╤КАр
		AddItem(2, 0, 207, 1)		-- ╤КАрй╕цеаНеф
	elseif (nFaction == 4) then		-- ь╓╟О
		AddItem(2, 0, 208, 1)		-- ь╓╟Ой╕цеаНеф
	elseif (nFaction == 5) then		-- лфце
		AddItem(2, 0, 209, 1)		-- лфцей╕цеаНеф
	elseif (nFaction == 6) then		-- яНце
		AddItem(2, 0, 350, 1)		-- яНцей╕цеаНеф
	elseif (nFaction == 7) then		-- нЕ╤╬
		AddItem(2, 0, 390, 1)		-- нЕ╤╬й╕цеаНеф
	elseif (nFaction == 8) then		-- ю╔бь
--		AddItem(2,0,787, 1)		-- ю╔бьй╕цеаНеф
	elseif (nFaction == 9) then		-- цВ╫л
--		AddItem(2,0,788, 1)		-- цВ╫лй╕цеаНеф
	elseif (nFaction == 10) then		-- ╢Дял
--		AddItem(2,0,789, 1)		-- ╢Дялй╕цеаНеф
	end
end;

function cancel_faction_event()
	Say("╖с cЦ mкt tчch m╚n ph╦i cгn ho╣n th╣nh nhiжm vТ s╜ m╚n. Ng╜╛i cЦ muХn tiуp tТc l╣m kh╚ng?",
		2,
		"Ta muХn hЯy nhiжm vТ n╣y/confirm_cancel_faction_event",
		"╖с ta nghэ l╧i!/cancel_dialog")
end;

function confirm_cancel_faction_event()
	SetTask(TASKVALUE_FACTION_EVENT_ID, 0)
	Say("Ta ╝╥ hЯy nhiжm vТ s╜ m╚n cЯa ng╜╛i, nуu muХn l╣m l╧i thв ph╤i xem c╛ duy╙n nВa!", 0)
end;

function get_free_room(goods_num)
	if GetFreeItemRoom() < goods_num then
		Talk (1,"","<color=red>kho╤ng trХng<color> trong h╣nh trang kh╚ng ╝Я!")
		return 0
	else 
		return 1
	end
end
function add_0906and07_aword()
	if EventOpen0906() == 0 then
		return
	end
	if tonumber(date("%y%m%d%H")) >= 09061900 and tonumber(date("%y%m%d%H")) < 09071924 then
		local nCount = tb_shimen_aword[floor(GetLevel() / 10)][2];
		if GetTask(TASK_GET_MIBEN_DATE) < tonumber(date("%y%m%d")) then
			SetTask(TASK_GET_MIBEN_COUNT_TODAY, 0);
		end
		if GetTask(TASK_GET_MIBEN_COUNT_TODAY) < CONST_GET_MIBEN_MAX_COUNT then
			gf_SetLogCaption("Truy tвm tr╜Йng sinh phФ");
			local nRetCode = gf_AddItemEx({2, 1, 30088, nCount}, "Bщ PhФ CР N╦t");
			WriteLogEx("Hoat dong thang 6","S╜ m╚n"..floor(GetLevel() / 10).."x",nCount,"Bщ PhФ CР N╦t");
			if nRetCode == 1 then
				SetTask(TASK_GET_MIBEN_DATE, tonumber(date("%y%m%d")));
				SetTask(TASK_GET_MIBEN_COUNT_TODAY, GetTask(TASK_GET_MIBEN_COUNT_TODAY) + 1);
			end
			gf_SetLogCaption("");
		end
	end
end

function add_0908_aword()
	local nDate = tonumber(date("%y%m%d"));
	if nDate >= 090807 and nDate < 090907 then
		local nCount = tVIET_SHIMEN_PUTAO[floor(GetLevel() / 10)];
		if GetTask(VIET_0908_TASK_SHIMEN_GET_PUTAO_DATE) < nDate then
			SetTask(VIET_0908_TASK_SHIMEN_GET_PUTAO_COUNT, 0);
		end
		if GetTask(VIET_0908_TASK_SHIMEN_GET_PUTAO_COUNT) < VIET_0908_CONST_SHIMEN_GET_MAX then
			gf_SetLogCaption(str_VIET_0908_LOG_TITLE);
			local nRetCode = gf_AddItemEx({2, 1, 30097, nCount}, "TСi Tr╦i C╘y");
			if nRetCode == 1 then
				SetTask(VIET_0908_TASK_SHIMEN_GET_PUTAO_DATE, tonumber(date("%y%m%d")));
				SetTask(VIET_0908_TASK_SHIMEN_GET_PUTAO_COUNT, GetTask(VIET_0908_TASK_SHIMEN_GET_PUTAO_COUNT) + 1);
				levelGrade = floor(GetLevel() / 10);
				if levelGrade <= 2 then
					WriteLogEx("Hoat dong thang 8", "Nhan tui trai cay", nCount, "Su mon 1x2x");
				else
					WriteLogEx("Hoat dong thang 8", "Nhan tui trai cay", nCount, "Su mon "..levelGrade.."x");
				end
			end
			gf_SetLogCaption("");
		end
	end
end

function add_0909_aword()
	local nDate = tonumber(date("%y%m%d"));
	if nDate >= 090918 and nDate < 091026 then
		local nCount = tVIET_SHIMEN_BAIMIANBAO[floor(GetLevel() / 10)];
		if GetTask(VIET_0909_TASK_SHIMENG_DATE) < nDate then
			SetTask(VIET_0909_TASK_SHIMENG_NUM, 0);
		end
		if GetTask(VIET_0909_TASK_SHIMENG_NUM) < 10 then
			gf_SetLogCaption(VIET_0909_LOG_TITLE);
			local nRetCode = gf_AddItemEx({2, 1, 30106, nCount}, "BИt Mв");
			if nRetCode == 1 then
				local nLevel = floor(GetLevel() / 10)
				WriteLogEx("Hoat dong trung thu","S╜ M╚n cйp "..nLevel,nCount,"BИt Mв")
				SetTask(VIET_0909_TASK_SHIMENG_DATE, tonumber(date("%y%m%d")));
				SetTask(VIET_0909_TASK_SHIMENG_NUM, GetTask(VIET_0909_TASK_SHIMENG_NUM) + 1);
			end
			gf_SetLogCaption("");
		end
	end
end

function add_0911_aword()
	local nDate = tonumber(date("%y%m%d"));
	if nDate >= 091106 and nDate <= 091206 then
		local nCount = tVIET_0911_SHIMEN_JUHUA[floor(GetLevel() / 10)];
		if GetTask(VIET_0911_TASK_SHIMENG_DATE) < nDate then
			SetTask(VIET_0911_TASK_SHIMENG_NUM, 0);
		end
		if GetTask(VIET_0911_TASK_SHIMENG_NUM) < 10 then
			gf_SetLogCaption(VIET_0911_LOG_TITLE);
			local nRetCode = gf_AddItemEx({2, 1, 30118, nCount}, "Hoa CСc");
			if nRetCode == 1 then
				SetTask(VIET_0911_TASK_SHIMENG_DATE, tonumber(date("%y%m%d")));
				SetTask(VIET_0911_TASK_SHIMENG_NUM, GetTask(VIET_0911_TASK_SHIMENG_NUM) + 1);
				WriteLogEx(VIET_0911_LOG_TITLE,"S╜ m╚n "..floor(GetLevel() / 10).."x",nCount,"Hoa CСc")
			end
			gf_SetLogCaption("");
		end
	end
end

function add_0912_aword()
    local szFullLog = VIET_0912_STR_EVENT_LOG_TITLE.."- L╣m nhiжm vТ s╜ m╚n ╝╜Нc kяo gi╦ng sinh"
    gf_EventFactionAward({2, 1, 30138}, "C╘y Kяo Gi╦ng Sinh", VIET_0912_SHIMEN_SHENGDANTANGGUO, VIET_0912_SHIMEN_AWARD_MAX_COUNT, VIET_0912_TASK_SHIMENG_DATE, VIET_0912_TASK_SHIMENG_NUM, szFullLog, 091218, 100117);
end
